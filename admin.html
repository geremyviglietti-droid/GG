<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="AdhÃ©sion" />
  <link rel="apple-touch-icon" href="icons/icon-192.png" />
  <meta name="theme-color" content="#1e1b4b" />
  <title>Admin â€” Statistiques globales</title>
  <link rel="stylesheet" href="libs/fonts.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0a091a; font-family: 'DM Sans', sans-serif; min-height: 100vh; color: white; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse { 0%,100% { opacity:.6; } 50% { opacity:1; } }
    @keyframes shimmer { 0% { background-position: -400px 0; } 100% { background-position: 400px 0; } }
    .fade-in { animation: fadeIn 0.45s ease forwards; }
    .loading-dot { animation: pulse 1.4s infinite; }
    .card {
      background: rgba(255,255,255,0.04);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 20px;
      padding: 24px;
      transition: border-color .2s, background .2s;
    }
    .card:hover { background: rgba(255,255,255,0.06); border-color: rgba(124,58,237,0.35); }
    .stat-value { font-family: 'Cormorant Garamond', serif; font-size: 40px; font-weight: 700; line-height: 1; }
    .stat-label { font-size: 11px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-top: 6px; }
    .badge { display: inline-flex; align-items: center; gap: 5px; padding: 3px 10px; border-radius: 20px; font-size: 11px; font-weight: 700; }
    .badge-green { background: rgba(34,197,94,.15); color: #4ade80; border: 1px solid rgba(34,197,94,.25); }
    .badge-purple { background: rgba(124,58,237,.2); color: #a78bfa; border: 1px solid rgba(124,58,237,.3); }
    .badge-blue { background: rgba(59,130,246,.15); color: #60a5fa; border: 1px solid rgba(59,130,246,.25); }
    .badge-orange { background: rgba(251,146,60,.15); color: #fb923c; border: 1px solid rgba(251,146,60,.25); }
    .nav-link { color: rgba(255,255,255,0.55); text-decoration: none; font-size: 14px; font-weight: 500; padding: 8px 16px; border-radius: 10px; transition: background .2s, color .2s; border: none; cursor: pointer; font-family: 'DM Sans', sans-serif; background: transparent; }
    .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.08); color: white; }
    .th { padding: 12px 14px; text-align: left; color: rgba(255,255,255,0.4); font-weight: 700; letter-spacing: .06em; font-size: 10px; text-transform: uppercase; cursor: pointer; white-space: nowrap; user-select: none; }
    .th:hover { color: rgba(255,255,255,0.7); }
    .tr-row { border-bottom: 1px solid rgba(255,255,255,0.05); transition: background .15s; }
    .tr-row:hover { background: rgba(124,58,237,0.08) !important; }
    .skeleton { background: linear-gradient(90deg, rgba(255,255,255,0.04) 25%, rgba(255,255,255,0.08) 50%, rgba(255,255,255,0.04) 75%); background-size: 400px 100%; animation: shimmer 1.5s infinite; border-radius: 8px; height: 16px; }
  </style>
</head>
<body>

<div id="root"></div>

<script src="libs/react.min.js"></script>
<script src="libs/react-dom.min.js"></script>
<script src="libs/babel.min.js"></script>

<script type="text/babel">
  const { useState, useEffect, useCallback, useMemo } = React;

  // â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const SUPABASE_URL = "https://couruebftrtlqwffdavz.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_XKVDlf9Bem837GPgx8RNqw_lgs9Q6zc";
  const ADMIN_PASSWORD = "admin1234"; // Changez ce mot de passe !

  const font = "'DM Sans', sans-serif";
  const serif = "'Cormorant Garamond', serif";

  // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function sbFetch(table, extra = "") {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*${extra}&order=created_at.desc`, {
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function sbDelete(table, id) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
      method: "DELETE",
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
    });
    if (!res.ok) throw new Error(await res.text());
  }

  function calcAge(d) {
    if (!d) return null;
    const parts = String(d).split(/[-\/]/);
    if (parts.length < 3) return null;
    const bYear = parseInt(parts[0]), bMonth = parseInt(parts[1]) - 1, bDay = parseInt(parts[2]);
    if (isNaN(bYear) || isNaN(bMonth) || isNaN(bDay)) return null;
    const n = new Date();
    let a = n.getFullYear() - bYear;
    if (n.getMonth() < bMonth || (n.getMonth() === bMonth && n.getDate() < bDay)) a--;
    return (a >= 0 && a < 120) ? a : null;
  }

  function fmtDate(s) {
    if (!s) return "â€”";
    return new Date(s).toLocaleDateString("fr-FR", { day: "2-digit", month: "short", year: "numeric" });
  }

  function exportCSV(rows, filename = "export") {
    const headers = ["ID","Date","Nom","PrÃ©nom","Naissance","Adresse","CP","Ville","TÃ©lÃ©phone","Email","RGPD","Marketing","Don (â‚¬)","RÃ©duction (â‚¬)","CoÃ»t net (â‚¬)","IBAN","BIC"];
    const lines = rows.map(r =>
      [r.id, fmtDate(r.created_at), r.nom, r.prenom, r.date_naissance, r.adresse, r.code_postal, r.ville, r.telephone, r.email,
       r.consent_rgpd ? "Oui" : "Non", r.consent_marketing ? "Oui" : "Non",
       r.montant_don ?? "", r.reduction_fiscale ?? "", r.cout_net ?? "", r.iban, r.bic
      ].map(v => `"${String(v ?? "").replace(/"/g, '""')}"`).join(",")
    );
    const blob = new Blob(["\uFEFF" + [headers.join(","), ...lines].join("\n")], { type: "text/csv;charset=utf-8;" });
    const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download = `${filename}_${new Date().toISOString().slice(0,10)}.csv`; a.click();
  }

  // â”€â”€ LOGIN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function Login({ onLogin }) {
    const [pwd, setPwd] = useState("");
    const [err, setErr] = useState(false);
    const [shake, setShake] = useState(false);

    function submit() {
      if (pwd === ADMIN_PASSWORD) { onLogin(); }
      else { setErr(true); setShake(true); setTimeout(() => setShake(false), 500); }
    }

    return (
      <div style={{ minHeight: "100vh", display: "flex", alignItems: "center", justifyContent: "center", background: "radial-gradient(ellipse at 60% 40%, rgba(76,29,149,.2), transparent 60%), #0a091a", padding: 24 }}>
        <div className="fade-in" style={{ background: "rgba(255,255,255,0.04)", border: "1px solid rgba(255,255,255,0.1)", borderRadius: 28, padding: "52px 44px", maxWidth: 420, width: "100%", textAlign: "center" }}>
          <div style={{ width: 64, height: 64, borderRadius: 20, background: "linear-gradient(135deg,#4c1d95,#6d28d9)", display: "flex", alignItems: "center", justifyContent: "center", margin: "0 auto 28px", fontSize: 28 }}>âš™ï¸</div>
          <h1 style={{ fontFamily: serif, fontSize: 32, color: "white", marginBottom: 8, fontWeight: 600 }}>Espace Admin</h1>
          <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14, marginBottom: 36 }}>AccÃ¨s rÃ©servÃ© aux administrateurs</p>
          <div style={{ textAlign: "left", marginBottom: 24 }}>
            <label style={{ fontSize: 11, fontWeight: 700, color: "rgba(255,255,255,0.4)", display: "block", marginBottom: 8, letterSpacing: ".08em", textTransform: "uppercase" }}>Mot de passe admin</label>
            <input
              type="password"
              value={pwd}
              onChange={e => { setPwd(e.target.value); setErr(false); }}
              onKeyDown={e => e.key === "Enter" && submit()}
              placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
              style={{
                width: "100%", padding: "14px 18px", borderRadius: 14, fontSize: 16, fontFamily: font,
                border: `2px solid ${err ? "#f87171" : "rgba(255,255,255,0.1)"}`,
                background: err ? "rgba(239,68,68,.08)" : "rgba(255,255,255,0.05)",
                color: "white", outline: "none", transition: "border .2s",
                animation: shake ? "shake .3s" : "none"
              }}
            />
            {err && <p style={{ color: "#f87171", fontSize: 12, marginTop: 6 }}>Mot de passe incorrect</p>}
          </div>
          <button onClick={submit} style={{ width: "100%", padding: 16, borderRadius: 14, border: "none", background: "linear-gradient(135deg,#4c1d95,#6d28d9)", color: "white", fontSize: 15, fontWeight: 700, cursor: "pointer", fontFamily: font, boxShadow: "0 8px 28px rgba(76,29,149,.45)" }}>
            AccÃ©der au tableau de bord â†’
          </button>
          <p style={{ marginTop: 24, fontSize: 13, color: "rgba(255,255,255,0.3)" }}>
            <a href="dashboard.html" style={{ color: "#a78bfa", textDecoration: "none" }}>â† Retour Ã  l'espace collecteur</a>
          </p>
        </div>
        <style>{`@keyframes shake { 0%,100%{transform:translateX(0)} 25%{transform:translateX(-6px)} 75%{transform:translateX(6px)} }`}</style>
      </div>
    );
  }

  // â”€â”€ MINI CHART BAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function MiniBar({ data, color = "#a78bfa", label }) {
    const max = Math.max(...data.map(d => d.value), 1);
    return (
      <div>
        {label && <p style={{ fontSize: 10, fontWeight: 700, color: "rgba(255,255,255,0.3)", letterSpacing: ".08em", textTransform: "uppercase", marginBottom: 10 }}>{label}</p>}
        <div style={{ display: "flex", alignItems: "flex-end", gap: 4, height: 52 }}>
          {data.map((d, i) => (
            <div key={i} style={{ flex: 1, display: "flex", flexDirection: "column", alignItems: "center", gap: 3 }}>
              <div style={{ width: "100%", background: color, borderRadius: "4px 4px 0 0", height: `${Math.max((d.value / max) * 48, d.value > 0 ? 4 : 0)}px`, opacity: 0.7 + (i / data.length) * 0.3, transition: "height .4s" }} />
              <span style={{ fontSize: 9, color: "rgba(255,255,255,0.3)", whiteSpace: "nowrap" }}>{d.label}</span>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // â”€â”€ PIE CHART SVG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function PieChart({ data, size = 180 }) {
    const total = data.reduce((s, d) => s + d.value, 0);
    if (total === 0) return <p style={{color:"rgba(255,255,255,0.3)",fontSize:13,textAlign:"center",padding:"20px 0"}}>Aucune donnÃ©e</p>;
    const cx = size / 2, cy = size / 2, r = size / 2 - 6;
    let cumAngle = -Math.PI / 2;
    const slices = data.map(d => {
      const angle = (d.value / total) * 2 * Math.PI;
      const x1 = cx + r * Math.cos(cumAngle);
      const y1 = cy + r * Math.sin(cumAngle);
      cumAngle += angle;
      const x2 = cx + r * Math.cos(cumAngle);
      const y2 = cy + r * Math.sin(cumAngle);
      const large = angle > Math.PI ? 1 : 0;
      return { ...d, x1, y1, x2, y2, large, angle, midAngle: cumAngle - angle / 2 };
    }).filter(s => s.value > 0);
    const [hovered, setHovered] = React.useState(null);
    return (
      <div style={{display:"flex",alignItems:"center",gap:20,flexWrap:"wrap"}}>
        <svg width={size} height={size} style={{flexShrink:0}}>
          {slices.map((s, i) => (
            <path key={i}
              d={`M ${cx} ${cy} L ${s.x1} ${s.y1} A ${r} ${r} 0 ${s.large} 1 ${s.x2} ${s.y2} Z`}
              fill={s.color}
              opacity={hovered === i ? 1 : 0.82}
              stroke="#0a091a" strokeWidth={2}
              style={{cursor:"pointer",transition:"opacity .15s"}}
              onMouseEnter={() => setHovered(i)}
              onMouseLeave={() => setHovered(null)}
            />
          ))}
          {hovered !== null && slices[hovered] && (
            <text x={cx} y={cy-8} textAnchor="middle" fill="white" fontSize={13} fontWeight={700}>{slices[hovered].value}</text>
          )}
          {hovered !== null && slices[hovered] && (
            <text x={cx} y={cy+10} textAnchor="middle" fill="rgba(255,255,255,0.5)" fontSize={10}>{((slices[hovered].value/total)*100).toFixed(0)}%</text>
          )}
          {hovered === null && <text x={cx} y={cy+5} textAnchor="middle" fill="rgba(255,255,255,0.35)" fontSize={11}>{total} total</text>}
        </svg>
        <div style={{flex:1,display:"flex",flexDirection:"column",gap:7}}>
          {data.map((d, i) => (
            <div key={i} style={{display:"flex",alignItems:"center",gap:8,opacity:d.value===0?0.35:1}}>
              <div style={{width:10,height:10,borderRadius:"50%",background:d.color,flexShrink:0}}/>
              <span style={{fontSize:12,color:"rgba(255,255,255,0.6)",flex:1,whiteSpace:"nowrap"}}>{d.label}</span>
              <span style={{fontSize:12,fontWeight:700,color:"white"}}>{d.value}</span>
              <span style={{fontSize:11,color:"rgba(255,255,255,0.3)",minWidth:32,textAlign:"right"}}>{total>0?((d.value/total)*100).toFixed(0):0}%</span>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // â”€â”€ KPI CARD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function KpiCard({ icon, label, value, unit = "", color = "#a78bfa", sub }) {
    return (
      <div className="card fade-in" style={{ textAlign: "center" }}>
        <div style={{ fontSize: 26, marginBottom: 10 }}>{icon}</div>
        <div className="stat-value" style={{ color }}>
          {value}<span style={{ fontSize: 18, fontWeight: 300, color: "rgba(255,255,255,0.35)", marginLeft: 4 }}>{unit}</span>
        </div>
        <div className="stat-label">{label}</div>
        {sub && <div style={{ fontSize: 11, color: "rgba(255,255,255,0.3)", marginTop: 6 }}>{sub}</div>}
      </div>
    );
  }

  // â”€â”€ DETAIL MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function DetailModal({ row, onClose, onDelete }) {
    if (!row) return null;
    return (
      <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.75)", zIndex: 3000, display: "flex", alignItems: "center", justifyContent: "center", padding: 24 }} onClick={onClose}>
        <div onClick={e => e.stopPropagation()} style={{ background: "#1a1730", borderRadius: 24, padding: 36, maxWidth: 680, width: "100%", maxHeight: "90vh", overflowY: "auto", border: "1px solid rgba(255,255,255,0.1)" }}>
          <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-start", marginBottom: 28 }}>
            <div>
              <h2 style={{ fontFamily: serif, fontSize: 28, color: "white", margin: 0 }}>{row.prenom} {row.nom}</h2>
              <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 13, marginTop: 4 }}>EnregistrÃ© le {fmtDate(row.created_at)}</p>
            </div>
            <button onClick={onClose} style={{ background: "rgba(255,255,255,0.08)", border: "none", color: "white", width: 36, height: 36, borderRadius: "50%", cursor: "pointer", fontSize: 18 }}>âœ•</button>
          </div>
          {[
            { title: "CoordonnÃ©es civiles", fields: [["Nom complet", `${row.prenom} ${row.nom}`], ["Date de naissance", row.date_naissance ? fmtDate(row.date_naissance) : "â€”"], ["Adresse", `${row.adresse ?? "â€”"}, ${row.code_postal ?? ""} ${row.ville ?? ""}`], ["TÃ©lÃ©phone", row.telephone], ["Email", row.email]] },
            { title: "Don mensuel", fields: [["Montant dÃ©clarÃ©", row.montant_don ? `${parseFloat(row.montant_don).toFixed(2)} â‚¬` : "Non renseignÃ©"]] },
            { title: "CoordonnÃ©es bancaires", fields: [["IBAN", row.iban || "â€”"], ["BIC / SWIFT", row.bic || "â€”"]] },
          ].map(section => (
            <div key={section.title} style={{ marginBottom: 14, background: "rgba(255,255,255,0.04)", borderRadius: 14, padding: "16px 20px" }}>
              <h3 style={{ fontSize: 10, fontWeight: 700, color: "rgba(255,255,255,0.35)", letterSpacing: ".08em", textTransform: "uppercase", marginBottom: 12 }}>{section.title}</h3>
              {section.fields.map(([lbl, val]) => (
                <div key={lbl} style={{ display: "flex", justifyContent: "space-between", padding: "7px 0", borderBottom: "1px solid rgba(255,255,255,0.06)" }}>
                  <span style={{ fontSize: 13, color: "rgba(255,255,255,0.45)" }}>{lbl}</span>
                  <span style={{ fontSize: 13, color: "white", fontWeight: 500, maxWidth: "65%", textAlign: "right", wordBreak: "break-all" }}>{val || "â€”"}</span>
                </div>
              ))}
            </div>
          ))}
          {row.signature && (
            <div style={{ marginBottom: 14, background: "rgba(255,255,255,0.04)", borderRadius: 14, padding: "16px 20px" }}>
              <h3 style={{ fontSize: 10, fontWeight: 700, color: "rgba(255,255,255,0.35)", letterSpacing: ".08em", textTransform: "uppercase", marginBottom: 12 }}>Signature</h3>
              <img src={row.signature} alt="signature" style={{ width: "100%", borderRadius: 8, background: "white", padding: 4 }} />
            </div>
          )}
          <div style={{ display: "flex", gap: 12, marginTop: 8 }}>
            <button onClick={onClose} style={{ flex: 1, padding: "12px", borderRadius: 12, border: "1px solid rgba(255,255,255,0.12)", background: "transparent", color: "white", cursor: "pointer", fontFamily: font, fontWeight: 600, fontSize: 14 }}>Fermer</button>
            <button onClick={() => onDelete(row)} style={{ padding: "12px 24px", borderRadius: 12, border: "none", background: "#7f1d1d", color: "#fca5a5", cursor: "pointer", fontFamily: font, fontWeight: 700, fontSize: 14 }}>Supprimer</button>
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€ CONFIRM MODAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function ConfirmModal({ row, onConfirm, onCancel }) {
    if (!row) return null;
    return (
      <div style={{ position: "fixed", inset: 0, background: "rgba(0,0,0,.8)", zIndex: 4000, display: "flex", alignItems: "center", justifyContent: "center", padding: 24 }}>
        <div className="fade-in" style={{ background: "#1a1730", borderRadius: 20, padding: 36, maxWidth: 400, width: "100%", textAlign: "center", border: "1px solid rgba(239,68,68,.3)" }}>
          <div style={{ fontSize: 40, marginBottom: 16 }}>âš ï¸</div>
          <h3 style={{ fontFamily: serif, fontSize: 24, color: "white", marginBottom: 10 }}>Supprimer cet adhÃ©rent ?</h3>
          <p style={{ color: "rgba(255,255,255,0.5)", fontSize: 14, lineHeight: 1.6, marginBottom: 28 }}>Vous allez supprimer dÃ©finitivement le dossier de <strong style={{ color: "white" }}>{row.prenom} {row.nom}</strong>. Cette action est irrÃ©versible.</p>
          <div style={{ display: "flex", gap: 12 }}>
            <button onClick={onCancel} style={{ flex: 1, padding: 14, borderRadius: 12, border: "1px solid rgba(255,255,255,0.12)", background: "transparent", color: "white", cursor: "pointer", fontFamily: font, fontWeight: 600 }}>Annuler</button>
            <button onClick={() => onConfirm(row.id)} style={{ flex: 1, padding: 14, borderRadius: 12, border: "none", background: "#ef4444", color: "white", cursor: "pointer", fontFamily: font, fontWeight: 700 }}>Supprimer</button>
          </div>
        </div>
      </div>
    );
  }

  // â”€â”€ MAIN APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function App() {
    const [auth, setAuth] = useState(false);
    const [page, setPage] = useState("overview"); // overview | adherents | collecteurs
    const [adherents, setAdherents] = useState(null);
    const [collecteurs, setCollecteurs] = useState(null);
    const [loading, setLoading] = useState(false);
    const [error, setError] = useState(null);
    const [selected, setSelected] = useState(null);
    const [delConfirm, setDelConfirm] = useState(null);
    const [search, setSearch] = useState("");
    const [sortField, setSortField] = useState("created_at");
    const [sortDir, setSortDir] = useState("desc");
    const [filterDon, setFilterDon] = useState("");
    const [lastRefresh, setLastRefresh] = useState(null);

    const load = useCallback(async () => {
      setLoading(true); setError(null);
      try {
        const [adh, col] = await Promise.all([
          sbFetch("adherents"),
          sbFetch("collecteurs").catch(() => []),
        ]);
        setAdherents(adh);
        setCollecteurs(col);
        setLastRefresh(new Date());
      } catch (e) { setError(e.message); }
      setLoading(false);
    }, []);

    useEffect(() => { if (auth) load(); }, [auth, load]);

    // â”€â”€ Derived stats (adhÃ©rents complets uniquement) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const adherentsComplets = React.useMemo(() => adherents ? adherents.filter(r => !r.incomplet) : [], [adherents]);
    const adherentsIncomplets = React.useMemo(() => adherents ? adherents.filter(r => r.incomplet === true) : [], [adherents]);

    const stats = useMemo(() => {
      const adh = adherentsComplets;
      if (!adh.length && !adherents) return null;
      const total = adh.length;
      const dons = adh.map(r => parseFloat(r.montant_don)).filter(d => !isNaN(d) && d > 0);
      const totalDons = dons.reduce((s, d) => s + d, 0);
      const avgDon = dons.length > 0 ? totalDons / dons.length : null;
      const ages = adh.map(r => calcAge(r.date_naissance)).filter(a => a !== null && a > 0 && a < 120);
      const avgAge = ages.length > 0 ? ages.reduce((s, a) => s + a, 0) / ages.length : null;
      const sortedAges = [...ages].sort((a,b) => a-b);
      const medianAge = sortedAges.length > 0 ? (sortedAges.length % 2 === 0 ? (sortedAges[sortedAges.length/2-1] + sortedAges[sortedAges.length/2]) / 2 : sortedAges[Math.floor(sortedAges.length/2)]) : null;
      const avecDon = dons.length;
      const sansDon = total - avecDon;
      const rgpdOk = adh.filter(r => r.consent_rgpd).length;
      const marketOk = adh.filter(r => r.consent_marketing).length;

      // Don par tranche (adhÃ©rents complets seulement)
      const tranches = [
        { label: "10â€“15â‚¬",  value: adh.filter(r => r.montant_don >= 10  && r.montant_don < 15).length },
        { label: "15â€“20â‚¬",  value: adh.filter(r => r.montant_don >= 15  && r.montant_don < 20).length },
        { label: "20â€“25â‚¬",  value: adh.filter(r => r.montant_don >= 20  && r.montant_don < 25).length },
        { label: "25â€“30â‚¬",  value: adh.filter(r => r.montant_don >= 25  && r.montant_don < 30).length },
        { label: "35â€“40â‚¬",  value: adh.filter(r => r.montant_don >= 35  && r.montant_don < 40).length },
        { label: "40â€“45â‚¬",  value: adh.filter(r => r.montant_don >= 40  && r.montant_don < 45).length },
        { label: "45â€“50â‚¬",  value: adh.filter(r => r.montant_don >= 45  && r.montant_don < 50).length },
        { label: "50â‚¬+",    value: adh.filter(r => r.montant_don >= 50).length },
      ];

      // Inscriptions par jour (7 derniers jours) â€” adhÃ©rents complets
      const now = new Date();
      const daily = Array.from({ length: 7 }, (_, i) => {
        const d = new Date(now); d.setDate(d.getDate() - (6 - i));
        const label = d.toLocaleDateString("fr-FR", { day: "2-digit", month: "2-digit" });
        const value = adh.filter(r => {
          const rd = new Date(r.created_at);
          return rd.toDateString() === d.toDateString();
        }).length;
        return { label, value };
      });

      // Villes top 5
      const villeCounts = {};
      adh.forEach(r => { if (r.ville) villeCounts[r.ville] = (villeCounts[r.ville] || 0) + 1; });
      const topVilles = Object.entries(villeCounts).sort((a, b) => b[1] - a[1]).slice(0, 5).map(([label, value]) => ({ label, value }));

      const totalReduction = adh.reduce((s, r) => s + (parseFloat(r.reduction_fiscale) || 0), 0);
      const totalCoutNet   = adh.reduce((s, r) => s + (parseFloat(r.cout_net) || 0), 0);

      // RÃ©partition par tranche d'Ã¢ge
      const ageTranches = [
        { label: "18â€“25", min: 18, max: 25, color: "#a78bfa" },
        { label: "26â€“35", min: 26, max: 35, color: "#60a5fa" },
        { label: "36â€“45", min: 36, max: 45, color: "#34d399" },
        { label: "46â€“57", min: 46, max: 57, color: "#fbbf24" },
        { label: "58â€“69", min: 58, max: 69, color: "#fb923c" },
        { label: "70â€“99", min: 70, max: 99, color: "#f472b6" },
      ].map(t => ({ ...t, value: ages.filter(a => a >= t.min && a <= t.max).length }));

      return { total, totalDons, avgDon, avgAge, medianAge, avecDon, sansDon, rgpdOk, marketOk, tranches, daily, topVilles, totalReduction, totalCoutNet, ageTranches };
    }, [adherentsComplets, adherents]);

    // â”€â”€ Table adhÃ©rents (complets uniquement) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    const filtered = useMemo(() => {
      const q = search.toLowerCase();
      return adherentsComplets.filter(r => {
        const ms = !q || `${r.nom} ${r.prenom} ${r.email} ${r.ville} ${r.telephone}`.toLowerCase().includes(q);
        const md = !filterDon || (filterDon === "0" && !r.montant_don) || (filterDon === "1" && r.montant_don >= 10 && r.montant_don < 20) || (filterDon === "2" && r.montant_don >= 20 && r.montant_don < 35) || (filterDon === "3" && r.montant_don >= 35 && r.montant_don < 50) || (filterDon === "4" && r.montant_don >= 50);
        return ms && md;
      }).sort((a, b) => {
        const va = a[sortField] ?? "", vb = b[sortField] ?? "";
        return sortDir === "asc" ? (va > vb ? 1 : -1) : (va < vb ? 1 : -1);
      });
    }, [adherentsComplets, search, filterDon, sortField, sortDir]);

    async function handleDelete(id) {
      try { await sbDelete("adherents", id); setAdherents(r => r.filter(x => x.id !== id)); setDelConfirm(null); setSelected(null); }
      catch { alert("Erreur lors de la suppression."); }
    }

    function sortBy(f) {
      if (sortField === f) setSortDir(d => d === "asc" ? "desc" : "asc");
      else { setSortField(f); setSortDir("asc"); }
    }

    const Arrow = ({ f }) => <span style={{ opacity: .5 }}>{sortField === f ? (sortDir === "asc" ? " â†‘" : " â†“") : " â†•"}</span>;

    if (!auth) return <Login onLogin={() => setAuth(true)} />;

    const navItems = [
      { key: "overview",    label: "Vue d'ensemble", icon: "ğŸ“Š" },
      { key: "incomplets",  label: `Incomplets${adherents ? ` (${adherentsIncomplets.length})` : ""}`, icon: "ğŸ“" },
      { key: "adherents",   label: `AdhÃ©rents${adherents ? ` (${adherentsComplets.length})` : ""}`, icon: "ğŸ‘¥" },
      { key: "collecteurs", label: `Collecteurs${collecteurs ? ` (${collecteurs.length})` : ""}`, icon: "ğŸš¶" },
      { key: "stats_indiv", label: "Stats par collecteur", icon: "ğŸ“ˆ" },
    ];

    return (
      <div style={{ minHeight: "100vh", display: "flex", flexDirection: "column" }}>

        {/* HEADER */}
        <header style={{ background: "rgba(255,255,255,0.03)", borderBottom: "1px solid rgba(255,255,255,0.07)", padding: "0 28px", height: 60, display: "flex", alignItems: "center", justifyContent: "space-between", position: "sticky", top: 0, zIndex: 100, backdropFilter: "blur(12px)" }}>
          <div style={{ display: "flex", alignItems: "center", gap: 28 }}>
            <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
              <div style={{ width: 32, height: 32, borderRadius: 10, background: "linear-gradient(135deg,#4c1d95,#6d28d9)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16 }}>âš™ï¸</div>
              <span style={{ fontFamily: serif, fontSize: 20, color: "white", fontWeight: 600 }}>Admin</span>
              <span className="badge badge-purple" style={{ marginLeft: 4 }}>Dashboard</span>
            </div>
            <nav style={{ display: "flex", gap: 2 }}>
              {navItems.map(n => (
                <button key={n.key} onClick={() => setPage(n.key)} className={`nav-link${page === n.key ? " active" : ""}`} style={{ background: page === n.key ? "rgba(124,58,237,.2)" : undefined }}>
                  {n.icon} {n.label}
                </button>
              ))}
            </nav>
          </div>
          <div style={{ display: "flex", alignItems: "center", gap: 10 }}>
            {lastRefresh && <span style={{ fontSize: 11, color: "rgba(255,255,255,0.3)" }}>ActualisÃ© {lastRefresh.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" })}</span>}
            <button onClick={load} disabled={loading} style={{ padding: "8px 16px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.12)", background: "rgba(255,255,255,0.06)", color: "white", cursor: loading ? "not-allowed" : "pointer", fontFamily: font, fontSize: 13, fontWeight: 600, display: "flex", alignItems: "center", gap: 6 }}>
              <span style={{ display: "inline-block", animation: loading ? "spin 1s linear infinite" : "none" }}>ğŸ”„</span> Actualiser
            </button>
            <a href="dashboard.html" style={{ padding: "8px 16px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.1)", background: "transparent", color: "rgba(255,255,255,0.5)", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600, textDecoration: "none" }}>â† Espace collecteur</a>
          </div>
        </header>

        {/* MAIN */}
        <main style={{ flex: 1, maxWidth: 1280, margin: "0 auto", width: "100%", padding: "32px 24px" }}>

          {error && (
            <div style={{ background: "rgba(239,68,68,.12)", border: "1px solid rgba(239,68,68,.3)", borderRadius: 14, padding: "16px 20px", marginBottom: 24, color: "#f87171", fontSize: 13 }}>
              âš ï¸ Erreur de chargement : {error}
            </div>
          )}

          {/* â”€â”€ OVERVIEW â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          {page === "overview" && (
            <div className="fade-in">
              <div style={{ marginBottom: 32 }}>
                <h1 style={{ fontFamily: serif, fontSize: 38, color: "white", fontWeight: 600, marginBottom: 6 }}>Vue d'ensemble</h1>
                <p style={{ color: "rgba(255,255,255,0.45)", fontSize: 14 }}>Statistiques globales de la plateforme de collecte</p>
              </div>

              {!stats ? (
                <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 16 }}>
                  {[1,2,3,4].map(i => <div key={i} className="card" style={{ height: 120 }}><div className="skeleton" style={{ marginBottom: 12 }} /><div className="skeleton" style={{ width: "60%" }} /></div>)}
                </div>
              ) : (
                <>
                  {/* KPIs row 1 */}
                  <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 16, marginBottom: 20 }}>
                    <KpiCard icon="ğŸ‘¥" label="AdhÃ©rents actifs" value={stats.total} color="#a78bfa" sub="RIB validÃ©" />
                    <KpiCard icon="ğŸ’¸" label="Don moyen mensuel" value={stats.avgDon !== null ? stats.avgDon.toFixed(2) : "â€”"} unit="â‚¬" color="#34d399" />
                    <KpiCard icon="ğŸ’°" label="Volume mensuel total" value={stats.totalDons.toFixed(0)} unit="â‚¬" color="#60a5fa" sub={`RÃ©duction: ${stats.totalReduction.toFixed(0)} â‚¬`} />
                    <KpiCard icon="ğŸ‚" label="Ã‚ge moyen" value={stats.avgAge !== null ? stats.avgAge.toFixed(1) : "â€”"} unit="ans" color="#fb923c" sub={`MÃ©diane : ${stats.medianAge !== null ? stats.medianAge.toFixed(0) : "â€”"} ans`} />
                  </div>

                  {/* KPIs row 2 */}
                  <div style={{ display: "grid", gridTemplateColumns: "repeat(4,1fr)", gap: 16, marginBottom: 28 }}>
                    <KpiCard icon="âœ…" label="Avec IBAN / prÃ©lÃ¨vement" value={adherentsComplets.filter(r => r.iban).length} color="#4ade80" sub={`${adherentsComplets.length > 0 ? (adherentsComplets.filter(r => r.iban).length / adherentsComplets.length * 100).toFixed(0) : 0}% des actifs`} />
                    <KpiCard icon="ğŸ“" label="Dossiers incomplets" value={adherentsIncomplets.length} color="#fb923c" sub="En attente de RIB" />
                    <KpiCard icon="ğŸš¶" label="Collecteurs inscrits" value={collecteurs ? collecteurs.length : "â€”"} color="#fbbf24" />
                    <KpiCard icon="ğŸ“" label="Villes couvertes" value={stats.topVilles.length > 0 ? Object.keys((() => { const v={}; adherentsComplets.forEach(r=>{if(r.ville)v[r.ville]=1;}); return v; })()).length : "â€”"} color="#f472b6" />
                  </div>

                  {/* Charts row */}
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr 1fr", gap: 20, marginBottom: 28 }}>
                    <div className="card">
                      <p style={{ fontSize: 13, fontWeight: 700, color: "white", marginBottom: 20 }}>Inscriptions â€” 7 derniers jours</p>
                      <MiniBar data={stats.daily} color="#a78bfa" />
                    </div>
                    <div className="card">
                      <p style={{ fontSize: 13, fontWeight: 700, color: "white", marginBottom: 20 }}>RÃ©partition des dons</p>
                      <MiniBar data={stats.tranches} color="#34d399" />
                    </div>
                    <div className="card">
                      <p style={{ fontSize: 13, fontWeight: 700, color: "white", marginBottom: 16 }}>Top 5 villes</p>
                      {stats.topVilles.length === 0 ? (
                        <p style={{ color: "rgba(255,255,255,0.3)", fontSize: 13 }}>Aucune donnÃ©e</p>
                      ) : (
                        stats.topVilles.map((v, i) => (
                          <div key={v.label} style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 8 }}>
                            <span style={{ fontSize: 11, color: "rgba(255,255,255,0.4)", width: 16 }}>{i + 1}.</span>
                            <div style={{ flex: 1, background: "rgba(255,255,255,0.06)", borderRadius: 4, height: 6, overflow: "hidden" }}>
                              <div style={{ width: `${(v.value / stats.topVilles[0].value) * 100}%`, height: "100%", background: "#60a5fa", borderRadius: 4 }} />
                            </div>
                            <span style={{ fontSize: 12, color: "rgba(255,255,255,0.7)", minWidth: 80 }}>{v.label}</span>
                            <span className="badge badge-blue">{v.value}</span>
                          </div>
                        ))
                      )}
                    </div>
                  </div>

                  {/* Age pie chart */}
                  <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20, marginBottom: 28 }}>
                    <div className="card">
                      <p style={{ fontSize: 13, fontWeight: 700, color: "white", marginBottom: 20 }}>ğŸ‚ RÃ©partition par tranche d'Ã¢ge</p>
                      <PieChart data={stats.ageTranches} size={160} />
                    </div>
                    <div className="card">
                      <p style={{ fontSize: 13, fontWeight: 700, color: "white", marginBottom: 16 }}>Top 5 villes</p>
                      {stats.topVilles.length === 0 ? (
                        <p style={{ color: "rgba(255,255,255,0.3)", fontSize: 13 }}>Aucune donnÃ©e</p>
                      ) : (
                        stats.topVilles.map((v, i) => (
                          <div key={v.label} style={{ display: "flex", alignItems: "center", gap: 10, marginBottom: 8 }}>
                            <span style={{ fontSize: 11, color: "rgba(255,255,255,0.4)", width: 16 }}>{i + 1}.</span>
                            <div style={{ flex: 1, background: "rgba(255,255,255,0.06)", borderRadius: 4, height: 6, overflow: "hidden" }}>
                              <div style={{ width: `${(v.value / stats.topVilles[0].value) * 100}%`, height: "100%", background: "#60a5fa", borderRadius: 4 }} />
                            </div>
                            <span style={{ fontSize: 12, color: "rgba(255,255,255,0.7)", minWidth: 80 }}>{v.label}</span>
                            <span className="badge badge-blue">{v.value}</span>
                          </div>
                        ))
                      )}
                    </div>
                  </div>

                  {/* Quick actions */}
                  <div style={{ display: "flex", gap: 12 }}>
                    <button onClick={() => { setPage("adherents"); }} style={{ padding: "12px 20px", borderRadius: 12, border: "1px solid rgba(255,255,255,0.1)", background: "rgba(255,255,255,0.05)", color: "rgba(255,255,255,0.8)", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600 }}>
                      ğŸ‘¥ Voir les adhÃ©rents actifs ({adherentsComplets.length})
                    </button>
                    <button onClick={() => exportCSV(adherentsComplets, "adherents_actifs")} style={{ padding: "12px 20px", borderRadius: 12, border: "1px solid rgba(255,255,255,0.1)", background: "rgba(255,255,255,0.05)", color: "rgba(255,255,255,0.8)", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600 }}>
                      ğŸ“¥ Exporter adhÃ©rents actifs (CSV)
                    </button>
                    {adherentsIncomplets.length > 0 && (
                      <button onClick={() => setPage("incomplets")} style={{ padding: "12px 20px", borderRadius: 12, border: "1px solid rgba(251,146,60,.3)", background: "rgba(251,146,60,.08)", color: "#fb923c", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600 }}>
                        ğŸ“ {adherentsIncomplets.length} dossier{adherentsIncomplets.length > 1 ? "s" : ""} incomplet{adherentsIncomplets.length > 1 ? "s" : ""}
                      </button>
                    )}
                  </div>
                </>
              )}
            </div>
          )}

          {/* â”€â”€ INCOMPLETS / RAPPELS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          {page === "incomplets" && (
            <div className="fade-in">
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-end", marginBottom: 24 }}>
                <div>
                  <h1 style={{ fontFamily: serif, fontSize: 36, color: "white", fontWeight: 600, marginBottom: 4 }}>ğŸ“ Dossiers incomplets</h1>
                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14 }}>Prospects en attente de RIB â€” <strong style={{color:"#fb923c"}}>pas encore adhÃ©rents</strong></p>
                </div>
                {adherentsIncomplets.length > 0 && (
                  <button onClick={() => exportCSV(adherentsIncomplets, "rappels")} style={{ padding: "10px 18px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.12)", background: "rgba(255,255,255,0.06)", color: "white", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600 }}>ğŸ“¥ Exporter CSV</button>
                )}
              </div>
              {loading ? (
                <div style={{ textAlign: "center", padding: 60, color: "rgba(255,255,255,0.3)" }} className="loading-dot">Chargementâ€¦</div>
              ) : adherentsIncomplets.length === 0 ? (
                <div className="card" style={{ textAlign: "center", padding: 60 }}>
                  <div style={{ fontSize: 40, marginBottom: 16 }}>âœ…</div>
                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15 }}>Aucun dossier incomplet â€” tout est Ã  jour !</p>
                </div>
              ) : (
                <div style={{ display: "flex", flexDirection: "column", gap: 12 }}>
                  {adherentsIncomplets.map((r, i) => {
                    const rdvDate = r.rdv_date ? new Date(r.rdv_date) : null;
                    const isUrgent = rdvDate && rdvDate <= new Date();
                    const collecteur = collecteurs ? collecteurs.find(c => c.id === r.collecteur_id) : null;
                    return (
                      <div key={r.id} style={{ background: isUrgent ? "rgba(239,68,68,.06)" : "rgba(255,255,255,0.03)", border: `1px solid ${isUrgent ? "rgba(239,68,68,.25)" : "rgba(251,146,60,.2)"}`, borderRadius: 16, padding: "20px 24px", display: "grid", gridTemplateColumns: "1fr 1fr 1fr auto", gap: 16, alignItems: "center" }}>
                        {/* IdentitÃ© */}
                        <div>
                          <div style={{ display: "flex", alignItems: "center", gap: 8, marginBottom: 6 }}>
                            <div style={{ width: 36, height: 36, borderRadius: 10, background: isUrgent ? "rgba(239,68,68,.15)" : "rgba(251,146,60,.12)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 16, flexShrink: 0 }}>{isUrgent ? "ğŸ”´" : "ğŸ“…"}</div>
                            <div>
                              <p style={{ fontWeight: 700, color: "white", fontSize: 15 }}>{r.prenom} {r.nom}</p>
                              <p style={{ fontSize: 11, color: "rgba(255,255,255,0.35)" }}>EnregistrÃ© le {fmtDate(r.created_at)}</p>
                            </div>
                          </div>
                          <span style={{ fontSize: 10, padding: "2px 8px", borderRadius: 20, background: "rgba(251,146,60,.15)", color: "#fb923c", fontWeight: 700 }}>â³ INCOMPLET â€” PAS ADHÃ‰RENT</span>
                        </div>
                        {/* Contact */}
                        <div>
                          <p style={{ fontSize: 13, color: "rgba(255,255,255,0.7)", marginBottom: 4 }}>ğŸ“ {r.telephone || "â€”"}</p>
                          <p style={{ fontSize: 12, color: "rgba(255,255,255,0.4)" }}>ğŸ“§ {r.email || "â€”"}</p>
                          {r.montant_don && <p style={{ fontSize: 12, color: "#34d399", fontWeight: 700, marginTop: 4 }}>ğŸ’¸ {parseFloat(r.montant_don).toFixed(2)} â‚¬/mois <span style={{color:"rgba(255,255,255,0.3)",fontWeight:400}}>(promis)</span></p>}
                        </div>
                        {/* RDV */}
                        <div>
                          {rdvDate ? (
                            <>
                              <p style={{ fontSize: 12, fontWeight: 700, color: isUrgent ? "#f87171" : "#fb923c", marginBottom: 4 }}>
                                {isUrgent ? "âš ï¸ En retard" : "ğŸ—“ PrÃ©vu le"} {rdvDate.toLocaleDateString("fr-FR", { weekday: "short", day: "2-digit", month: "short" })} Ã  {rdvDate.toLocaleTimeString("fr-FR", { hour: "2-digit", minute: "2-digit" })}
                              </p>
                              {r.rdv_note && <p style={{ fontSize: 11, color: "rgba(255,255,255,0.35)", fontStyle: "italic" }}>"{r.rdv_note}"</p>}
                            </>
                          ) : <p style={{ fontSize: 12, color: "rgba(255,255,255,0.3)" }}>Aucune date fixÃ©e</p>}
                          {collecteur && <p style={{ fontSize: 11, color: "rgba(255,255,255,0.3)", marginTop: 6 }}>Collecteur : {collecteur.prenom} {collecteur.nom}</p>}
                        </div>
                        {/* Actions */}
                        <div style={{ display: "flex", gap: 6 }}>
                          <button onClick={() => setSelected(r)} style={{ padding: "6px 14px", borderRadius: 8, border: "1px solid rgba(255,255,255,0.12)", background: "transparent", color: "white", cursor: "pointer", fontFamily: font, fontSize: 12 }}>Voir</button>
                          <button onClick={() => setDelConfirm(r)} style={{ padding: "6px 12px", borderRadius: 8, border: "none", background: "#7f1d1d", color: "#fca5a5", cursor: "pointer", fontFamily: font, fontSize: 12, fontWeight: 600 }}>Suppr.</button>
                        </div>
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

          {/* â”€â”€ ADHERENTS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          {page === "adherents" && (
            <div className="fade-in">
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-end", marginBottom: 24 }}>
                <div>
                  <h1 style={{ fontFamily: serif, fontSize: 36, color: "white", fontWeight: 600, marginBottom: 4 }}>AdhÃ©rents</h1>
                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14 }}>{filtered.length} rÃ©sultat{filtered.length !== 1 ? "s" : ""}{adherentsComplets && ` sur ${adherentsComplets.length} adhÃ©rents actifs`}</p>
                </div>
                <div style={{ display: "flex", gap: 10 }}>
                  <button onClick={() => exportCSV(filtered, "adherents")} style={{ padding: "10px 18px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.12)", background: "rgba(255,255,255,0.06)", color: "white", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600 }}>ğŸ“¥ Exporter CSV</button>                  <button onClick={load} style={{ padding: "10px 18px", borderRadius: 10, border: "none", background: "rgba(255,255,255,0.07)", color: "white", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600 }}>ğŸ”„ Actualiser</button>
                </div>
              </div>

              {/* Filters */}
              <div style={{ display: "flex", gap: 12, marginBottom: 20, flexWrap: "wrap" }}>
                <input value={search} onChange={e => setSearch(e.target.value)} placeholder="ğŸ”  Rechercher par nom, email, villeâ€¦" style={{ flex: "1 1 280px", padding: "11px 16px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.1)", background: "rgba(255,255,255,0.05)", color: "white", fontFamily: font, fontSize: 14, outline: "none" }} />
                <select value={filterDon} onChange={e => setFilterDon(e.target.value)} style={{ padding: "11px 16px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.1)", background: "#16142a", color: "white", fontFamily: font, fontSize: 13, cursor: "pointer", outline: "none" }}>
                  <option value="">Tous les dons</option>
                  <option value="0">Sans don</option>
                  <option value="1">10â‚¬ â€“ 20â‚¬</option>
                  <option value="2">20â‚¬ â€“ 35â‚¬</option>
                  <option value="3">35â‚¬ â€“ 50â‚¬</option>
                  <option value="4">50â‚¬+</option>
                </select>
              </div>

              {loading ? (
                <div style={{ textAlign: "center", padding: 60, color: "rgba(255,255,255,0.3)", fontSize: 14 }} className="loading-dot">Chargementâ€¦</div>
              ) : (
                <div style={{ background: "rgba(255,255,255,0.025)", borderRadius: 16, border: "1px solid rgba(255,255,255,0.07)", overflow: "hidden" }}>
                  <div style={{ overflowX: "auto" }}>
                    <table style={{ width: "100%", borderCollapse: "collapse", fontSize: 13 }}>
                      <thead>
                        <tr style={{ borderBottom: "1px solid rgba(255,255,255,0.1)" }}>
                          {[["created_at","Date"],["nom","Nom"],["prenom","PrÃ©nom"],["email","Email"],["ville","Ville"],["montant_don","Don"]].map(([f, l]) => (
                            <th key={f} onClick={() => sortBy(f)} className="th">{l}<Arrow f={f} /></th>
                          ))}
                          <th className="th" style={{ cursor: "default" }}>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {filtered.length === 0 && (
                          <tr><td colSpan={7} style={{ textAlign: "center", color: "rgba(255,255,255,0.3)", padding: 60, fontSize: 14 }}>Aucun adhÃ©rent trouvÃ©</td></tr>
                        )}
                        {filtered.map((r, i) => (
                          <tr key={r.id} className="tr-row" style={{ background: i % 2 === 0 ? "transparent" : "rgba(255,255,255,0.015)" }}>
                            <td style={{ padding: "12px 14px", color: "rgba(255,255,255,0.45)", whiteSpace: "nowrap" }}>{fmtDate(r.created_at)}</td>
                            <td style={{ padding: "12px 14px", color: "white", fontWeight: 600 }}>{r.nom}</td>
                            <td style={{ padding: "12px 14px", color: "rgba(255,255,255,0.8)" }}>{r.prenom}</td>
                            <td style={{ padding: "12px 14px", color: "rgba(255,255,255,0.65)", maxWidth: 200, overflow: "hidden", textOverflow: "ellipsis", whiteSpace: "nowrap" }}>{r.email}</td>
                            <td style={{ padding: "12px 14px", color: "rgba(255,255,255,0.55)" }}>{r.ville}</td>
                            <td style={{ padding: "12px 14px" }}>
                              {r.montant_don ? <span className="badge badge-green">{parseFloat(r.montant_don).toFixed(2)} â‚¬</span> : <span style={{ color: "rgba(255,255,255,0.2)", fontSize: 12 }}>â€”</span>}
                            </td>
                            <td style={{ padding: "12px 14px", whiteSpace: "nowrap" }}>
                              <button onClick={() => setSelected(r)} style={{ marginRight: 6, padding: "5px 12px", borderRadius: 8, border: "1px solid rgba(255,255,255,0.12)", background: "transparent", color: "white", cursor: "pointer", fontFamily: font, fontSize: 12 }}>Voir</button>
                              <button onClick={() => setDelConfirm(r)} style={{ padding: "5px 12px", borderRadius: 8, border: "none", background: "#7f1d1d", color: "#fca5a5", cursor: "pointer", fontFamily: font, fontSize: 12, fontWeight: 600 }}>Suppr.</button>
                            </td>
                          </tr>
                        ))}
                      </tbody>
                    </table>
                  </div>
                </div>
              )}
            </div>
          )}

          {/* â”€â”€ COLLECTEURS TABLE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          {page === "collecteurs" && (
            <div className="fade-in">
              <div style={{ display: "flex", justifyContent: "space-between", alignItems: "flex-end", marginBottom: 24 }}>
                <div>
                  <h1 style={{ fontFamily: serif, fontSize: 36, color: "white", fontWeight: 600, marginBottom: 4 }}>Collecteurs</h1>
                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14 }}>{collecteurs ? collecteurs.length : "â€”"} compte{collecteurs && collecteurs.length !== 1 ? "s" : ""} enregistrÃ©{collecteurs && collecteurs.length !== 1 ? "s" : ""}</p>
                </div>
                {collecteurs && collecteurs.length > 0 && (
                  <button onClick={() => exportCSV(collecteurs, "collecteurs")} style={{ padding: "10px 18px", borderRadius: 10, border: "1px solid rgba(255,255,255,0.12)", background: "rgba(255,255,255,0.06)", color: "white", cursor: "pointer", fontFamily: font, fontSize: 13, fontWeight: 600 }}>ğŸ“¥ Exporter CSV</button>
                )}
              </div>

              {loading ? (
                <div style={{ textAlign: "center", padding: 60, color: "rgba(255,255,255,0.3)" }} className="loading-dot">Chargementâ€¦</div>
              ) : !collecteurs || collecteurs.length === 0 ? (
                <div className="card" style={{ textAlign: "center", padding: 60 }}>
                  <div style={{ fontSize: 40, marginBottom: 16 }}>ğŸš¶</div>
                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15, marginBottom: 8 }}>Aucun collecteur enregistrÃ©</p>
                  <p style={{ color: "rgba(255,255,255,0.25)", fontSize: 13 }}>Les comptes crÃ©Ã©s via la page d'inscription apparaÃ®tront ici.</p>
                  <a href="register.html" style={{ display: "inline-block", marginTop: 20, padding: "11px 22px", borderRadius: 10, background: "linear-gradient(135deg,#4c1d95,#6d28d9)", color: "white", textDecoration: "none", fontSize: 13, fontWeight: 700 }}>CrÃ©er un compte â†’</a>
                </div>
              ) : (
                <div style={{ display: "grid", gridTemplateColumns: "repeat(auto-fill, minmax(300px, 1fr))", gap: 16 }}>
                  {collecteurs.map(c => (
                    <div key={c.id} className="card">
                      <div style={{ display: "flex", alignItems: "center", gap: 12, marginBottom: 14 }}>
                        <div style={{ width: 44, height: 44, borderRadius: 14, background: "linear-gradient(135deg,#4c1d95,#6d28d9)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 18, flexShrink: 0 }}>
                          {c.role === "admin" ? "âš™ï¸" : c.role === "responsable" ? "ğŸ‘”" : "ğŸš¶"}
                        </div>
                        <div style={{ flex: 1, minWidth: 0 }}>
                          <p style={{ fontWeight: 700, color: "white", fontSize: 15, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{c.prenom} {c.nom}</p>
                          <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 12, whiteSpace: "nowrap", overflow: "hidden", textOverflow: "ellipsis" }}>{c.email}</p>
                        </div>
                      </div>
                      <div style={{ display: "flex", flexWrap: "wrap", gap: 6 }}>
                        <span className={`badge ${c.role === "admin" ? "badge-purple" : c.role === "responsable" ? "badge-orange" : "badge-blue"}`}>
                          {c.role === "admin" ? "Administrateur" : c.role === "responsable" ? "Responsable" : "Collecteur"}
                        </span>
                        {c.organisation && <span className="badge" style={{ background: "rgba(255,255,255,0.06)", color: "rgba(255,255,255,0.5)", border: "1px solid rgba(255,255,255,0.1)" }}>{c.organisation}</span>}
                      </div>
                      {c.telephone && <p style={{ fontSize: 12, color: "rgba(255,255,255,0.35)", marginTop: 10 }}>ğŸ“ {c.telephone}</p>}
                      <p style={{ fontSize: 11, color: "rgba(255,255,255,0.25)", marginTop: 8 }}>Inscrit le {fmtDate(c.created_at)}</p>
                    </div>
                  ))}
                </div>
              )}
            </div>
          )}

          {/* â”€â”€ STATS PAR COLLECTEUR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */}
          {page === "stats_indiv" && (
            <div className="fade-in">
              <div style={{ marginBottom: 32 }}>
                <h1 style={{ fontFamily: serif, fontSize: 36, color: "white", fontWeight: 600, marginBottom: 6 }}>Statistiques par collecteur</h1>
                <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 14 }}>RÃ©capitulatif individuel de l'activitÃ© de chaque collecteur</p>
              </div>
              {!collecteurs || !adherents ? (
                <div style={{ textAlign: "center", padding: 60, color: "rgba(255,255,255,0.3)" }} className="loading-dot">Chargementâ€¦</div>
              ) : collecteurs.length === 0 ? (
                <div className="card" style={{ textAlign: "center", padding: 60 }}>
                  <p style={{ color: "rgba(255,255,255,0.4)", fontSize: 15 }}>Aucun collecteur enregistrÃ©</p>
                </div>
              ) : (
                <div style={{ display: "flex", flexDirection: "column", gap: 28 }}>
                  {collecteurs.map(col => {
                    const adhs = adherents.filter(a => a.collecteur_id === col.id && !a.incomplet);
                    const incom = adherents.filter(a => a.collecteur_id === col.id && a.incomplet === true);
                    const total = adhs.length;
                    const dons = adhs.map(r => parseFloat(r.montant_don)).filter(d => !isNaN(d) && d > 0);
                    const totalDons = dons.reduce((s,d) => s+d, 0);
                    const avgDon = dons.length > 0 ? totalDons / dons.length : null;
                    const ages = adhs.map(r => calcAge(r.date_naissance)).filter(a => a !== null && a > 0 && a < 120);
                    const avgAge = ages.length > 0 ? ages.reduce((s,a) => s+a, 0) / ages.length : null;
                    const perHour = (total / 6).toFixed(2);
                    const ageTranches = [
                      { label: "18â€“25", min: 18, max: 25, color: "#a78bfa" },
                      { label: "26â€“35", min: 26, max: 35, color: "#60a5fa" },
                      { label: "36â€“45", min: 36, max: 45, color: "#34d399" },
                      { label: "46â€“57", min: 46, max: 57, color: "#fbbf24" },
                      { label: "58â€“69", min: 58, max: 69, color: "#fb923c" },
                      { label: "70â€“99", min: 70, max: 99, color: "#f472b6" },
                    ].map(t => ({ ...t, value: ages.filter(a => a >= t.min && a <= t.max).length }));

                    return (
                      <div key={col.id} style={{ background: "rgba(255,255,255,0.03)", border: "1px solid rgba(255,255,255,0.08)", borderRadius: 20, padding: 28 }}>
                        {/* Collecteur header */}
                        <div style={{ display: "flex", alignItems: "center", gap: 14, marginBottom: 24, paddingBottom: 20, borderBottom: "1px solid rgba(255,255,255,0.07)" }}>
                          <div style={{ width: 48, height: 48, borderRadius: 14, background: "linear-gradient(135deg,#4c1d95,#6d28d9)", display: "flex", alignItems: "center", justifyContent: "center", fontSize: 22, flexShrink: 0 }}>
                            {col.role === "admin" ? "âš™ï¸" : col.role === "responsable" ? "ğŸ‘”" : "ğŸš¶"}
                          </div>
                          <div style={{ flex: 1 }}>
                            <h2 style={{ fontFamily: serif, fontSize: 22, color: "white", fontWeight: 600, marginBottom: 2 }}>{col.prenom} {col.nom}</h2>
                            <div style={{ display: "flex", gap: 8, alignItems: "center" }}>
                              <span style={{ fontSize: 12, color: "rgba(255,255,255,0.4)" }}>{col.email}</span>
                              {col.organisation && <span className="badge badge-purple" style={{ fontSize: 10 }}>{col.organisation}</span>}
                            </div>
                          </div>
                          <div style={{ textAlign: "right" }}>
                            <div style={{ fontFamily: serif, fontSize: 32, color: "#a78bfa", fontWeight: 700, lineHeight: 1 }}>{total}</div>
                            <div style={{ fontSize: 11, color: "rgba(255,255,255,0.35)", textTransform: "uppercase", letterSpacing: ".08em", marginTop: 4 }}>adhÃ©rent{total !== 1 ? "s" : ""} actif{total !== 1 ? "s" : ""}</div>
                            {incom.length > 0 && <div style={{ fontSize: 11, color: "#fb923c", fontWeight: 700, marginTop: 4 }}>+ {incom.length} incomplet{incom.length > 1 ? "s" : ""}</div>}
                          </div>
                        </div>

                        {total === 0 ? (
                          <p style={{ color: "rgba(255,255,255,0.25)", fontSize: 14, textAlign: "center", padding: "20px 0" }}>Aucun adhÃ©rent enregistrÃ© par ce collecteur</p>
                        ) : (
                          <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 20 }}>
                            {/* KPIs */}
                            <div style={{ display: "grid", gridTemplateColumns: "1fr 1fr", gap: 12 }}>
                              {[
                                { icon: "ğŸ’¸", label: "Don moyen", value: avgDon !== null ? avgDon.toFixed(2) + " â‚¬" : "â€”", color: "#34d399" },
                                { icon: "ğŸ’°", label: "Volume total", value: totalDons.toFixed(0) + " â‚¬", color: "#60a5fa" },
                                { icon: "ğŸ‚", label: "Ã‚ge moyen", value: avgAge !== null ? avgAge.toFixed(1) + " ans" : "â€”", color: "#fb923c" },
                                { icon: "â±ï¸", label: "Ratio / heure", value: perHour + " / h", color: "#fbbf24" },
                              ].map(kpi => (
                                <div key={kpi.label} style={{ background: "rgba(255,255,255,0.04)", borderRadius: 14, padding: "16px 18px", border: "1px solid rgba(255,255,255,0.07)" }}>
                                  <div style={{ fontSize: 20, marginBottom: 8 }}>{kpi.icon}</div>
                                  <div style={{ fontFamily: serif, fontSize: 22, fontWeight: 700, color: kpi.color, lineHeight: 1, marginBottom: 4 }}>{kpi.value}</div>
                                  <div style={{ fontSize: 10, fontWeight: 700, color: "rgba(255,255,255,0.35)", textTransform: "uppercase", letterSpacing: ".08em" }}>{kpi.label}</div>
                                </div>
                              ))}
                            </div>

                            {/* Pie chart tranche d'Ã¢ge */}
                            <div style={{ background: "rgba(255,255,255,0.04)", borderRadius: 14, padding: "16px 18px", border: "1px solid rgba(255,255,255,0.07)" }}>
                              <p style={{ fontSize: 12, fontWeight: 700, color: "rgba(255,255,255,0.5)", textTransform: "uppercase", letterSpacing: ".08em", marginBottom: 14 }}>ğŸ‚ Tranche d'Ã¢ge</p>
                              <PieChart data={ageTranches} size={140} />
                            </div>
                          </div>
                        )}
                      </div>
                    );
                  })}
                </div>
              )}
            </div>
          )}

        </main>

        {/* FOOTER */}
        <footer style={{ borderTop: "1px solid rgba(255,255,255,0.06)", padding: "14px 28px", display: "flex", justifyContent: "space-between", alignItems: "center" }}>
          <span style={{ fontSize: 12, color: "rgba(255,255,255,0.2)" }}>Espace Admin â€” Tableau de bord global</span>
          <div style={{ display: "flex", gap: 16 }}>
            <a href="dashboard.html" style={{ fontSize: 12, color: "rgba(255,255,255,0.3)", textDecoration: "none" }}>Espace collecteur</a>
            <a href="register.html" style={{ fontSize: 12, color: "rgba(255,255,255,0.3)", textDecoration: "none" }}>Inscription</a>
            <a href="index.html" style={{ fontSize: 12, color: "rgba(255,255,255,0.3)", textDecoration: "none" }}>Formulaire</a>
          </div>
        </footer>

        {/* MODALS */}
        <DetailModal row={selected} onClose={() => setSelected(null)} onDelete={row => { setSelected(null); setDelConfirm(row); }} />
        <ConfirmModal row={delConfirm} onConfirm={handleDelete} onCancel={() => setDelConfirm(null)} />

        <style>{`@keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }`}</style>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App />);
</script>
  <script src="pwa.js"></script>
</body>
</html>
