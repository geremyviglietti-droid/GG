<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="manifest" href="/manifest.json" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="apple-mobile-web-app-title" content="Adh√©sion" />
  <link rel="apple-touch-icon" href="/icons/icon-192.png" />
  <meta name="theme-color" content="#1e1b4b" />
  <title>Tableau de bord ‚Äî Espace Collecteur</title>
  <link rel="stylesheet" href="/libs/fonts.css" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0f0e1a; font-family: 'DM Sans', sans-serif; min-height: 100vh; color: white; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse { 0%,100% { opacity:.6; } 50% { opacity:1; } }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    .card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 28px; transition: border-color .2s, background .2s; }
    .card:hover { background: rgba(255,255,255,0.06); border-color: rgba(124,58,237,0.4); }
    .stat-value { font-family: 'Cormorant Garamond', serif; font-size: 36px; font-weight: 700; line-height: 1; }
    .stat-label { font-size: 11px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-top: 8px; }
    .btn-ghost { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.12); padding: 9px 18px; border-radius: 10px; font-family: 'DM Sans',sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: background .2s; text-decoration: none; display: inline-block; }
    .btn-ghost:hover { background: rgba(255,255,255,0.12); }
    .nav-link { color: rgba(255,255,255,0.55); text-decoration: none; font-size: 14px; font-weight: 500; padding: 8px 16px; border-radius: 10px; transition: background .2s, color .2s; border: none; cursor: pointer; font-family: 'DM Sans',sans-serif; background: transparent; }
    .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.08); color: white; }
    .loading-dot { animation: pulse 1.4s infinite; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
    .badge-purple { background: rgba(124,58,237,.2); color: #a78bfa; border: 1px solid rgba(124,58,237,.3); }

    /* ‚îÄ‚îÄ MOBILE NAV BAR ‚îÄ‚îÄ */
    .mobile-nav { display: none; position: fixed; bottom: 0; left: 0; right: 0; background: rgba(15,14,26,0.97); border-top: 1px solid rgba(255,255,255,0.08); z-index: 200; padding: 8px 0 env(safe-area-inset-bottom, 8px); backdrop-filter: blur(20px); }
    .mobile-nav-items { display: flex; justify-content: space-around; align-items: center; }
    .mobile-nav-btn { background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; font-family: 'DM Sans',sans-serif; display: flex; flex-direction: column; align-items: center; gap: 3px; padding: 6px 12px; border-radius: 12px; transition: all .2s; min-width: 60px; position: relative; }
    .mobile-nav-btn.active { color: #a78bfa; background: rgba(124,58,237,.15); }
    .mobile-nav-btn .nav-icon { font-size: 20px; line-height: 1; }
    .mobile-nav-btn .nav-label { font-size: 10px; font-weight: 600; letter-spacing: .03em; }
    .mobile-nav-badge { position: absolute; top: 4px; right: 8px; width: 16px; height: 16px; border-radius: 50%; background: #ef4444; color: white; font-size: 9px; font-weight: 700; display: flex; align-items: center; justify-content: center; }

    /* ‚îÄ‚îÄ RESPONSIVE ‚îÄ‚îÄ */
    @media (max-width: 768px) {
      .mobile-nav { display: block; }
      .desktop-header-nav { display: none !important; }
      .desktop-header-right { display: none !important; }
      header { padding: 0 16px !important; }
      main { padding: 20px 16px 90px !important; }
      .dashboard-grid { grid-template-columns: 1fr !important; }
      .stats-grid-3 { grid-template-columns: 1fr 1fr !important; }
      .stats-grid-2 { grid-template-columns: 1fr !important; }
      .kpi-grid { grid-template-columns: 1fr 1fr !important; }
      .donation-form-wrap { padding: 20px 16px !important; border-radius: 20px !important; }
      .form-grid-2 { grid-template-columns: 1fr !important; }
      .form-grid-cp { grid-template-columns: 120px 1fr !important; }
      .recap-grid-2 { grid-template-columns: 1fr !important; }
      .recap-cells { grid-template-columns: 1fr !important; }
      .stat-value { font-size: 28px !important; }
      .card { padding: 18px !important; border-radius: 16px !important; }
      .pie-wrap { flex-direction: column !important; align-items: flex-start !important; }
      h1[data-page-title] { font-size: 28px !important; }
      .rappel-card { flex-direction: column !important; align-items: flex-start !important; gap: 12px !important; }
      .rappel-actions { width: 100% !important; flex-direction: row !important; align-items: center !important; justify-content: space-between !important; }
      .completion-panel-wrap { padding: 20px 16px !important; border-radius: 20px !important; }
      .step-label { display: none !important; }
      .login-card { padding: 32px 20px !important; }
      .admin-btn-side { display: none !important; }
      .admin-btn-mobile { display: flex !important; }
    }

    @media (min-width: 769px) {
      .mobile-header-right { display: none !important; }
    }
    @media (max-width: 768px) {
      .desktop-header-right { display: none !important; }
    }
      main { padding: 28px 20px !important; }
      .stats-grid-3 { grid-template-columns: repeat(2, 1fr) !important; }
      .kpi-grid { grid-template-columns: repeat(3, 1fr) !important; }
    }

    .admin-btn-mobile { display: none; align-items: center; gap: 6px; background: rgba(124,58,237,.12); border: 1px solid rgba(124,58,237,.25); border-radius: 8px; padding: 6px 12px; color: rgba(167,139,250,0.7); font-size: 12px; font-family: 'DM Sans',sans-serif; font-weight: 600; text-decoration: none; cursor: pointer; }

    /* Ville suggestions dropdown */
    .ville-dropdown { position: absolute; top: 100%; left: 0; right: 0; background: white; border: 2px solid #6d28d9; border-top: none; border-radius: 0 0 12px 12px; z-index: 100; max-height: 200px; overflow-y: auto; box-shadow: 0 8px 24px rgba(0,0,0,0.15); }
    .ville-dropdown-item { padding: 10px 14px; font-size: 13px; color: #1a1a2e; cursor: pointer; border-bottom: 1px solid #f3f4f6; font-family: 'DM Sans',sans-serif; }
    .ville-dropdown-item:hover { background: #f5f3ff; color: #4c1d95; }
    .ville-dropdown-item:last-child { border-bottom: none; }

    /* Bar chart */
    .bar-chart-wrap { display: flex; flex-direction: column; gap: 8px; width: 100%; }
    .bar-row { display: flex; align-items: center; gap: 8px; }
    .bar-label { font-size: 11px; color: rgba(255,255,255,0.5); min-width: 52px; text-align: right; flex-shrink: 0; }
    .bar-track { flex: 1; background: rgba(255,255,255,0.06); border-radius: 6px; height: 22px; position: relative; overflow: hidden; }
    .bar-fill { height: 100%; border-radius: 6px; display: flex; align-items: center; justify-content: flex-end; padding-right: 8px; transition: width .6s cubic-bezier(.4,0,.2,1); min-width: 0; }
    .bar-fill span { font-size: 11px; font-weight: 700; color: rgba(255,255,255,0.9); white-space: nowrap; }
    .bar-count { font-size: 11px; color: rgba(255,255,255,0.35); min-width: 20px; text-align: left; flex-shrink: 0; }
  </style>
</head>
<body>
<div id="root"></div>

<script src="/libs/react.min.js"></script>
<script src="/libs/react-dom.min.js"></script>
<script src="/libs/babel.min.js"></script>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;

  const SUPABASE_URL  = "https://couruebftrtlqwffdavz.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_XKVDlf9Bem837GPgx8RNqw_lgs9Q6zc";
  const serif = "'Cormorant Garamond', serif";
  const font  = "'DM Sans', sans-serif";

  // ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function supabaseFetch(table, filter = "") {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*${filter}&order=created_at.desc`, {
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function supabaseDelete(table, id) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
      method: "DELETE",
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
    });
    if (!res.ok) throw new Error(await res.text());
  }

  async function supabaseUpdate(table, id, data) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, Prefer: "return=representation" },
      body: JSON.stringify(data),
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function supabaseInsert(table, data) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, Prefer: "return=representation" },
      body: JSON.stringify(data),
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function calcAge(dateStr) {
    if (!dateStr) return null;
    const parts = String(dateStr).split(/[-\/]/);
    if (parts.length < 3) return null;
    const bYear = parseInt(parts[0]), bMonth = parseInt(parts[1]) - 1, bDay = parseInt(parts[2]);
    if (isNaN(bYear) || isNaN(bMonth) || isNaN(bDay)) return null;
    const n = new Date();
    let age = n.getFullYear() - bYear;
    if (n.getMonth() < bMonth || (n.getMonth() === bMonth && n.getDate() < bDay)) age--;
    return (age >= 0 && age < 120) ? age : null;
  }

  async function hashPassword(pwd) {
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(pwd));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // ‚îÄ‚îÄ IBAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const IBAN_LENGTHS = { FR:27,DE:22,BE:16,ES:24,IT:27,CH:21,GB:22,NL:18,PT:25,LU:20,AT:20,SE:24 };
  function validateIBAN(iban) {
    const c = iban.replace(/\s/g,"").toUpperCase();
    if (c.length < 15 || c.length > 34) return false;
    if (IBAN_LENGTHS[c.slice(0,2)] && c.length !== IBAN_LENGTHS[c.slice(0,2)]) return false;
    const r = (c.slice(4)+c.slice(0,4)).split("").map(x=>isNaN(x)?(x.charCodeAt(0)-55).toString():x).join("");
    let rem = 0; for (let i=0;i<r.length;i++) rem=(rem*10+parseInt(r[i]))%97;
    return rem===1;
  }
  function isIBANComplete(iban) {
    const c = iban.replace(/\s/g,"").toUpperCase();
    return IBAN_LENGTHS[c.slice(0,2)] ? c.length===IBAN_LENGTHS[c.slice(0,2)] : c.length>=15;
  }

  // ‚îÄ‚îÄ PIE CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function PieChart({ data, size = 160 }) {
    const [hovered, setHovered] = React.useState(null);
    const total = data.reduce((s, d) => s + d.value, 0);
    if (total === 0) return <div style={{textAlign:"center",color:"rgba(255,255,255,0.3)",fontSize:12,padding:20}}>Pas encore de donn√©es</div>;
    let cumAngle = -Math.PI / 2;
    const cx = size / 2, cy = size / 2, r = size / 2 - 8;
    const slices = data.map(d => {
      const angle = (d.value / total) * 2 * Math.PI;
      const x1 = cx + r * Math.cos(cumAngle);
      const y1 = cy + r * Math.sin(cumAngle);
      cumAngle += angle;
      const x2 = cx + r * Math.cos(cumAngle);
      const y2 = cy + r * Math.sin(cumAngle);
      const large = angle > Math.PI ? 1 : 0;
      const midAngle = cumAngle - angle / 2;
      return { ...d, x1, y1, x2, y2, large, midAngle, pct: Math.round(d.value / total * 100) };
    }).filter(s => s.value > 0);
    return (
      <div className="pie-wrap" style={{display:"flex",alignItems:"center",gap:20,flexWrap:"wrap"}}>
        <svg width={size} height={size} style={{flexShrink:0}}>
          {slices.map((s, i) => (
            <path key={i}
              d={`M${cx},${cy} L${s.x1},${s.y1} A${r},${r} 0 ${s.large},1 ${s.x2},${s.y2} Z`}
              fill={s.color}
              opacity={hovered === null || hovered === i ? 1 : 0.4}
              stroke="rgba(15,14,26,0.6)" strokeWidth={2}
              style={{cursor:"pointer",transition:"opacity .2s"}}
              onMouseEnter={() => setHovered(i)}
              onMouseLeave={() => setHovered(null)}
              onClick={() => setHovered(hovered === i ? null : i)}
            />
          ))}
          {hovered !== null && slices[hovered] && (
            <text x={cx} y={cy-6} textAnchor="middle" fill="white" fontSize={13} fontWeight="700">{slices[hovered].pct}%</text>
          )}
          {hovered !== null && slices[hovered] && (
            <text x={cx} y={cy+10} textAnchor="middle" fill="rgba(255,255,255,0.6)" fontSize={9}>{slices[hovered].label}</text>
          )}
          {hovered === null && (
            <text x={cx} y={cy+5} textAnchor="middle" fill="rgba(255,255,255,0.3)" fontSize={10}>{total} adh.</text>
          )}
        </svg>
        <div style={{display:"flex",flexDirection:"column",gap:5}}>
          {slices.map((s, i) => (
            <div key={i} style={{display:"flex",alignItems:"center",gap:7,opacity:hovered===null||hovered===i?1:0.4,transition:"opacity .2s",cursor:"pointer"}}
              onMouseEnter={() => setHovered(i)} onMouseLeave={() => setHovered(null)} onClick={() => setHovered(hovered===i?null:i)}>
              <div style={{width:10,height:10,borderRadius:3,background:s.color,flexShrink:0}}/>
              <span style={{fontSize:11,color:"rgba(255,255,255,0.6)"}}>{s.label}</span>
              <span style={{fontSize:11,fontWeight:700,color:"white",marginLeft:"auto",paddingLeft:8}}>{s.value}</span>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // ‚îÄ‚îÄ BAR CHART ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function BarChart({ data }) {
    const max = Math.max(...data.map(d => d.value), 1);
    const hasData = data.some(d => d.value > 0);
    if (!hasData) return <div style={{textAlign:"center",color:"rgba(255,255,255,0.3)",fontSize:12,padding:20}}>Pas encore de donn√©es</div>;
    return (
      <div className="bar-chart-wrap">
        {data.map((d, i) => (
          <div key={i} className="bar-row">
            <span className="bar-label">{d.label}</span>
            <div className="bar-track">
              <div className="bar-fill" style={{width:`${(d.value/max)*100}%`, background:d.color, opacity:d.value===0?0.15:1}}>
                {d.value > 0 && <span>{d.value}</span>}
              </div>
            </div>
            <span className="bar-count">{d.value}</span>
          </div>
        ))}
      </div>
    );
  }

  // ‚îÄ‚îÄ LOGIN SCREEN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function LoginScreen({ onLogin }) {
    const [email, setEmail]       = useState("");
    const [password, setPassword] = useState("");
    const [showPwd, setShowPwd]   = useState(false);
    const [loading, setLoading]   = useState(false);
    const [error, setError]       = useState(null);

    async function handleLogin() {
      if (!email.trim() || !password) { setError("Veuillez remplir tous les champs."); return; }
      setLoading(true); setError(null);
      try {
        const hash = await hashPassword(password);
        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/collecteurs?email=eq.${encodeURIComponent(email.trim())}&password_hash=eq.${hash}&select=*`,
          { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` } }
        );
        const rows = await res.json();
        if (!rows || rows.length === 0) {
          setError("Email ou mot de passe incorrect.");
        } else {
          const user = rows[0];
          sessionStorage.setItem("collecteur", JSON.stringify(user));
          onLogin(user);
        }
      } catch(e) { setError("Erreur de connexion : " + e.message); }
      setLoading(false);
    }

    const inp = (err) => ({
      border: `2px solid ${err ? "#f87171" : "rgba(255,255,255,0.1)"}`,
      borderRadius: 14, padding: "14px 18px", width: "100%", outline: "none",
      fontSize: 15, fontFamily: font, background: "rgba(255,255,255,0.05)",
      color: "white", boxSizing: "border-box", transition: "border .2s",
    });
    const lbl = { fontSize:11, fontWeight:700, color:"rgba(255,255,255,0.4)", display:"block", marginBottom:7, letterSpacing:".08em", textTransform:"uppercase" };

    return (
      <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"radial-gradient(ellipse at 60% 30%, rgba(76,29,149,.25), transparent 60%), #0f0e1a",padding:24}}>
        <div className="fade-in login-card" style={{background:"rgba(255,255,255,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:28,padding:"52px 44px",maxWidth:420,width:"100%"}}>
          <div style={{textAlign:"center",marginBottom:36}}>
            <div style={{width:60,height:60,borderRadius:18,background:"linear-gradient(135deg,#4c1d95,#6d28d9)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 20px",fontSize:26}}>üéØ</div>
            <h1 style={{fontFamily:serif,fontSize:32,color:"white",fontWeight:600,marginBottom:6}}>Espace Collecteur</h1>
            <p style={{color:"rgba(255,255,255,0.4)",fontSize:14}}>Connectez-vous pour acc√©der √† votre tableau de bord</p>
          </div>
          <div style={{marginBottom:16}}>
            <label style={lbl}>Adresse email</label>
            <input type="email" value={email} onChange={e=>{setEmail(e.target.value);setError(null);}} onKeyDown={e=>e.key==="Enter"&&handleLogin()} placeholder="jean.martin@email.com" style={inp(!!error)} />
          </div>
          <div style={{marginBottom:24}}>
            <label style={lbl}>Mot de passe</label>
            <div style={{position:"relative"}}>
              <input type={showPwd?"text":"password"} value={password} onChange={e=>{setPassword(e.target.value);setError(null);}} onKeyDown={e=>e.key==="Enter"&&handleLogin()} placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" style={{...inp(!!error),paddingRight:48}} />
              <button onClick={()=>setShowPwd(v=>!v)} style={{position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.4)",fontSize:16}}>{showPwd?"üôà":"üëÅ"}</button>
            </div>
          </div>
          {error && <div style={{background:"rgba(239,68,68,.12)",border:"1px solid rgba(239,68,68,.3)",borderRadius:10,padding:"12px 16px",marginBottom:16,color:"#f87171",fontSize:13,textAlign:"center"}}>{error}</div>}
          <button onClick={handleLogin} disabled={loading} style={{width:"100%",padding:"15px",borderRadius:14,border:"none",background:loading?"rgba(255,255,255,0.1)":"linear-gradient(135deg,#4c1d95,#6d28d9)",color:loading?"rgba(255,255,255,0.4)":"white",fontSize:15,fontWeight:700,cursor:loading?"not-allowed":"pointer",fontFamily:font,boxShadow:loading?"none":"0 8px 28px rgba(76,29,149,.45)",transition:"all .2s"}}>
            {loading ? "Connexion en cours‚Ä¶" : "Se connecter ‚Üí"}
          </button>
          <p style={{textAlign:"center",fontSize:13,color:"rgba(255,255,255,0.35)",marginTop:20}}>
            Pas encore de compte ? <a href="register.html" style={{color:"#a78bfa",textDecoration:"none",fontWeight:600}}>S'inscrire</a>
          </p>
        </div>
      </div>
    );
  }

  // ‚îÄ‚îÄ DONATION PANEL ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function DonationPanel({ currentUser, onSuccess }) {
    const [step, setStep]             = useState(0);
    const [form, setForm]             = useState({ nom:"", prenom:"", sexe:"", dateNaissance:"", adresse:"", codePostal:"", ville:"", telephone:"", email:"", consentRgpd:false, consentMarketing:false, montantDon:"", iban:"", bic:"", ibanValid:null, rdvDate:"", rdvHeure:"", rdvNote:"", ibanDiffere:false });
    const [errors, setErrors]         = useState({});
    const [submitting, setSubmitting] = useState(false);
    const [submitError, setSubmitError] = useState(null);
    const [done, setDone]             = useState(false);
    const [villeSuggestions, setVilleSuggestions] = useState([]);
    const [loadingVille, setLoadingVille] = useState(false);
    const canvasRef = useRef(null);
    const lastPos   = useRef(null);
    const [drawing, setDrawing]       = useState(false);
    const [signature, setSignature]   = useState(null);
    const cpTimerRef = useRef(null);

    const steps = ["Coordonn√©es","RGPD","Don","IBAN","R√©cap & Signature"];
    const montant = parseFloat(form.montantDon) || 0;
    const defiscalisation = (montant * 0.66).toFixed(2);
    const netDon = (montant * 0.34).toFixed(2);

    // Auto-lookup city from postal code (French API)
    async function lookupVille(cp) {
      if (cp.length < 5) { setVilleSuggestions([]); return; }
      setLoadingVille(true);
      try {
        const res = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${cp}&fields=nom,codesPostaux&limit=8`);
        const data = await res.json();
        setVilleSuggestions(data.map(c => c.nom));
        if (data.length === 1) {
          setForm(f => ({...f, ville: data[0].nom}));
          setErrors(e => ({...e, ville: undefined}));
          setVilleSuggestions([]);
        }
      } catch(e) { setVilleSuggestions([]); }
      setLoadingVille(false);
    }

    function formatPhone(raw) {
      const digits = raw.replace(/\D/g, "").slice(0, 10);
      return digits.replace(/(\d{2})(?=\d)/g, "$1 ").trim();
    }

    // Format IBAN: groups of 4 chars
    function formatIBAN(raw) {
      const clean = raw.replace(/\s/g, "").toUpperCase();
      return clean.replace(/(.{4})(?=.)/g, "$1 ").trim();
    }

    function update(k, v) {
      setForm(f => {
        const n = {...f, [k]:v};
        if (k === "iban") {
          n[k] = formatIBAN(v);
          n.ibanValid = isIBANComplete(n[k]) ? validateIBAN(n[k]) : null;
        }
        if (k === "telephone") n[k] = formatPhone(v);
        return n;
      });
      setErrors(e => ({...e, [k]:undefined}));
      if (k === "codePostal") {
        clearTimeout(cpTimerRef.current);
        if (v.length >= 5) {
          cpTimerRef.current = setTimeout(() => lookupVille(v), 300);
        } else {
          setVilleSuggestions([]);
        }
      }
    }

    const inputS = (err, ok) => ({ border:`2px solid ${err?"#f87171":ok?"#22c55e":"#e2e8f0"}`, borderRadius:14, padding:"13px 16px", width:"100%", outline:"none", fontSize:14, fontFamily:font, background:err?"#fff5f5":ok?"#f0fdf4":"white", color:"#1a1a2e", boxSizing:"border-box" });
    const lbl = { fontSize:11, fontWeight:700, color:"#6b7280", display:"block", marginBottom:6, letterSpacing:".08em", textTransform:"uppercase" };

    function posFromEvent(e, canvas) {
      const r = canvas.getBoundingClientRect();
      const src = e.touches ? e.touches[0] : e;
      return { x:(src.clientX-r.left)*(canvas.width/r.width), y:(src.clientY-r.top)*(canvas.height/r.height) };
    }
    function startDraw(e) { e.preventDefault(); lastPos.current = posFromEvent(e, canvasRef.current); setDrawing(true); }
    function draw(e) {
      if (!drawing) return; e.preventDefault();
      const ctx = canvasRef.current.getContext("2d");
      const p = posFromEvent(e, canvasRef.current);
      ctx.beginPath(); ctx.strokeStyle="#1a1a2e"; ctx.lineWidth=2.5; ctx.lineCap="round"; ctx.lineJoin="round";
      ctx.moveTo(lastPos.current.x, lastPos.current.y); ctx.lineTo(p.x, p.y); ctx.stroke();
      lastPos.current = p;
    }
    function endDraw(e) { e.preventDefault(); setDrawing(false); setSignature(canvasRef.current.toDataURL()); }
    function clearSignature() {
      const ctx = canvasRef.current.getContext("2d");
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height);
      setSignature(null);
    }
    function initCanvas() {
      if (!canvasRef.current) return;
      const ctx = canvasRef.current.getContext("2d");
      ctx.fillStyle = "#ffffff";
      ctx.fillRect(0, 0, canvasRef.current.width, canvasRef.current.height);
    }
    React.useEffect(() => { if (step === 4) setTimeout(initCanvas, 50); }, [step]);

    function validate() {
      const e = {};
      if (step===0) {
        if (!form.nom.trim())    e.nom = "Requis";
        if (!form.prenom.trim()) e.prenom = "Requis";
        if (!form.dateNaissance) e.dateNaissance = "Requis";
        if (!form.adresse.trim()) e.adresse = "Requis";
        if (!form.codePostal.trim()) e.codePostal = "Requis";
        if (!form.ville.trim())  e.ville = "Requis";
        if (!form.telephone.trim()) e.telephone = "Requis";
        if (!form.email.trim() || !form.email.includes("@")) e.email = "Email invalide";
      }
      if (step===1 && !form.consentRgpd) e.consentRgpd = "Obligatoire";
      if (step===2) {
        const m = parseFloat(form.montantDon);
        if (!form.montantDon || isNaN(m)) e.montantDon = "Requis";
        else if (m < 10) e.montantDon = "Minimum 10 ‚Ç¨";
      }
      if (step===3) {
        if (!form.ibanDiffere) {
          if (!form.iban.trim()) e.iban = "Requis";
          else if (form.ibanValid === false) e.iban = "IBAN invalide";
          else if (form.ibanValid === null)  e.iban = "IBAN incomplet";
        } else {
          if (!form.rdvDate) e.rdvDate = "Veuillez choisir une date de rappel";
          if (!form.rdvHeure) e.rdvHeure = "Veuillez choisir une heure";
        }
      }
      setErrors(e);
      return Object.keys(e).length === 0;
    }

    function next() { if (validate()) setStep(s => s+1); }
    function prev() { setStep(s => s-1); }

    async function handleSubmit() {
      if (!signature) { alert("Veuillez signer avant de valider."); return; }
      setSubmitting(true); setSubmitError(null);
      try {
        await supabaseInsert("adherents", {
          nom: form.nom, prenom: form.prenom, sexe: form.sexe || null, date_naissance: form.dateNaissance,
          adresse: form.adresse, code_postal: form.codePostal, ville: form.ville,
          telephone: form.telephone, email: form.email,
          consent_rgpd: form.consentRgpd, consent_marketing: form.consentMarketing,
          montant_don: form.montantDon ? parseFloat(form.montantDon) : null,
          reduction_fiscale: form.montantDon ? parseFloat(defiscalisation) : null,
          cout_net: form.montantDon ? parseFloat(netDon) : null,
          iban: form.ibanDiffere ? null : form.iban,
          bic: form.ibanDiffere ? null : form.bic,
          signature,
          collecteur_id: currentUser?.id,
          incomplet: form.ibanDiffere ? true : false,
          rdv_date: form.ibanDiffere && form.rdvDate ? `${form.rdvDate}T${form.rdvHeure||"10:00"}` : null,
          rdv_note: form.ibanDiffere ? form.rdvNote : null,
        });
        setDone(true);
        setTimeout(() => {
          onSuccess && onSuccess();
          setDone(false); setStep(0);
          setForm({ nom:"", prenom:"", sexe:"", dateNaissance:"", adresse:"", codePostal:"", ville:"", telephone:"", email:"", consentRgpd:false, consentMarketing:false, montantDon:"", iban:"", bic:"", ibanValid:null, rdvDate:"", rdvHeure:"", rdvNote:"", ibanDiffere:false });
          setSignature(null);
        }, 2000);
      } catch(e) { setSubmitError("Erreur : " + e.message); }
      setSubmitting(false);
    }

    if (done) return (
      <div style={{textAlign:"center",padding:"60px 0"}}>
        <div style={{width:64,height:64,borderRadius:"50%",background:"#dcfce7",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px",fontSize:28,color:"#16a34a"}}>‚úì</div>
        <h3 style={{fontFamily:serif,fontSize:26,color:"#1a1a2e",marginBottom:8}}>Dossier enregistr√© !</h3>
        <p style={{color:"#6b7280",fontSize:14}}>Retour au tableau de bord‚Ä¶</p>
      </div>
    );

    return (
      <div>
        {/* Barre de progression */}
        <div style={{display:"flex",gap:4,marginBottom:24}}>
          {steps.map((s,i) => (
            <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:6}}>
              <div style={{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:700,background:i<step?"#22c55e":i===step?"#6d28d9":"#e5e7eb",color:i<=step?"white":"#9ca3af"}}>{i<step?"‚úì":i+1}</div>
              <span className="step-label" style={{fontSize:9,color:i===step?"#6d28d9":"#9ca3af",fontWeight:700,textTransform:"uppercase",letterSpacing:".06em",textAlign:"center"}}>{s}</span>
            </div>
          ))}
        </div>

        {/* √âtape 0 */}
        {step===0 && (
          <div>
            <div className="form-grid-2" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,marginBottom:16}}>
              <div><label style={lbl}>Nom</label><input style={inputS(!!errors.nom)} value={form.nom} onChange={e=>update("nom",e.target.value)} placeholder="MARTIN"/>{errors.nom&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.nom}</p>}</div>
              <div><label style={lbl}>Pr√©nom</label><input style={inputS(!!errors.prenom)} value={form.prenom} onChange={e=>update("prenom",e.target.value)} placeholder="Jean"/>{errors.prenom&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.prenom}</p>}</div>
            </div>

            {/* S√©lecteur genre */}
            <div style={{marginBottom:16}}>
              <label style={lbl}>Genre <span style={{fontWeight:300,opacity:.5}}>(optionnel)</span></label>
              <div style={{display:"flex",gap:10}}>
                {[
                  {val:"M", label:"‚ôÇ Masculin",  bg:"#eff6ff", border:"#3b82f6", text:"#1d4ed8", activeBg:"#dbeafe"},
                  {val:"F", label:"‚ôÄ F√©minin",   bg:"#fdf2f8", border:"#ec4899", text:"#be185d", activeBg:"#fce7f3"},
                  {val:"A", label:"‚öß Autre",      bg:"#f9fafb", border:"#9ca3af", text:"#6b7280", activeBg:"#f3f4f6"},
                ].map(opt => (
                  <div
                    key={opt.val}
                    onClick={()=>update("sexe", form.sexe===opt.val ? "" : opt.val)}
                    style={{
                      flex:1, padding:"10px 8px", borderRadius:12, cursor:"pointer", textAlign:"center",
                      border:`2px solid ${form.sexe===opt.val ? opt.border : "#e5e7eb"}`,
                      background: form.sexe===opt.val ? opt.activeBg : "white",
                      transition:"all .15s"
                    }}
                  >
                    <p style={{fontSize:13,fontWeight:700,color:form.sexe===opt.val?opt.text:"#6b7280"}}>{opt.label}</p>
                  </div>
                ))}
              </div>
            </div>

            <div style={{marginBottom:16}}><label style={lbl}>Date de naissance</label><input type="date" style={inputS(!!errors.dateNaissance)} value={form.dateNaissance} onChange={e=>update("dateNaissance",e.target.value)}/>{errors.dateNaissance&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.dateNaissance}</p>}</div>
            <div style={{marginBottom:16}}><label style={lbl}>Adresse</label><input style={inputS(!!errors.adresse)} value={form.adresse} onChange={e=>update("adresse",e.target.value)} placeholder="12 rue de la Paix"/>{errors.adresse&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.adresse}</p>}</div>
            <div className="form-grid-cp" style={{display:"grid",gridTemplateColumns:"160px 1fr",gap:16,marginBottom:16}}>
              <div>
                <label style={lbl}>Code postal</label>
                <input style={inputS(!!errors.codePostal)} value={form.codePostal} onChange={e=>update("codePostal",e.target.value)} placeholder="75001" maxLength={5} inputMode="numeric"/>
                {loadingVille && <p style={{fontSize:11,color:"#9ca3af",marginTop:4}}>Recherche‚Ä¶</p>}
                {errors.codePostal&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.codePostal}</p>}
              </div>
              <div>
                <label style={lbl}>Ville</label>
                <div style={{position:"relative"}}>
                  <input style={inputS(!!errors.ville)} value={form.ville} onChange={e=>update("ville",e.target.value)} placeholder="Paris"/>
                  {villeSuggestions.length > 0 && (
                    <div className="ville-dropdown">
                      {villeSuggestions.map((v,i) => (
                        <div key={i} className="ville-dropdown-item" onMouseDown={()=>{ setForm(f=>({...f,ville:v})); setVilleSuggestions([]); setErrors(e=>({...e,ville:undefined})); }}>{v}</div>
                      ))}
                    </div>
                  )}
                </div>
                {errors.ville&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.ville}</p>}
              </div>
            </div>
            <div className="form-grid-2" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
              <div>
                <label style={lbl}>T√©l√©phone</label>
                <input type="tel" inputMode="numeric" style={inputS(!!errors.telephone)} value={form.telephone} onChange={e=>update("telephone",e.target.value)} placeholder="06 12 34 56 78"/>
                {errors.telephone&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.telephone}</p>}
              </div>
              <div>
                <label style={lbl}>Email</label>
                <input type="email" style={inputS(!!errors.email)} value={form.email} onChange={e=>update("email",e.target.value)} placeholder="jean@email.com" autoComplete="off"/>
                {errors.email&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.email}</p>}
              </div>
            </div>
          </div>
        )}

        {/* √âtape 1 ‚Äî RGPD */}
        {step===1 && (
          <div>
            <div style={{marginBottom:20}}>
              <h3 style={{fontSize:16,fontWeight:700,color:"#1a1a2e",marginBottom:4}}>Protection de vos donn√©es personnelles</h3>
              <p style={{fontSize:12,color:"#6b7280",lineHeight:1.6}}>Conform√©ment au R√®glement G√©n√©ral sur la Protection des Donn√©es (RGPD ‚Äì UE 2016/679), nous vous informons de l'utilisation de vos donn√©es.</p>
            </div>

            <div style={{background:"#f9fafb",borderRadius:14,padding:"18px 20px",marginBottom:16,border:"1px solid #e5e7eb"}}>
              <div className="form-grid-2" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                {[
                  {icon:"üéØ",title:"Finalit√© de la collecte",text:"Gestion de votre adh√©sion, traitement du pr√©l√®vement SEPA mensuel et suivi de votre dossier de donateur."},
                  {icon:"‚öñÔ∏è",title:"Base l√©gale",text:"Art. 6.1.b RGPD ‚Äî Ex√©cution d'un contrat. Le traitement est n√©cessaire √† l'ex√©cution de votre adh√©sion."},
                  {icon:"üîí",title:"S√©curit√© & conservation",text:"Vos donn√©es sont chiffr√©es (TLS 1.3) et conserv√©es 3 ans apr√®s la fin de votre adh√©sion, puis archiv√©es 5 ans (obligations l√©gales)."},
                  {icon:"üö´",title:"Pas de vente de donn√©es",text:"Vos donn√©es ne sont jamais vendues ni c√©d√©es √† des tiers √† des fins commerciales. Acc√®s strictement limit√© √† notre organisation."},
                ].map(item => (
                  <div key={item.title} style={{display:"flex",gap:10,alignItems:"flex-start"}}>
                    <span style={{fontSize:18,flexShrink:0}}>{item.icon}</span>
                    <div>
                      <p style={{fontSize:12,fontWeight:700,color:"#1a1a2e",marginBottom:3}}>{item.title}</p>
                      <p style={{fontSize:11,color:"#6b7280",lineHeight:1.55}}>{item.text}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div style={{background:"#eff6ff",borderRadius:12,padding:"12px 16px",marginBottom:16,border:"1px solid #bfdbfe"}}>
              <p style={{fontSize:12,color:"#1e40af",fontWeight:600,marginBottom:4}}>Vos droits (Art. 15 √† 22 RGPD)</p>
              <p style={{fontSize:12,color:"#1d4ed8",lineHeight:1.6}}>Vous disposez d'un droit d'<strong>acc√®s</strong>, de <strong>rectification</strong>, d'<strong>effacement</strong>, de <strong>portabilit√©</strong> et d'<strong>opposition</strong> au traitement de vos donn√©es. Pour exercer vos droits : <span style={{fontWeight:700}}>dpo@organisation.fr</span></p>
            </div>

            <div style={{marginTop:4}}>
              {[{key:"consentRgpd",required:true,label:"J'ai lu et j'accepte la politique de confidentialit√©. J'autorise le traitement de mes donn√©es personnelles dans le cadre de mon adh√©sion."},{key:"consentMarketing",required:false,label:"J'accepte de recevoir des communications sur les actualit√©s et les actions de l'organisation. (optionnel)"}].map(({key,required,label}) => (
                <div key={key} onClick={()=>{setForm(f=>({...f,[key]:!f[key]}));setErrors(e=>({...e,[key]:undefined}));}} style={{display:"flex",gap:14,alignItems:"flex-start",padding:"14px 16px",borderRadius:12,border:`2px solid ${errors[key]?"#f87171":form[key]?"#6d28d9":"#e5e7eb"}`,background:form[key]?"#f5f3ff":"white",cursor:"pointer",marginBottom:10,transition:"all .15s"}}>
                  <div style={{width:22,height:22,borderRadius:6,border:`2px solid ${form[key]?"#6d28d9":"#d1d5db"}`,background:form[key]?"#6d28d9":"white",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:1}}>{form[key]&&<span style={{color:"white",fontSize:11,fontWeight:700}}>‚úì</span>}</div>
                  <p style={{fontSize:13,color:"#374151",lineHeight:1.5,margin:0}}>{label}{required&&<span style={{color:"#ef4444",marginLeft:4}}>*</span>}</p>
                </div>
              ))}
              {errors.consentRgpd&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.consentRgpd}</p>}
            </div>
          </div>
        )}

        {/* √âtape 2 */}
        {step===2 && (
          <div>
            <div style={{marginBottom:20}}>
              <label style={lbl}>Montant du don mensuel (‚Ç¨)</label>
              <input
                type="number" min="10" step="0.01"
                value={form.montantDon}
                onChange={e=>update("montantDon",e.target.value)}
                placeholder="Minimum 10 ‚Ç¨"
                style={{...inputS(montant > 0 && montant < 10), fontSize:16}}
              />
              {montant > 0 && montant < 10 && (
                <div style={{marginTop:8,background:"#fef2f2",border:"1px solid #fecaca",borderRadius:10,padding:"10px 14px",display:"flex",alignItems:"center",gap:8}}>
                  <span style={{fontSize:18}}>‚ö†Ô∏è</span>
                  <p style={{color:"#dc2626",fontSize:13,fontWeight:700}}>Le montant minimum est de <strong>10 ‚Ç¨</strong> par mois. Montant saisi : {montant.toFixed(2)} ‚Ç¨</p>
                </div>
              )}
            </div>
            {montant >= 10 && (
              <div className="form-grid-2" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                <div style={{background:"#f0fdf4",borderRadius:14,padding:"18px 14px",textAlign:"center",border:"1px solid #bbf7d0"}}>
                  <p style={{fontSize:10,fontWeight:700,color:"#14532d",textTransform:"uppercase",letterSpacing:".06em",marginBottom:8}}>R√©duction 66%</p>
                  <p style={{fontSize:24,fontWeight:700,color:"#16a34a"}}>{defiscalisation} ‚Ç¨</p>
                </div>
                <div style={{background:"#f0fdf4",borderRadius:14,padding:"18px 14px",textAlign:"center",border:"1px solid #bbf7d0"}}>
                  <p style={{fontSize:10,fontWeight:700,color:"#14532d",textTransform:"uppercase",letterSpacing:".06em",marginBottom:8}}>Co√ªt r√©el</p>
                  <p style={{fontSize:24,fontWeight:700,color:"#16a34a"}}>{netDon} ‚Ç¨</p>
                </div>
              </div>
            )}
          </div>
        )}

        {/* √âtape 3 ‚Äî IBAN + option RDV */}
        {step===3 && (
          <div>
            <div style={{marginBottom:20}}>
              <h3 style={{fontSize:16,fontWeight:700,color:"#1a1a2e",marginBottom:4}}>Coordonn√©es bancaires</h3>
              <p style={{fontSize:12,color:"#6b7280"}}>Saisissez l'IBAN pour le pr√©l√®vement SEPA, ou programmez un rappel si l'adh√©rent ne l'a pas sur lui.</p>
            </div>

            {/* Toggle IBAN / RDV */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:20}}>
              <div onClick={()=>update("ibanDiffere",false)} style={{padding:"12px 14px",borderRadius:12,border:`2px solid ${!form.ibanDiffere?"#6d28d9":"#e5e7eb"}`,background:!form.ibanDiffere?"#f5f3ff":"white",cursor:"pointer",textAlign:"center",transition:"all .15s"}}>
                <div style={{fontSize:20,marginBottom:4}}>üè¶</div>
                <p style={{fontSize:13,fontWeight:700,color:!form.ibanDiffere?"#4c1d95":"#374151"}}>IBAN disponible</p>
                <p style={{fontSize:11,color:"#9ca3af"}}>Saisir maintenant</p>
              </div>
              <div onClick={()=>update("ibanDiffere",true)} style={{padding:"12px 14px",borderRadius:12,border:`2px solid ${form.ibanDiffere?"#f59e0b":"#e5e7eb"}`,background:form.ibanDiffere?"#fffbeb":"white",cursor:"pointer",textAlign:"center",transition:"all .15s"}}>
                <div style={{fontSize:20,marginBottom:4}}>üìÖ</div>
                <p style={{fontSize:13,fontWeight:700,color:form.ibanDiffere?"#92400e":"#374151"}}>Rappel √† programmer</p>
                <p style={{fontSize:11,color:"#9ca3af"}}>L'adh√©rent n'a pas l'IBAN</p>
              </div>
            </div>

            {!form.ibanDiffere ? (
              <div>
                <div style={{marginBottom:16}}>
                  <label style={lbl}>IBAN</label>
                  <div style={{position:"relative"}}>
                    <input value={form.iban} onChange={e=>update("iban",e.target.value)} placeholder="FR76 3000 6000 0112 3456 7890 189" style={{...inputS(!!errors.iban,form.ibanValid===true),fontFamily:"monospace",letterSpacing:".06em",paddingRight:48}}/>
                    {form.ibanValid!==null&&<div style={{position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",width:24,height:24,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:form.ibanValid?"#dcfce7":"#fee2e2",fontSize:12,fontWeight:700,color:form.ibanValid?"#16a34a":"#ef4444"}}>{form.ibanValid?"‚úì":"‚úó"}</div>}
                  </div>
                  {form.ibanValid===true&&<p style={{color:"#16a34a",fontSize:12,marginTop:6,fontWeight:600}}>IBAN valide ‚úì</p>}
                  {errors.iban&&<p style={{color:"#ef4444",fontSize:12,marginTop:6}}>{errors.iban}</p>}
                </div>
                <div>
                  <label style={lbl}>BIC / SWIFT</label>
                  <input value={form.bic} onChange={e=>update("bic",e.target.value)} placeholder="BNPAFRPP" style={{...inputS(false,false),fontFamily:"monospace",letterSpacing:".06em"}}/>
                </div>
              </div>
            ) : (
              <div style={{background:"#fffbeb",borderRadius:14,padding:18,border:"1px solid #fde68a"}}>
                <p style={{fontSize:13,fontWeight:700,color:"#92400e",marginBottom:14}}>üìû Programmer un rappel t√©l√©phonique</p>
                <div className="form-grid-2 recap-grid-2" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                  <div>
                    <label style={{...lbl,color:"#78350f"}}>Date du rappel</label>
                    <input type="date" value={form.rdvDate} onChange={e=>update("rdvDate",e.target.value)} min={new Date().toISOString().split("T")[0]} style={{...inputS(!!errors.rdvDate,false),background:errors.rdvDate?"#fff5f5":"white"}}/>
                    {errors.rdvDate&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.rdvDate}</p>}
                  </div>
                  <div>
                    <label style={{...lbl,color:"#78350f"}}>Heure</label>
                    <input type="time" value={form.rdvHeure} onChange={e=>update("rdvHeure",e.target.value)} style={{...inputS(!!errors.rdvHeure,false),background:errors.rdvHeure?"#fff5f5":"white"}}/>
                    {errors.rdvHeure&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.rdvHeure}</p>}
                  </div>
                </div>
                <div>
                  <label style={{...lbl,color:"#78350f"}}>Note pour le rappel <span style={{fontWeight:300,opacity:.6}}>(optionnel)</span></label>
                  <input value={form.rdvNote} onChange={e=>update("rdvNote",e.target.value)} placeholder="Ex : Rappeler en fin de journ√©e, pr√©f√®re le soir" style={{...inputS(false,false),background:"white"}}/>
                </div>
                <div style={{marginTop:12,background:"rgba(251,146,60,.12)",borderRadius:10,padding:"10px 14px"}}>
                  <p style={{fontSize:11,color:"#92400e",lineHeight:1.6}}>‚ö†Ô∏è Ce dossier sera marqu√© comme <strong>incomplet</strong> et appara√Ætra dans votre liste de rappels sur le tableau de bord.</p>
                </div>
              </div>
            )}
          </div>
        )}

        {/* √âtape 4 ‚Äî R√©cap complet */}
        {step===4 && (
          <div>
            {/* Coordonn√©es compl√®tes */}
            <div style={{background:"#f9fafb",borderRadius:14,padding:18,border:"1px solid #e5e7eb",marginBottom:12}}>
              <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>üë§ Coordonn√©es civiles</p>
              <div className="recap-cells" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"6px 24px"}}>
                {[
                  ["Nom",form.nom],["Pr√©nom",form.prenom],
                  ["Genre", form.sexe==="M"?"‚ôÇ Masculin":form.sexe==="F"?"‚ôÄ F√©minin":form.sexe==="A"?"‚öß Autre":"‚Äî"],
                  ["Date de naissance",form.dateNaissance?new Date(form.dateNaissance+"T00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"}):"‚Äî"],
                  ["Adresse",form.adresse],
                  ["Code postal",form.codePostal],["Ville",form.ville],
                  ["T√©l√©phone",form.telephone],["Email",form.email],
                ].map(([l,v]) => (
                  <div key={l} style={{padding:"5px 0",borderBottom:"1px solid #f3f4f6"}}><p style={{fontSize:10,color:"#9ca3af",marginBottom:2,fontWeight:700,textTransform:"uppercase"}}>{l}</p><p style={{fontSize:13,color:"#1a1a2e",fontWeight:500}}>{v||"‚Äî"}</p></div>
                ))}
              </div>
            </div>

            {/* RGPD */}
            <div style={{background:"#f9fafb",borderRadius:14,padding:18,border:"1px solid #e5e7eb",marginBottom:12}}>
              <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>üîí Consentements RGPD</p>
              <div style={{display:"flex",flexDirection:"column",gap:6}}>
                {[["Politique de confidentialit√©",form.consentRgpd],["Communications marketing",form.consentMarketing]].map(([l,v]) => (
                  <div key={l} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 0",borderBottom:"1px solid #f3f4f6"}}>
                    <span style={{fontSize:12,color:"#4b5563"}}>{l}</span>
                    <span style={{fontSize:12,fontWeight:700,padding:"2px 10px",borderRadius:20,background:v?"#dcfce7":"#f3f4f6",color:v?"#16a34a":"#9ca3af"}}>{v?"Accept√©":"Refus√©"}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Don */}
            <div className="form-grid-2 recap-grid-2" style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
              <div style={{background:"#f9fafb",borderRadius:14,padding:18,border:"1px solid #e5e7eb"}}>
                <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>üí∏ Don mensuel</p>
                {[
                  ["Montant",form.montantDon?`${parseFloat(form.montantDon).toFixed(2)} ‚Ç¨`:"Non renseign√©"],
                  ["R√©duction 66%",form.montantDon?`${defiscalisation} ‚Ç¨`:"‚Äî"],
                  ["Co√ªt r√©el net",form.montantDon?`${netDon} ‚Ç¨`:"‚Äî"],
                ].map(([l,v]) => (
                  <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #f3f4f6"}}><span style={{fontSize:12,color:"#6b7280"}}>{l}</span><span style={{fontSize:12,fontWeight:700,color:"#1a1a2e"}}>{v}</span></div>
                ))}
              </div>

              {/* Bancaire ou RDV */}
              <div style={{background: form.ibanDiffere?"#fffbeb":"#f9fafb",borderRadius:14,padding:18,border:`1px solid ${form.ibanDiffere?"#fde68a":"#e5e7eb"}`}}>
                {form.ibanDiffere ? (
                  <>
                    <p style={{fontSize:11,fontWeight:700,color:"#92400e",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>üìÖ Rappel programm√©</p>
                    {[
                      ["Date",form.rdvDate?new Date(form.rdvDate+"T00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"}):"‚Äî"],
                      ["Heure",form.rdvHeure||"‚Äî"],
                      ["Note",form.rdvNote||"‚Äî"],
                    ].map(([l,v]) => (
                      <div key={l} style={{padding:"5px 0",borderBottom:"1px solid #fde68a"}}><p style={{fontSize:10,color:"#d97706",marginBottom:2,fontWeight:700,textTransform:"uppercase"}}>{l}</p><p style={{fontSize:12,color:"#78350f",fontWeight:500}}>{v}</p></div>
                    ))}
                  </>
                ) : (
                  <>
                    <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>üè¶ Coordonn√©es bancaires</p>
                    {[["IBAN",form.iban],["BIC",form.bic]].map(([l,v]) => (
                      <div key={l} style={{padding:"5px 0",borderBottom:"1px solid #f3f4f6"}}><p style={{fontSize:10,color:"#9ca3af",marginBottom:2,fontWeight:700,textTransform:"uppercase"}}>{l}</p><p style={{fontSize:12,color:"#1a1a2e",fontFamily:"monospace"}}>{v||"‚Äî"}</p></div>
                    ))}
                  </>
                )}
              </div>
            </div>

            {/* Signature */}
            <div style={{marginBottom:16}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:10}}>
                <p style={{fontSize:14,fontWeight:700,color:"#1a1a2e"}}>‚úçÔ∏è Signature de l'adh√©rent</p>
                <button onClick={clearSignature} style={{fontSize:12,color:"#6d28d9",background:"#f5f3ff",border:"1px solid #ddd6fe",padding:"6px 16px",borderRadius:20,cursor:"pointer",fontFamily:font,fontWeight:600}}>üóë Effacer</button>
              </div>
              {/* Cadre de signature */}
              <div style={{border:"2px solid #c4b5fd",borderRadius:14,overflow:"hidden",background:"white",boxShadow:"0 4px 20px rgba(109,40,217,0.12)",position:"relative"}}>
                {/* Ligne de base */}
                <div style={{position:"absolute",bottom:44,left:20,right:20,borderBottom:"1px dashed #d1d5db",pointerEvents:"none",zIndex:1}}/>
                {/* Texte X */}
                <div style={{position:"absolute",bottom:32,left:20,color:"#9ca3af",fontSize:18,pointerEvents:"none",zIndex:1,lineHeight:1}}>‚úï</div>
                {/* Placeholder */}
                {!signature && (
                  <div style={{position:"absolute",top:"40%",left:"50%",transform:"translate(-50%,-50%)",color:"#d1d5db",fontSize:13,pointerEvents:"none",fontStyle:"italic",zIndex:1,textAlign:"center",userSelect:"none"}}>
                    Signez ici
                  </div>
                )}
                <canvas
                  ref={canvasRef}
                  width={800} height={200}
                  style={{width:"100%",height:200,display:"block",cursor:"crosshair",touchAction:"none"}}
                  onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw}
                  onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw}
                />
              </div>
              {!signature && <p style={{fontSize:11,color:"#9ca3af",marginTop:6,textAlign:"center",fontStyle:"italic"}}>Utilisez votre doigt ou la souris pour signer dans le cadre</p>}
              {signature && <p style={{fontSize:11,color:"#16a34a",marginTop:6,textAlign:"center",fontWeight:600}}>‚úì Signature enregistr√©e</p>}
            </div>
            {submitError&&<div style={{background:"#fef2f2",border:"1px solid #fecaca",borderRadius:10,padding:"12px 16px",marginBottom:12,color:"#991b1b",fontSize:13}}>{submitError}</div>}
            <button onClick={handleSubmit} disabled={submitting} style={{width:"100%",padding:"16px",borderRadius:14,border:"none",background:submitting?"#9ca3af":"linear-gradient(135deg,#1e1b4b,#6d28d9)",color:"white",fontSize:15,fontWeight:700,cursor:submitting?"not-allowed":"pointer",fontFamily:font,boxShadow:"0 6px 24px rgba(76,29,149,.4)"}}>
              {submitting?"Enregistrement‚Ä¶":"Valider et soumettre le dossier ‚úì"}
            </button>
          </div>
        )}

        {/* Nav */}
        <div style={{display:"flex",justifyContent:"space-between",marginTop:28,paddingTop:20,borderTop:"1px solid #f3f4f6"}}>
          <button onClick={prev} disabled={step===0} style={{padding:"11px 24px",borderRadius:11,border:"2px solid #e5e7eb",background:step===0?"#f9fafb":"white",color:step===0?"#d1d5db":"#374151",fontSize:13,fontWeight:600,cursor:step===0?"not-allowed":"pointer",fontFamily:font}}>Pr√©c√©dent</button>
          <span style={{fontSize:12,color:"#9ca3af",alignSelf:"center"}}>√âtape {step+1}/{steps.length}</span>
          {step<steps.length-1&&<button onClick={next} style={{padding:"11px 28px",borderRadius:11,border:"none",background:"linear-gradient(135deg,#4c1d95,#6d28d9)",color:"white",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:font,boxShadow:"0 4px 16px rgba(76,29,149,.35)"}}>Suivant</button>}
        </div>
      </div>
    );
  }

  // ‚îÄ‚îÄ COMPLETION PANEL ‚Äî Finalisation RIB ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function CompletionPanel({ adherent, onSuccess, onCancel }) {
    const [iban, setIban]           = useState("");
    const [bic, setBic]             = useState("");
    const [ibanValid, setIbanValid] = useState(null);
    const [error, setError]         = useState(null);
    const [submitting, setSubmitting] = useState(false);
    const [done, setDone]           = useState(false);

    function updateIban(v) {
      setIban(v);
      setIbanValid(isIBANComplete(v) ? validateIBAN(v) : null);
      setError(null);
    }

    async function handleSubmit() {
      if (!iban.trim()) { setError("L'IBAN est requis."); return; }
      if (ibanValid === false) { setError("IBAN invalide ‚Äî v√©rifiez les chiffres."); return; }
      if (ibanValid === null)  { setError("IBAN incomplet."); return; }
      setSubmitting(true); setError(null);
      try {
        // On ne touche PAS √† la signature ‚Äî elle appartient √† l'adh√©rent
        await supabaseUpdate("adherents", adherent.id, {
          iban,
          bic,
          incomplet: false,
          rdv_date: null,
          rdv_note: null,
        });
        setDone(true);
        setTimeout(() => onSuccess(), 1800);
      } catch(e) { setError("Erreur : " + e.message); }
      setSubmitting(false);
    }

    const inputS = (err, ok) => ({ border:`2px solid ${err?"#f87171":ok?"#22c55e":"#e2e8f0"}`, borderRadius:14, padding:"13px 16px", width:"100%", outline:"none", fontSize:14, fontFamily:font, background:err?"#fff5f5":ok?"#f0fdf4":"white", color:"#1a1a2e", boxSizing:"border-box" });
    const lbl = { fontSize:11, fontWeight:700, color:"#6b7280", display:"block", marginBottom:6, letterSpacing:".08em", textTransform:"uppercase" };
    const fmtDate = s => s ? new Date(s+"T00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"}) : "‚Äî";

    if (done) return (
      <div style={{textAlign:"center",padding:"60px 0"}}>
        <div style={{width:64,height:64,borderRadius:"50%",background:"#dcfce7",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px",fontSize:28,color:"#16a34a"}}>‚úì</div>
        <h3 style={{fontFamily:serif,fontSize:26,color:"#1a1a2e",marginBottom:8}}>Adh√©sion finalis√©e !</h3>
        <p style={{color:"#6b7280",fontSize:14}}>Le RIB est enregistr√© ‚Äî l'adh√©rent est maintenant actif.</p>
      </div>
    );

    return (
      <div>
        {/* En-t√™te identit√© */}
        <div style={{background:"linear-gradient(135deg,#1e1b4b,#4c1d95)",borderRadius:16,padding:"20px 24px",marginBottom:20,color:"white"}}>
          <div style={{display:"flex",alignItems:"center",gap:14}}>
            <div style={{width:48,height:48,borderRadius:14,background:"rgba(255,255,255,0.15)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0}}>üë§</div>
            <div>
              <h2 style={{fontFamily:serif,fontSize:22,fontWeight:600,marginBottom:2}}>{adherent.prenom} {adherent.nom}</h2>
              <p style={{fontSize:12,opacity:.7}}>N√©(e) le {fmtDate(adherent.date_naissance)} ¬∑ {adherent.ville}</p>
            </div>
            {adherent.montant_don && <div style={{marginLeft:"auto",textAlign:"right"}}>
              <p style={{fontSize:20,fontWeight:700,color:"#34d399"}}>{parseFloat(adherent.montant_don).toFixed(2)} ‚Ç¨</p>
              <p style={{fontSize:10,opacity:.6,textTransform:"uppercase",letterSpacing:".06em"}}>don mensuel</p>
            </div>}
          </div>
        </div>

        {/* R√©cap fiche */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:20}}>
          {[
            {title:"üìç Adresse",     items:[["Adresse",adherent.adresse],["CP / Ville",`${adherent.code_postal||""} ${adherent.ville||""}`]]},
            {title:"üìû Contact",     items:[["T√©l√©phone",adherent.telephone],["Email",adherent.email]]},
            {title:"üîí RGPD",        items:[["Confidentialit√©",adherent.consent_rgpd?"‚úÖ Accept√©":"‚ùå Refus√©"],["Marketing",adherent.consent_marketing?"‚úÖ Accept√©":"‚Äî"]]},
            {title:"üí∏ Don mensuel", items:[["Montant",adherent.montant_don?`${parseFloat(adherent.montant_don).toFixed(2)} ‚Ç¨`:"‚Äî"],["Co√ªt net",adherent.cout_net?`${parseFloat(adherent.cout_net).toFixed(2)} ‚Ç¨`:"‚Äî"]]},
          ].map(sec => (
            <div key={sec.title} style={{background:"#f9fafb",borderRadius:12,padding:"14px 16px",border:"1px solid #e5e7eb"}}>
              <p style={{fontSize:10,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:10}}>{sec.title}</p>
              {sec.items.map(([l,v]) => (
                <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px solid #f3f4f6"}}>
                  <span style={{fontSize:12,color:"#6b7280"}}>{l}</span>
                  <span style={{fontSize:12,fontWeight:600,color:"#1a1a2e",textAlign:"right",maxWidth:"60%",wordBreak:"break-all"}}>{v||"‚Äî"}</span>
                </div>
              ))}
            </div>
          ))}
        </div>

        {/* Signature originale ‚Äî lecture seule, non modifiable */}
        {adherent.signature && (
          <div style={{background:"#f9fafb",borderRadius:14,padding:"16px 18px",marginBottom:20,border:"1px solid #e5e7eb"}}>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
              <span style={{fontSize:14}}>‚úçÔ∏è</span>
              <p style={{fontSize:12,fontWeight:700,color:"#374151"}}>Signature de l'adh√©rent</p>
              <span style={{fontSize:11,padding:"2px 10px",borderRadius:20,background:"#dcfce7",color:"#16a34a",fontWeight:700,marginLeft:"auto"}}>‚úì Enregistr√©e</span>
            </div>
            <img src={adherent.signature} alt="Signature" style={{width:"100%",borderRadius:8,background:"white",padding:8,border:"1px solid #e5e7eb",maxHeight:100,objectFit:"contain"}}/>
            <p style={{fontSize:11,color:"#9ca3af",marginTop:6,fontStyle:"italic"}}>Signature recueillie lors de l'entretien ‚Äî elle ne peut pas √™tre modifi√©e par le recruteur.</p>
          </div>
        )}

        {/* Rappel d'origine */}
        {adherent.rdv_date && (
          <div style={{background:"#fffbeb",borderRadius:12,padding:"12px 16px",marginBottom:20,border:"1px solid #fde68a",display:"flex",gap:10,alignItems:"flex-start"}}>
            <span style={{fontSize:18}}>üìÖ</span>
            <div>
              <p style={{fontSize:12,fontWeight:700,color:"#92400e",marginBottom:2}}>Rappel d'origine</p>
              <p style={{fontSize:12,color:"#78350f"}}>{new Date(adherent.rdv_date).toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})} √† {new Date(adherent.rdv_date).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}</p>
              {adherent.rdv_note && <p style={{fontSize:11,color:"#d97706",marginTop:2,fontStyle:"italic"}}>"{adherent.rdv_note}"</p>}
            </div>
          </div>
        )}

        {/* S√©parateur */}
        <div style={{borderTop:"2px dashed #e5e7eb",margin:"4px 0 20px",position:"relative"}}>
          <span style={{position:"absolute",top:-11,left:"50%",transform:"translateX(-50%)",background:"#fafaf9",padding:"0 12px",fontSize:11,color:"#9ca3af",fontWeight:700,textTransform:"uppercase",letterSpacing:".08em"}}>RIB √† compl√©ter</span>
        </div>

        {/* IBAN */}
        <div style={{marginBottom:16}}>
          <label style={lbl}>IBAN *</label>
          <div style={{position:"relative"}}>
            <input value={iban} onChange={e=>updateIban(e.target.value)} placeholder="FR76 3000 6000 0112 3456 7890 189" style={{...inputS(!!error&&!iban,ibanValid===true),fontFamily:"monospace",letterSpacing:".06em",paddingRight:48}}/>
            {ibanValid!==null && <div style={{position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",width:24,height:24,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:ibanValid?"#dcfce7":"#fee2e2",fontSize:12,fontWeight:700,color:ibanValid?"#16a34a":"#ef4444"}}>{ibanValid?"‚úì":"‚úó"}</div>}
          </div>
          {ibanValid===true  && <p style={{color:"#16a34a",fontSize:12,marginTop:6,fontWeight:600}}>IBAN valide ‚úì</p>}
          {ibanValid===false && <p style={{color:"#ef4444",fontSize:12,marginTop:6}}>IBAN invalide ‚Äî v√©rifiez les chiffres</p>}
        </div>

        <div style={{marginBottom:20}}>
          <label style={lbl}>BIC / SWIFT</label>
          <input value={bic} onChange={e=>{setBic(e.target.value);setError(null);}} placeholder="BNPAFRPP" style={{...inputS(false,false),fontFamily:"monospace",letterSpacing:".06em"}}/>
        </div>

        {error && <div style={{background:"#fef2f2",border:"1px solid #fecaca",borderRadius:10,padding:"12px 16px",marginBottom:12,color:"#991b1b",fontSize:13}}>‚ö†Ô∏è {error}</div>}

        <div style={{display:"flex",gap:10}}>
          <button onClick={onCancel} style={{flex:1,padding:"14px",borderRadius:14,border:"2px solid #e5e7eb",background:"white",color:"#374151",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:font}}>‚Üê Retour</button>
          <button onClick={handleSubmit} disabled={submitting} style={{flex:2,padding:"14px",borderRadius:14,border:"none",background:submitting?"#9ca3af":"linear-gradient(135deg,#1e1b4b,#6d28d9)",color:"white",fontSize:14,fontWeight:700,cursor:submitting?"not-allowed":"pointer",fontFamily:font,boxShadow:"0 6px 24px rgba(76,29,149,.4)"}}>
            {submitting ? "Enregistrement‚Ä¶" : "Valider le RIB ‚Äî Finaliser l'adh√©sion ‚úì"}
          </button>
        </div>
      </div>
    );
  }

  // ‚îÄ‚îÄ GENDER BAR ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function GenderBar({ sexeStats, total, compact = false }) {
    if (!sexeStats || total === 0) return null;
    const { H, F, A, NR } = sexeStats;
    const pct = n => total > 0 ? Math.round(n / total * 100) : 0;
    const segments = [
      { key:"H", label:"‚ôÇ Hommes",  n:H, color:"#3b82f6", light:"rgba(59,130,246,.15)" },
      { key:"F", label:"‚ôÄ Femmes",  n:F, color:"#ec4899", light:"rgba(236,72,153,.15)" },
      { key:"A", label:"‚öß Autre",   n:A, color:"#8b5cf6", light:"rgba(139,92,246,.15)" },
      { key:"NR",label:"‚Äî N/R",     n:NR,color:"#6b7280", light:"rgba(107,114,128,.1)" },
    ].filter(s => s.n > 0);

    return (
      <div>
        {/* Barre empil√©e */}
        <div style={{display:"flex",borderRadius:8,overflow:"hidden",height:compact?18:28,marginBottom:compact?8:12,gap:1}}>
          {segments.map(s => (
            <div key={s.key} style={{width:`${pct(s.n)}%`,background:s.color,minWidth:s.n>0?4:0,transition:"width .6s",display:"flex",alignItems:"center",justifyContent:"center"}}>
              {!compact && pct(s.n) >= 12 && <span style={{fontSize:10,fontWeight:700,color:"white"}}>{pct(s.n)}%</span>}
            </div>
          ))}
        </div>
        {/* L√©gende */}
        <div style={{display:"flex",gap:compact?8:14,flexWrap:"wrap"}}>
          {segments.map(s => (
            <div key={s.key} style={{display:"flex",alignItems:"center",gap:5,background:s.light,padding:compact?"3px 8px":"4px 10px",borderRadius:20,border:`1px solid ${s.color}30`}}>
              <div style={{width:8,height:8,borderRadius:"50%",background:s.color,flexShrink:0}}/>
              <span style={{fontSize:compact?10:12,color:"rgba(255,255,255,0.7)",fontWeight:600}}>{s.label}</span>
              <span style={{fontSize:compact?10:12,fontWeight:700,color:"white"}}>{s.n}</span>
              <span style={{fontSize:compact?9:11,color:"rgba(255,255,255,0.4)"}}>({pct(s.n)}%)</span>
            </div>
          ))}
        </div>
      </div>
    );
  }

  // ‚îÄ‚îÄ STATS PANEL (accueil ‚Äî journ√©e uniquement) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function StatsPanel({ stats }) {
    if (!stats) return (
      <div style={{textAlign:"center",padding:40,color:"rgba(255,255,255,0.3)",fontSize:14}} className="loading-dot">
        Chargement des statistiques‚Ä¶
      </div>
    );
    const t = stats.todayStats || {};
    const todayCount = t.total || 0;

    return (
      <div style={{display:"flex",flexDirection:"column",gap:16}}>
        {/* Bandeau journ√©e */}
        <div style={{background:"rgba(167,139,250,.08)",border:"1px solid rgba(124,58,237,.25)",borderRadius:16,padding:"14px 20px",display:"flex",alignItems:"center",gap:10}}>
          <span style={{fontSize:18}}>üìÖ</span>
          <p style={{fontSize:13,color:"rgba(255,255,255,0.6)",lineHeight:1.5}}>
            Statistiques de <strong style={{color:"white"}}>la journ√©e en cours</strong> ‚Äî {new Date().toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})}
          </p>
        </div>

        <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:16}} className="stats-grid-3">
          {/* Adh√©rents aujourd'hui */}
          <div className="card fade-in" style={{textAlign:"center"}}>
            <div style={{fontSize:26,marginBottom:10}}>üìã</div>
            <div className="stat-value" style={{color:"#a78bfa"}}>{todayCount}</div>
            <div className="stat-label">Adh√©rents aujourd'hui</div>
          </div>

          {/* √Çge moyen + m√©dian dans la m√™me carte */}
          <div className="card fade-in" style={{textAlign:"center"}}>
            <div style={{fontSize:26,marginBottom:10}}>üéÇ</div>
            <div className="stat-value" style={{color:"#60a5fa"}}>
              {t.avgAge!=null?t.avgAge.toFixed(1):"‚Äî"}<span style={{fontSize:16,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:4}}>ans</span>
            </div>
            <div className="stat-label">√Çge moyen</div>
            <div style={{marginTop:8,paddingTop:8,borderTop:"1px solid rgba(255,255,255,0.06)"}}>
              <div style={{fontFamily:"'Cormorant Garamond',serif",fontSize:22,fontWeight:700,color:"#818cf8",lineHeight:1}}>
                {t.medianAge!=null?t.medianAge.toFixed(0):"‚Äî"}<span style={{fontSize:13,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:3}}>ans</span>
              </div>
              <div style={{fontSize:10,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.3)",marginTop:4}}>√Çge m√©dian</div>
            </div>
          </div>

          {/* Don moyen */}
          <div className="card fade-in" style={{textAlign:"center"}}>
            <div style={{fontSize:26,marginBottom:10}}>üí∏</div>
            <div className="stat-value" style={{color:"#34d399"}}>
              {t.avgDon!=null?t.avgDon.toFixed(2):"‚Äî"}<span style={{fontSize:16,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:4}}>‚Ç¨</span>
            </div>
            <div className="stat-label">Don moyen mensuel</div>
          </div>

          {/* Adh/heure journ√©e */}
          <div className="card fade-in" style={{textAlign:"center"}}>
            <div style={{fontSize:26,marginBottom:10}}>‚è±Ô∏è</div>
            <div className="stat-value" style={{color:"#fb923c"}}>
              {(todayCount/6).toFixed(2)}<span style={{fontSize:16,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:4}}>/ h</span>
            </div>
            <div className="stat-label">Adh / heure (aujourd'hui)</div>
          </div>

          {/* Volume total journ√©e */}
          <div className="card fade-in" style={{textAlign:"center"}}>
            <div style={{fontSize:26,marginBottom:10}}>üí∞</div>
            <div className="stat-value" style={{color:"#fbbf24"}}>
              {t.totalDons?t.totalDons.toFixed(2):"0.00"}<span style={{fontSize:16,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:4}}>‚Ç¨</span>
            </div>
            <div className="stat-label">Volume journ√©e</div>
          </div>

          {/* Comparatif mission */}
          <div className="card fade-in" style={{textAlign:"center",background:"rgba(129,140,248,.06)",borderColor:"rgba(129,140,248,.2)"}}>
            <div style={{fontSize:26,marginBottom:10}}>üë•</div>
            <div className="stat-value" style={{color:"#818cf8"}}>{stats.total}</div>
            <div className="stat-label">Total mission</div>
          </div>
        </div>

        {/* Note base calcul */}
        <div className="card" style={{background:"rgba(251,146,60,.08)",borderColor:"rgba(251,146,60,.2)"}}>
          <p style={{fontSize:11,fontWeight:700,color:"rgba(251,146,60,.7)",letterSpacing:".08em",textTransform:"uppercase",marginBottom:6}}>Base de calcul</p>
          <p style={{fontSize:13,color:"rgba(255,255,255,0.5)",lineHeight:1.7}}>
            Le ratio <strong style={{color:"rgba(255,255,255,0.8)"}}>adh / heure</strong> est calcul√© sur <strong style={{color:"rgba(255,255,255,0.8)"}}>6 heures effectives</strong> de terrain. Aujourd'hui : <strong style={{color:"#fb923c"}}>{(todayCount/6).toFixed(2)} adh/h</strong> ‚Äî Mission compl√®te : <strong style={{color:"#818cf8"}}>{stats.perHour.toFixed(2)} adh/h</strong>.
          </p>
        </div>

        {/* Genre journ√©e */}
        {t.sexeStats && t.total > 0 && (
          <div className="card" style={{background:"rgba(255,255,255,0.03)"}}>
            <p style={{fontSize:11,fontWeight:700,color:"rgba(255,255,255,0.4)",letterSpacing:".08em",textTransform:"uppercase",marginBottom:12}}>‚ö• R√©partition H/F ‚Äî aujourd'hui</p>
            <GenderBar sexeStats={t.sexeStats} total={t.total} compact={false}/>
          </div>
        )}
      </div>
    );
  }
  function App() {
    const [currentUser, setCurrentUser] = useState(() => {
      try { return JSON.parse(sessionStorage.getItem("collecteur")); } catch { return null; }
    });
    const [page, setPage]             = useState("dashboard");
    const [stats, setStats]           = useState(null);
    const [statsError, setStatsError] = useState(null);
    const [rappels, setRappels]       = useState([]);
    const [rappelSelected, setRappelSelected] = useState(null);

    useEffect(() => { if (currentUser) loadStats(); }, [currentUser]);

    async function deleteRappel(id) {
      try {
        await supabaseDelete("adherents", id);
        setRappels(prev => prev.filter(r => r.id !== id));
      } catch(e) { alert("Erreur suppression : " + e.message); }
    }

    async function loadStats() {
      try {
        const rows = await supabaseFetch("adherents", `&collecteur_id=eq.${currentUser.id}`);
        const incomplets = rows.filter(r => r.incomplet === true);
        const adherents  = rows.filter(r => !r.incomplet);

        const todayStr = new Date().toISOString().split("T")[0];
        const todayAdh = adherents.filter(r => r.created_at && r.created_at.startsWith(todayStr));

        function computeStats(list) {
          const total = list.length;
          const ages = list.map(r => calcAge(r.date_naissance)).filter(a => a!==null && a>0 && a<120);
          const avgAge = ages.length>0 ? ages.reduce((s,a)=>s+a,0)/ages.length : null;
          const sorted = [...ages].sort((a,b)=>a-b);
          const medianAge = sorted.length>0
            ? (sorted.length%2===0
                ? (sorted[sorted.length/2-1]+sorted[sorted.length/2])/2
                : sorted[Math.floor(sorted.length/2)])
            : null;
          const dons = list.map(r=>parseFloat(r.montant_don)).filter(d=>!isNaN(d)&&d>0);
          const avgDon = dons.length>0 ? dons.reduce((s,d)=>s+d,0)/dons.length : null;
          const totalDons = dons.reduce((s,d)=>s+d,0);
          const perHour = total / 6;
          const ageTranches = [
            { label:"18‚Äì25", min:18, max:25, color:"#a78bfa" },
            { label:"26‚Äì35", min:26, max:35, color:"#60a5fa" },
            { label:"36‚Äì45", min:36, max:45, color:"#34d399" },
            { label:"46‚Äì57", min:46, max:57, color:"#fbbf24" },
            { label:"58‚Äì69", min:58, max:69, color:"#fb923c" },
            { label:"70‚Äì99", min:70, max:99, color:"#f472b6" },
          ].map(t => ({ ...t, value: ages.filter(a=>a>=t.min&&a<=t.max).length }));
          const donTranches = [
            { label:"10‚Äì15‚Ç¨",  color:"#a78bfa", value: list.filter(r=>r.montant_don>=10&&r.montant_don<15).length },
            { label:"15‚Äì20‚Ç¨",  color:"#60a5fa", value: list.filter(r=>r.montant_don>=15&&r.montant_don<20).length },
            { label:"20‚Äì25‚Ç¨",  color:"#34d399", value: list.filter(r=>r.montant_don>=20&&r.montant_don<25).length },
            { label:"25‚Äì30‚Ç¨",  color:"#fbbf24", value: list.filter(r=>r.montant_don>=25&&r.montant_don<30).length },
            { label:"30‚Äì35‚Ç¨",  color:"#fb923c", value: list.filter(r=>r.montant_don>=30&&r.montant_don<35).length },
            { label:"35‚Äì40‚Ç¨",  color:"#f472b6", value: list.filter(r=>r.montant_don>=35&&r.montant_don<40).length },
            { label:"40‚Äì50‚Ç¨",  color:"#f87171", value: list.filter(r=>r.montant_don>=40&&r.montant_don<50).length },
            { label:"50‚Ç¨+",    color:"#4ade80", value: list.filter(r=>r.montant_don>=50).length },
          ];
          const nbH = list.filter(r=>r.sexe==="M").length;
          const nbF = list.filter(r=>r.sexe==="F").length;
          const nbA = list.filter(r=>r.sexe==="A").length;
          const nbNR = total - nbH - nbF - nbA;
          const sexeStats = { H:nbH, F:nbF, A:nbA, NR:nbNR };
          return { total, avgAge, medianAge, avgDon, totalDons, perHour, ageTranches, donTranches, sexeStats };
        }

        const todaySt = computeStats(todayAdh);
        const allSt   = computeStats(adherents);

        setStats({
          today: todaySt.total,
          todayStats: todaySt,
          allStats:   allSt,
          // legacy fields for components that use stats.total etc.
          total: allSt.total,
          avgAge: allSt.avgAge,
          medianAge: allSt.medianAge,
          avgDon: allSt.avgDon,
          totalDons: allSt.totalDons,
          perHour: allSt.perHour,
          ageTranches: allSt.ageTranches,
          donTranches: allSt.donTranches,
        });
        setRappels(incomplets);
      } catch(e) { setStatsError(e.message); }
    }

    function handleLogout() {
      sessionStorage.removeItem("collecteur");
      setCurrentUser(null);
      setStats(null);
    }

    if (!currentUser) return <LoginScreen onLogin={user => setCurrentUser(user)} />;

    return (
      <div style={{minHeight:"100vh",display:"flex",flexDirection:"column"}}>
        {/* HEADER */}
        <header style={{background:"rgba(255,255,255,0.03)",borderBottom:"1px solid rgba(255,255,255,0.07)",padding:"0 32px",height:64,display:"flex",alignItems:"center",justifyContent:"space-between",position:"sticky",top:0,zIndex:100,backdropFilter:"blur(12px)"}}>
          <div style={{display:"flex",alignItems:"center",gap:28}}>
            <span style={{fontFamily:serif,fontSize:20,color:"white",fontWeight:600}}>üéØ Collecteur</span>
            <nav className="desktop-header-nav" style={{display:"flex",gap:4}}>
              {[
                {key:"dashboard",label:"Accueil",icon:"üè†"},
                {key:"don",label:"Nouvelle fiche",icon:"üìã"},
                {key:"stats",label:"Statistiques",icon:"üìä"},
                {key:"rappels",label:"Rappels",icon:"üìû",badge:rappels.length},
              ].map(n => (
                <button key={n.key} onClick={()=>{setPage(n.key);setRappelSelected(null);}} className={`nav-link${page===n.key?" active":""}`} style={{background:page===n.key?"rgba(124,58,237,.2)":undefined,position:"relative"}}>
                  {n.icon} {n.label}
                  {n.badge > 0 && <span style={{position:"absolute",top:2,right:2,width:16,height:16,borderRadius:"50%",background:"#ef4444",color:"white",fontSize:9,fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center",lineHeight:1}}>{n.badge}</span>}
                </button>
              ))}
            </nav>
          </div>
          <div className="desktop-header-right" style={{display:"flex",alignItems:"center",gap:10}}>
            <span className="badge badge-purple">üë§ {currentUser.prenom} {currentUser.nom}</span>
            <a href="register.html" className="btn-ghost">Cr√©er un compte</a>
            <button onClick={handleLogout} style={{fontSize:13,padding:"8px 14px",borderRadius:10,border:"1px solid rgba(239,68,68,.3)",background:"rgba(239,68,68,.08)",color:"#f87171",fontFamily:font,fontWeight:600,cursor:"pointer"}}>D√©connexion</button>
          </div>
          {/* Mobile header right */}
          <div style={{display:"flex",alignItems:"center",gap:8}} className="mobile-header-right">
            <span style={{fontSize:13,color:"rgba(255,255,255,0.5)",fontWeight:600,maxWidth:120,overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"}}>{currentUser.prenom}</span>
            <button onClick={handleLogout} style={{fontSize:11,padding:"6px 10px",borderRadius:8,border:"1px solid rgba(239,68,68,.3)",background:"rgba(239,68,68,.08)",color:"#f87171",fontFamily:font,fontWeight:600,cursor:"pointer"}}>‚úï</button>
          </div>
        </header>

        {/* MOBILE BOTTOM NAV */}
        <nav className="mobile-nav">
          <div className="mobile-nav-items">
            {[
              {key:"dashboard",label:"Accueil",icon:"üè†"},
              {key:"don",label:"Fiche",icon:"üìã"},
              {key:"stats",label:"Stats",icon:"üìä"},
              {key:"rappels",label:"Rappels",icon:"üìû",badge:rappels.length},
            ].map(n => (
              <button key={n.key} onClick={()=>{setPage(n.key);setRappelSelected(null);}} className={`mobile-nav-btn${page===n.key?" active":""}`}>
                {n.badge > 0 && <span className="mobile-nav-badge">{n.badge}</span>}
                <span className="nav-icon">{n.icon}</span>
                <span className="nav-label">{n.label}</span>
              </button>
            ))}
          </div>
        </nav>

        {/* MAIN */}
        <main style={{flex:1,maxWidth:1100,margin:"0 auto",width:"100%",padding:"36px 24px"}}>

          {page==="dashboard" && (
            <div className="fade-in">
              <div style={{marginBottom:36}}>
                <h1 style={{fontFamily:serif,fontSize:40,color:"white",fontWeight:600,marginBottom:8}}>Bonjour, {currentUser.prenom} üëã</h1>
                <p style={{color:"rgba(255,255,255,0.5)",fontSize:15}}>Voici un aper√ßu de votre activit√© de collecte.</p>
              </div>

              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,marginBottom:36,maxWidth:760}} className="dashboard-grid">
                <button onClick={()=>setPage("don")} style={{background:"linear-gradient(135deg,#1e1b4b,#4c1d95,#6d28d9)",border:"none",borderRadius:20,padding:"32px 24px",cursor:"pointer",textAlign:"left",color:"white",fontFamily:font,transition:"transform .2s",boxShadow:"0 8px 32px rgba(76,29,149,.35)"}} onMouseEnter={e=>e.currentTarget.style.transform="translateY(-3px)"} onMouseLeave={e=>e.currentTarget.style.transform=""}>
                  <div style={{fontSize:32,marginBottom:14}}>üìã</div>
                  <h3 style={{fontSize:18,fontWeight:700,marginBottom:6}}>Nouvelle fiche de don</h3>
                  <p style={{fontSize:13,color:"rgba(255,255,255,0.6)",lineHeight:1.5}}>Enregistrer un nouvel adh√©rent avec coordonn√©es, RGPD, don et signature.</p>
                </button>
                <button onClick={()=>setPage("stats")} style={{background:"rgba(255,255,255,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:20,padding:"24px",cursor:"pointer",textAlign:"left",color:"white",fontFamily:font,transition:"all .2s"}} onMouseEnter={e=>{e.currentTarget.style.background="rgba(124,58,237,.1)";e.currentTarget.style.borderColor="rgba(124,58,237,.4)";}} onMouseLeave={e=>{e.currentTarget.style.background="rgba(255,255,255,0.04)";e.currentTarget.style.borderColor="rgba(255,255,255,0.1)";}}>
                  <div style={{display:"flex",justifyContent:"space-between",alignItems:"flex-start",marginBottom:12}}>
                    <div style={{fontSize:24}}>ü•ß</div>
                    <span style={{fontSize:11,color:"rgba(255,255,255,0.3)",fontWeight:600,textTransform:"uppercase",letterSpacing:".06em"}}>Voir d√©tails ‚Üí</span>
                  </div>
                  <h3 style={{fontSize:16,fontWeight:700,marginBottom:10}}>Mes statistiques</h3>
                  {stats && stats.ageTranches ? (
                    <div style={{pointerEvents:"none"}}>
                      <PieChart data={stats.ageTranches} size={120}/>
                    </div>
                  ) : (
                    <p style={{fontSize:12,color:"rgba(255,255,255,0.35)"}}>Chargement‚Ä¶</p>
                  )}
                </button>
                {rappels.length > 0 && (
                  <button onClick={()=>setPage("rappels")} style={{background:"rgba(251,146,60,.08)",border:"1px solid rgba(251,146,60,.3)",borderRadius:20,padding:"24px",cursor:"pointer",textAlign:"left",color:"white",fontFamily:font,transition:"all .2s",display:"flex",alignItems:"center",gap:16,gridColumn:"1/-1"}} onMouseEnter={e=>{e.currentTarget.style.background="rgba(251,146,60,.15)";}} onMouseLeave={e=>{e.currentTarget.style.background="rgba(251,146,60,.08)";}}>
                    <div style={{width:44,height:44,borderRadius:12,background:"rgba(251,146,60,.15)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0}}>üìû</div>
                    <div>
                      <h3 style={{fontSize:16,fontWeight:700,marginBottom:4,color:"#fb923c"}}>{rappels.length} dossier{rappels.length>1?"s":""} √† rappeler</h3>
                      <p style={{fontSize:12,color:"rgba(255,255,255,0.45)"}}>Des adh√©rents attendent leur RIB ‚Äî cliquez pour finaliser</p>
                    </div>
                    <span style={{marginLeft:"auto",fontSize:18,color:"rgba(251,146,60,.6)"}}>‚Üí</span>
                  </button>
                )}
              </div>

              {statsError && <div style={{background:"rgba(239,68,68,.15)",border:"1px solid rgba(239,68,68,.3)",borderRadius:12,padding:"14px 18px",color:"#f87171",fontSize:13,marginBottom:20}}>{statsError}</div>}
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
                  <h2 style={{fontFamily:serif,fontSize:24,color:"white"}}>Mes statistiques</h2>
                  <button onClick={loadStats} style={{fontSize:12,color:"rgba(255,255,255,0.4)",background:"none",border:"none",cursor:"pointer",fontFamily:font}}>üîÑ Actualiser</button>
                </div>
                <StatsPanel stats={stats}/>
              </div>
            </div>
          )}

          {/* ADMIN FLOATING BUTTON */}
          <a href="admin.html" title="Espace Admin" className="admin-btn-side" style={{position:"fixed",right:0,top:"50%",transform:"translateY(-50%)",writingMode:"vertical-rl",textOrientation:"mixed",background:"rgba(15,14,26,0.85)",border:"1px solid rgba(124,58,237,.25)",borderRight:"none",borderRadius:"10px 0 0 10px",padding:"14px 8px",color:"rgba(255,255,255,0.25)",fontSize:11,fontFamily:font,fontWeight:600,textDecoration:"none",letterSpacing:".1em",backdropFilter:"blur(8px)",transition:"all .2s",zIndex:200}} onMouseEnter={e=>{e.currentTarget.style.color="rgba(167,139,250,0.8)";e.currentTarget.style.borderColor="rgba(124,58,237,.5)";e.currentTarget.style.background="rgba(124,58,237,.12)";}} onMouseLeave={e=>{e.currentTarget.style.color="rgba(255,255,255,0.25)";e.currentTarget.style.borderColor="rgba(124,58,237,.25)";e.currentTarget.style.background="rgba(15,14,26,0.85)";}}>‚öô ADMIN</a>

          {page==="stats" && (
            <div className="fade-in">
              <div style={{marginBottom:32}}>
                <button onClick={()=>setPage("dashboard")} style={{background:"none",border:"none",color:"rgba(255,255,255,0.4)",cursor:"pointer",fontFamily:font,fontSize:13,padding:0,marginBottom:16}}>‚Üê Retour</button>
                <h1 style={{fontFamily:serif,fontSize:40,color:"white",fontWeight:600,marginBottom:8}}>üìä Mes statistiques</h1>
                <p style={{color:"rgba(255,255,255,0.5)",fontSize:15}}>Analyse d√©taill√©e de votre activit√© de collecte</p>
              </div>

              {!stats ? (
                <div style={{textAlign:"center",padding:60,color:"rgba(255,255,255,0.3)"}} className="loading-dot">Chargement‚Ä¶</div>
              ) : (
                <div>
                  {/* Bandeau scope */}
                  <div style={{background:"rgba(129,140,248,.08)",border:"1px solid rgba(129,140,248,.2)",borderRadius:14,padding:"12px 18px",marginBottom:24,display:"flex",alignItems:"center",gap:10}}>
                    <span style={{fontSize:16}}>üìä</span>
                    <p style={{fontSize:13,color:"rgba(255,255,255,0.6)"}}>Statistiques <strong style={{color:"white"}}>de toute la mission</strong> ‚Äî tous les adh√©rents depuis le d√©but</p>
                  </div>

                  {/* KPIs mission totale */}
                  <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:16,marginBottom:28}} className="kpi-grid">
                    {/* Adh√©rents mission */}
                    <div className="card" style={{textAlign:"center",padding:24}}>
                      <div style={{fontSize:24,marginBottom:8}}>üë•</div>
                      <div style={{fontFamily:serif,fontSize:32,fontWeight:700,color:"#818cf8",lineHeight:1}}>{stats.allStats.total}</div>
                      <div style={{fontSize:11,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.4)",marginTop:8}}>Total mission</div>
                    </div>

                    {/* √Çge moyen + m√©dian empil√©s */}
                    <div className="card" style={{textAlign:"center",padding:24}}>
                      <div style={{fontSize:24,marginBottom:8}}>üéÇ</div>
                      <div style={{fontFamily:serif,fontSize:32,fontWeight:700,color:"#fb923c",lineHeight:1}}>
                        {stats.allStats.avgAge!=null?stats.allStats.avgAge.toFixed(1):"‚Äî"}<span style={{fontSize:14,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:3}}>ans</span>
                      </div>
                      <div style={{fontSize:11,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.4)",marginTop:6}}>√Çge moyen</div>
                      {/* M√©dian en dessous */}
                      <div style={{marginTop:10,paddingTop:10,borderTop:"1px solid rgba(255,255,255,0.06)"}}>
                        <div style={{fontFamily:serif,fontSize:24,fontWeight:700,color:"#818cf8",lineHeight:1}}>
                          {stats.allStats.medianAge!=null?stats.allStats.medianAge.toFixed(0):"‚Äî"}<span style={{fontSize:13,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:3}}>ans</span>
                        </div>
                        <div style={{fontSize:10,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.3)",marginTop:4}}>√Çge m√©dian</div>
                      </div>
                    </div>

                    {/* Don moyen */}
                    <div className="card" style={{textAlign:"center",padding:24}}>
                      <div style={{fontSize:24,marginBottom:8}}>üí∏</div>
                      <div style={{fontFamily:serif,fontSize:32,fontWeight:700,color:"#34d399",lineHeight:1}}>
                        {stats.allStats.avgDon!=null?stats.allStats.avgDon.toFixed(2):"‚Äî"}<span style={{fontSize:14,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:3}}>‚Ç¨</span>
                      </div>
                      <div style={{fontSize:11,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.4)",marginTop:8}}>Don moyen mensuel</div>
                    </div>

                    {/* Volume total */}
                    <div className="card" style={{textAlign:"center",padding:24}}>
                      <div style={{fontSize:24,marginBottom:8}}>üí∞</div>
                      <div style={{fontFamily:serif,fontSize:32,fontWeight:700,color:"#60a5fa",lineHeight:1}}>
                        {stats.allStats.totalDons?stats.allStats.totalDons.toFixed(2):"0.00"}<span style={{fontSize:14,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:3}}>‚Ç¨</span>
                      </div>
                      <div style={{fontSize:11,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.4)",marginTop:8}}>Volume total mensuel</div>
                    </div>

                    {/* Adh/h mission */}
                    <div className="card" style={{textAlign:"center",padding:24}}>
                      <div style={{fontSize:24,marginBottom:8}}>‚è±Ô∏è</div>
                      <div style={{fontFamily:serif,fontSize:32,fontWeight:700,color:"#fbbf24",lineHeight:1}}>
                        {stats.allStats.perHour.toFixed(2)}<span style={{fontSize:14,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:3}}>/h</span>
                      </div>
                      <div style={{fontSize:11,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.4)",marginTop:8}}>Adh / heure (mission)</div>
                    </div>

                    {/* Adh/h journ√©e */}
                    <div className="card" style={{textAlign:"center",padding:24,background:"rgba(167,139,250,.06)",borderColor:"rgba(124,58,237,.25)"}}>
                      <div style={{fontSize:24,marginBottom:8}}>üìÖ</div>
                      <div style={{fontFamily:serif,fontSize:32,fontWeight:700,color:"#a78bfa",lineHeight:1}}>
                        {(stats.todayStats.perHour).toFixed(2)}<span style={{fontSize:14,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:3}}>/h</span>
                      </div>
                      <div style={{fontSize:11,fontWeight:700,letterSpacing:".08em",textTransform:"uppercase",color:"rgba(255,255,255,0.4)",marginTop:8}}>Adh / heure (aujourd'hui)</div>
                    </div>
                  </div>

                  {/* Progression journ√©e vs mission */}
                  <div className="card" style={{marginBottom:28,background:"rgba(167,139,250,.06)",borderColor:"rgba(124,58,237,.2)"}}>
                    <h3 style={{fontFamily:serif,fontSize:18,color:"white",marginBottom:16}}>üìÖ Journ√©e en cours vs Mission totale</h3>
                    <div style={{display:"flex",gap:24,alignItems:"center",flexWrap:"wrap"}}>
                      <div style={{flex:1,minWidth:200}}>
                        <div style={{display:"flex",justifyContent:"space-between",marginBottom:6}}>
                          <span style={{fontSize:12,color:"rgba(255,255,255,0.5)"}}>Aujourd'hui</span>
                          <span style={{fontSize:12,fontWeight:700,color:"#a78bfa"}}>{stats.todayStats.total} adh.</span>
                        </div>
                        <div style={{background:"rgba(255,255,255,0.06)",borderRadius:8,height:10,overflow:"hidden"}}>
                          <div style={{height:"100%",background:"#a78bfa",borderRadius:8,width:`${stats.allStats.total>0?Math.min(100,(stats.todayStats.total/stats.allStats.total)*100):0}%`,transition:"width .6s"}}/>
                        </div>
                        <div style={{display:"flex",justifyContent:"space-between",marginTop:8}}>
                          <span style={{fontSize:12,color:"rgba(255,255,255,0.5)"}}>Mission totale</span>
                          <span style={{fontSize:12,fontWeight:700,color:"#818cf8"}}>{stats.allStats.total} adh.</span>
                        </div>
                        <div style={{background:"rgba(255,255,255,0.06)",borderRadius:8,height:10,overflow:"hidden",marginTop:6}}>
                          <div style={{height:"100%",background:"#818cf8",borderRadius:8,width:"100%"}}/>
                        </div>
                        <div style={{display:"flex",justifyContent:"space-between",marginTop:12,gap:16,flexWrap:"wrap"}}>
                          <div style={{fontSize:12,color:"rgba(255,255,255,0.45)"}}>‚è±Ô∏è Journ√©e : <strong style={{color:"#a78bfa"}}>{stats.todayStats.perHour.toFixed(2)} adh/h</strong></div>
                          <div style={{fontSize:12,color:"rgba(255,255,255,0.45)"}}>‚è±Ô∏è Mission : <strong style={{color:"#fbbf24"}}>{stats.allStats.perHour.toFixed(2)} adh/h</strong></div>
                        </div>
                      </div>
                      <div style={{display:"flex",gap:20,flexShrink:0}}>
                        <div style={{textAlign:"center"}}>
                          <div style={{fontFamily:serif,fontSize:40,fontWeight:700,color:"#a78bfa",lineHeight:1}}>{stats.todayStats.total}</div>
                          <div style={{fontSize:10,color:"rgba(255,255,255,0.35)",fontWeight:700,textTransform:"uppercase",marginTop:4}}>Aujourd'hui</div>
                        </div>
                        <div style={{width:1,background:"rgba(255,255,255,0.08)"}}/>
                        <div style={{textAlign:"center"}}>
                          <div style={{fontFamily:serif,fontSize:40,fontWeight:700,color:"#818cf8",lineHeight:1}}>{stats.allStats.total}</div>
                          <div style={{fontSize:10,color:"rgba(255,255,255,0.35)",fontWeight:700,textTransform:"uppercase",marginTop:4}}>Mission</div>
                        </div>
                      </div>
                    </div>
                  </div>

                  {/* Camembert √¢ges + Barres dons ‚Äî bas√©s sur la mission compl√®te */}
                  <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:20,marginBottom:28}} className="stats-grid-2">
                    <div className="card">
                      <h3 style={{fontFamily:serif,fontSize:20,color:"white",marginBottom:4}}>üéÇ R√©partition par √¢ge</h3>
                      <p style={{fontSize:11,color:"rgba(255,255,255,0.3)",marginBottom:16}}>Mission compl√®te</p>
                      {stats.allStats.ageTranches && <PieChart data={stats.allStats.ageTranches} size={160}/>}
                    </div>
                    <div className="card">
                      <h3 style={{fontFamily:serif,fontSize:20,color:"white",marginBottom:4}}>üí∏ R√©partition par don</h3>
                      <p style={{fontSize:11,color:"rgba(255,255,255,0.3)",marginBottom:16}}>Mission compl√®te</p>
                      {stats.allStats.donTranches && <BarChart data={stats.allStats.donTranches}/>}
                    </div>
                  </div>

                  {/* R√©partition genre ‚Äî mission */}
                  <div className="card" style={{marginBottom:28}}>
                    <h3 style={{fontFamily:serif,fontSize:20,color:"white",marginBottom:4}}>‚ö• R√©partition Homme / Femme</h3>
                    <p style={{fontSize:11,color:"rgba(255,255,255,0.3)",marginBottom:16}}>Mission compl√®te</p>
                    {stats.allStats.sexeStats && stats.allStats.total > 0 ? (
                      <div>
                        <GenderBar sexeStats={stats.allStats.sexeStats} total={stats.allStats.total} compact={false}/>
                        {/* Comparatif journ√©e si donn√©es dispo */}
                        {stats.todayStats.total > 0 && stats.todayStats.sexeStats && (
                          <div style={{marginTop:16,paddingTop:16,borderTop:"1px solid rgba(255,255,255,0.06)"}}>
                            <p style={{fontSize:11,fontWeight:700,color:"rgba(167,139,250,.6)",textTransform:"uppercase",letterSpacing:".08em",marginBottom:10}}>Aujourd'hui</p>
                            <GenderBar sexeStats={stats.todayStats.sexeStats} total={stats.todayStats.total} compact={true}/>
                          </div>
                        )}
                      </div>
                    ) : (
                      <p style={{fontSize:13,color:"rgba(255,255,255,0.3)",fontStyle:"italic"}}>Aucune donn√©e de genre disponible ‚Äî renseignez le genre lors des prochaines saisies.</p>
                    )}
                  </div>

                  {/* Rappels en attente */}
                  {rappels.length > 0 && (
                    <div className="card" style={{background:"rgba(251,146,60,.06)",borderColor:"rgba(251,146,60,.2)"}}>
                      <div style={{display:"flex",justifyContent:"space-between",alignItems:"center"}}>
                        <div>
                          <p style={{fontSize:11,fontWeight:700,color:"rgba(251,146,60,.7)",textTransform:"uppercase",letterSpacing:".08em",marginBottom:4}}>Dossiers incomplets</p>
                          <p style={{fontFamily:serif,fontSize:28,fontWeight:700,color:"#fb923c"}}>{rappels.length} <span style={{fontSize:16,fontWeight:400,color:"rgba(255,255,255,0.4)"}}>en attente de RIB</span></p>
                        </div>
                        <button onClick={()=>setPage("rappels")} style={{padding:"12px 20px",borderRadius:12,border:"1px solid rgba(251,146,60,.4)",background:"rgba(251,146,60,.1)",color:"#fb923c",cursor:"pointer",fontFamily:font,fontSize:13,fontWeight:700}}>Voir les rappels ‚Üí</button>
                      </div>
                    </div>
                  )}

                  {/* Base de calcul */}
                  <div className="card" style={{marginTop:16,background:"rgba(251,146,60,.08)",borderColor:"rgba(251,146,60,.2)"}}>
                    <p style={{fontSize:11,fontWeight:700,color:"rgba(251,146,60,.7)",letterSpacing:".08em",textTransform:"uppercase",marginBottom:8}}>Base de calcul</p>
                    <p style={{fontSize:13,color:"rgba(255,255,255,0.5)",lineHeight:1.7}}>
                      Le ratio <strong style={{color:"rgba(255,255,255,0.8)"}}>adh / heure</strong> est calcul√© sur <strong style={{color:"rgba(255,255,255,0.8)"}}>6 heures effectives</strong> de terrain.
                      Mission : <strong style={{color:"#fbbf24"}}>{stats.allStats.perHour.toFixed(2)} adh/h</strong> ({stats.allStats.total} adh√©rents) ‚Äî
                      Aujourd'hui : <strong style={{color:"#a78bfa"}}>{stats.todayStats.perHour.toFixed(2)} adh/h</strong> ({stats.todayStats.total} adh√©rents).
                    </p>
                  </div>
                </div>
              )}
            </div>
          )}

          {page==="don" && (
            <div className="fade-in">
              <div style={{marginBottom:28}}>
                <button onClick={()=>setPage("dashboard")} style={{background:"none",border:"none",color:"rgba(255,255,255,0.4)",cursor:"pointer",fontFamily:font,fontSize:13,padding:0,marginBottom:16}}>‚Üê Retour</button>
                <h1 style={{fontFamily:serif,fontSize:36,color:"white",fontWeight:600,marginBottom:6}}>Nouvelle fiche de don</h1>
                <p style={{color:"rgba(255,255,255,0.5)",fontSize:14}}>Remplissez chaque √©tape pour enregistrer l'adh√©rent</p>
              </div>
              <div className="donation-form-wrap" style={{background:"#fafaf9",borderRadius:24,padding:"36px 40px",maxWidth:720,boxShadow:"0 24px 64px rgba(0,0,0,0.3)"}}>
                <DonationPanel currentUser={currentUser} onSuccess={()=>{ loadStats(); setPage("dashboard"); }}/>
              </div>
            </div>
          )}

          {page==="rappels" && (
            <div className="fade-in">
              {rappelSelected ? (
                /* ‚îÄ‚îÄ VUE FICHE INDIVIDUELLE ‚îÄ‚îÄ */
                <div>
                  <div style={{marginBottom:28}}>
                    <button onClick={()=>setRappelSelected(null)} style={{background:"none",border:"none",color:"rgba(255,255,255,0.4)",cursor:"pointer",fontFamily:font,fontSize:13,padding:0,marginBottom:16}}>‚Üê Retour aux rappels</button>
                    <h1 style={{fontFamily:serif,fontSize:36,color:"white",fontWeight:600,marginBottom:6}}>Finaliser le dossier</h1>
                    <p style={{color:"rgba(255,255,255,0.5)",fontSize:14}}>Compl√©tez le RIB manquant pour valider l'adh√©sion de {rappelSelected.prenom} {rappelSelected.nom}</p>
                  </div>
                  <div className="completion-panel-wrap" style={{background:"#fafaf9",borderRadius:24,padding:"36px 40px",maxWidth:720,boxShadow:"0 24px 64px rgba(0,0,0,0.3)"}}>
                    <CompletionPanel
                      adherent={rappelSelected}
                      onSuccess={()=>{ loadStats(); setRappelSelected(null); }}
                      onCancel={()=>setRappelSelected(null)}
                    />
                  </div>
                </div>
              ) : (
                /* ‚îÄ‚îÄ LISTE DES RAPPELS ‚îÄ‚îÄ */
                <div>
                  <div style={{marginBottom:32}}>
                    <h1 style={{fontFamily:serif,fontSize:40,color:"white",fontWeight:600,marginBottom:8}}>üìû Dossiers √† rappeler</h1>
                    <p style={{color:"rgba(255,255,255,0.5)",fontSize:15}}>
                      {rappels.length === 0 ? "Aucun dossier incomplet ‚Äî tout est √† jour !" : `${rappels.length} dossier${rappels.length>1?"s":""} en attente de RIB`}
                    </p>
                  </div>

                  {rappels.length === 0 ? (
                    <div className="card" style={{textAlign:"center",padding:"60px 40px"}}>
                      <div style={{fontSize:52,marginBottom:16}}>‚úÖ</div>
                      <h3 style={{fontFamily:serif,fontSize:24,color:"white",marginBottom:8}}>Tout est √† jour !</h3>
                      <p style={{color:"rgba(255,255,255,0.4)",fontSize:14}}>Aucun adh√©rent en attente de RIB.</p>
                    </div>
                  ) : (
                    <div style={{display:"flex",flexDirection:"column",gap:12}}>
                      {rappels
                        .slice()
                        .sort((a,b) => {
                          // En retard d'abord, puis par date
                          const now = new Date();
                          const aUrgent = a.rdv_date && new Date(a.rdv_date) <= now;
                          const bUrgent = b.rdv_date && new Date(b.rdv_date) <= now;
                          if (aUrgent && !bUrgent) return -1;
                          if (!aUrgent && bUrgent) return 1;
                          if (a.rdv_date && b.rdv_date) return new Date(a.rdv_date) - new Date(b.rdv_date);
                          if (a.rdv_date) return -1;
                          if (b.rdv_date) return 1;
                          return 0;
                        })
                        .map(r => {
                          const rdvDate = r.rdv_date ? new Date(r.rdv_date) : null;
                          const isUrgent = rdvDate && rdvDate <= new Date();
                          return (
                            <div key={r.id} className="rappel-card" style={{background:isUrgent?"rgba(239,68,68,.06)":"rgba(255,255,255,0.03)",border:`1px solid ${isUrgent?"rgba(239,68,68,.25)":"rgba(251,146,60,.2)"}`,borderRadius:16,padding:"20px 24px",display:"flex",alignItems:"center",gap:16,transition:"border-color .2s"}}>
                              {/* Indicateur urgence */}
                              <div style={{width:44,height:44,borderRadius:12,background:isUrgent?"rgba(239,68,68,.15)":"rgba(251,146,60,.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0}}>
                                {isUrgent ? "üî¥" : "üìÖ"}
                              </div>

                              {/* Identit√© + infos */}
                              <div style={{flex:1,minWidth:0}}>
                                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4}}>
                                  <p style={{fontWeight:700,color:"white",fontSize:15}}>{r.prenom} {r.nom}</p>
                                  {isUrgent && <span style={{fontSize:10,padding:"2px 8px",borderRadius:20,background:"rgba(239,68,68,.2)",color:"#f87171",fontWeight:700}}>EN RETARD</span>}
                                </div>
                                <p style={{fontSize:12,color:"rgba(255,255,255,0.45)",marginBottom:4}}>
                                  üìû {r.telephone || "‚Äî"} &nbsp;¬∑&nbsp; üìß {r.email || "‚Äî"}
                                  {r.ville && <span> &nbsp;¬∑&nbsp; üìç {r.ville}</span>}
                                </p>
                                {rdvDate && (
                                  <p style={{fontSize:12,fontWeight:600,color:isUrgent?"#f87171":"#fb923c"}}>
                                    üóì {rdvDate.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long"})} √† {rdvDate.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}
                                  </p>
                                )}
                                {r.rdv_note && <p style={{fontSize:11,color:"rgba(255,255,255,0.3)",marginTop:2,fontStyle:"italic"}}>"{r.rdv_note}"</p>}
                              </div>

                              {/* Don + actions */}
                              <div className="rappel-actions" style={{textAlign:"right",flexShrink:0,display:"flex",flexDirection:"column",alignItems:"flex-end",gap:8}}>
                                {r.montant_don && (
                                  <p style={{fontSize:16,fontWeight:700,color:"#34d399"}}>{parseFloat(r.montant_don).toFixed(2)} ‚Ç¨<span style={{fontSize:11,color:"rgba(255,255,255,0.35)",fontWeight:400}}>/mois</span></p>
                                )}
                                <button
                                  onClick={()=>setRappelSelected(r)}
                                  style={{padding:"10px 20px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#4c1d95,#6d28d9)",color:"white",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:font,boxShadow:"0 4px 16px rgba(76,29,149,.35)",whiteSpace:"nowrap"}}
                                >
                                  üìù Finaliser le dossier
                                </button>
                                <button
                                  onClick={()=>{ if(window.confirm(`Supprimer le dossier de ${r.prenom} ${r.nom} ?`)) deleteRappel(r.id); }}
                                  title="Supprimer ce dossier"
                                  style={{width:32,height:32,borderRadius:8,border:"1px solid rgba(239,68,68,.3)",background:"rgba(239,68,68,.08)",color:"#f87171",cursor:"pointer",fontFamily:font,fontSize:16,display:"flex",alignItems:"center",justifyContent:"center",lineHeight:1}}
                                >√ó</button>
                              </div>
                            </div>
                          );
                        })}
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </main>

        {/* FOOTER */}
        <footer style={{borderTop:"1px solid rgba(255,255,255,0.06)",padding:"16px 32px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span style={{fontSize:12,color:"rgba(255,255,255,0.25)"}}>Espace Collecteur</span>
          <div style={{display:"flex",gap:16}}>
            <a href="register.html" style={{fontSize:12,color:"rgba(255,255,255,0.35)",textDecoration:"none"}}>Cr√©er un compte</a>
            <a href="admin.html" style={{fontSize:12,color:"rgba(255,255,255,0.35)",textDecoration:"none"}}>Admin</a>
          </div>
        </footer>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
  <script src="/pwa.js"></script>
</body>
</html>
