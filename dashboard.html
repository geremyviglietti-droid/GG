<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Tableau de bord â€” Espace Collecteur</title>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;0,9..40,600;0,9..40,700&family=Cormorant+Garamond:wght@400;500;600;700&display=swap" rel="stylesheet" />
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    body { background: #0f0e1a; font-family: 'DM Sans', sans-serif; min-height: 100vh; color: white; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 3px; }
    @keyframes fadeIn { from { opacity:0; transform:translateY(12px); } to { opacity:1; transform:translateY(0); } }
    @keyframes pulse { 0%,100% { opacity:.6; } 50% { opacity:1; } }
    .fade-in { animation: fadeIn 0.5s ease forwards; }
    .card { background: rgba(255,255,255,0.04); border: 1px solid rgba(255,255,255,0.08); border-radius: 20px; padding: 28px; transition: border-color .2s, background .2s; }
    .card:hover { background: rgba(255,255,255,0.06); border-color: rgba(124,58,237,0.4); }
    .stat-value { font-family: 'Cormorant Garamond', serif; font-size: 36px; font-weight: 700; line-height: 1; }
    .stat-label { font-size: 11px; font-weight: 700; letter-spacing: .08em; text-transform: uppercase; color: rgba(255,255,255,0.4); margin-top: 8px; }
    .btn-ghost { background: rgba(255,255,255,0.07); color: rgba(255,255,255,0.8); border: 1px solid rgba(255,255,255,0.12); padding: 9px 18px; border-radius: 10px; font-family: 'DM Sans',sans-serif; font-size: 13px; font-weight: 600; cursor: pointer; transition: background .2s; text-decoration: none; display: inline-block; }
    .btn-ghost:hover { background: rgba(255,255,255,0.12); }
    .nav-link { color: rgba(255,255,255,0.55); text-decoration: none; font-size: 14px; font-weight: 500; padding: 8px 16px; border-radius: 10px; transition: background .2s, color .2s; border: none; cursor: pointer; font-family: 'DM Sans',sans-serif; background: transparent; }
    .nav-link:hover, .nav-link.active { background: rgba(255,255,255,0.08); color: white; }
    .loading-dot { animation: pulse 1.4s infinite; }
    .badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 700; }
    .badge-purple { background: rgba(124,58,237,.2); color: #a78bfa; border: 1px solid rgba(124,58,237,.3); }
  </style>
</head>
<body>
<div id="root"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/react/18.2.0/umd/react.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/react-dom/18.2.0/umd/react-dom.production.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/babel-standalone/7.23.2/babel.min.js"></script>

<script type="text/babel">
  const { useState, useEffect, useRef } = React;

  const SUPABASE_URL  = "https://twgrqkkqehsjuijpnixh.supabase.co";
  const SUPABASE_ANON_KEY = "sb_publishable_42Z5XwQuWPKLsS2iyq3g_w_0LDKabTV";
  const serif = "'Cormorant Garamond', serif";
  const font  = "'DM Sans', sans-serif";

  // â”€â”€ HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  async function supabaseFetch(table, filter = "") {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?select=*${filter}&order=created_at.desc`, {
      headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` },
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function supabaseUpdate(table, id, data) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}?id=eq.${id}`, {
      method: "PATCH",
      headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, Prefer: "return=representation" },
      body: JSON.stringify(data),
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  async function supabaseInsert(table, data) {
    const res = await fetch(`${SUPABASE_URL}/rest/v1/${table}`, {
      method: "POST",
      headers: { "Content-Type": "application/json", apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}`, Prefer: "return=representation" },
      body: JSON.stringify(data),
    });
    if (!res.ok) throw new Error(await res.text());
    return res.json();
  }

  function calcAge(dateStr) {
    if (!dateStr) return null;
    const parts = String(dateStr).split(/[-\/]/);
    if (parts.length < 3) return null;
    const bYear = parseInt(parts[0]), bMonth = parseInt(parts[1]) - 1, bDay = parseInt(parts[2]);
    if (isNaN(bYear) || isNaN(bMonth) || isNaN(bDay)) return null;
    const n = new Date();
    let age = n.getFullYear() - bYear;
    if (n.getMonth() < bMonth || (n.getMonth() === bMonth && n.getDate() < bDay)) age--;
    return (age >= 0 && age < 120) ? age : null;
  }

  async function hashPassword(pwd) {
    const buf = await crypto.subtle.digest("SHA-256", new TextEncoder().encode(pwd));
    return Array.from(new Uint8Array(buf)).map(b => b.toString(16).padStart(2, "0")).join("");
  }

  // â”€â”€ IBAN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const IBAN_LENGTHS = { FR:27,DE:22,BE:16,ES:24,IT:27,CH:21,GB:22,NL:18,PT:25,LU:20,AT:20,SE:24 };
  function validateIBAN(iban) {
    const c = iban.replace(/\s/g,"").toUpperCase();
    if (c.length < 15 || c.length > 34) return false;
    if (IBAN_LENGTHS[c.slice(0,2)] && c.length !== IBAN_LENGTHS[c.slice(0,2)]) return false;
    const r = (c.slice(4)+c.slice(0,4)).split("").map(x=>isNaN(x)?(x.charCodeAt(0)-55).toString():x).join("");
    let rem = 0; for (let i=0;i<r.length;i++) rem=(rem*10+parseInt(r[i]))%97;
    return rem===1;
  }
  function isIBANComplete(iban) {
    const c = iban.replace(/\s/g,"").toUpperCase();
    return IBAN_LENGTHS[c.slice(0,2)] ? c.length===IBAN_LENGTHS[c.slice(0,2)] : c.length>=15;
  }

  // â”€â”€ LOGIN SCREEN â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function LoginScreen({ onLogin }) {
    const [email, setEmail]       = useState("");
    const [password, setPassword] = useState("");
    const [showPwd, setShowPwd]   = useState(false);
    const [loading, setLoading]   = useState(false);
    const [error, setError]       = useState(null);

    async function handleLogin() {
      if (!email.trim() || !password) { setError("Veuillez remplir tous les champs."); return; }
      setLoading(true); setError(null);
      try {
        const hash = await hashPassword(password);
        const res = await fetch(
          `${SUPABASE_URL}/rest/v1/collecteurs?email=eq.${encodeURIComponent(email.trim())}&password_hash=eq.${hash}&select=*`,
          { headers: { apikey: SUPABASE_ANON_KEY, Authorization: `Bearer ${SUPABASE_ANON_KEY}` } }
        );
        const rows = await res.json();
        if (!rows || rows.length === 0) {
          setError("Email ou mot de passe incorrect.");
        } else {
          const user = rows[0];
          sessionStorage.setItem("collecteur", JSON.stringify(user));
          onLogin(user);
        }
      } catch(e) { setError("Erreur de connexion : " + e.message); }
      setLoading(false);
    }

    const inp = (err) => ({
      border: `2px solid ${err ? "#f87171" : "rgba(255,255,255,0.1)"}`,
      borderRadius: 14, padding: "14px 18px", width: "100%", outline: "none",
      fontSize: 15, fontFamily: font, background: "rgba(255,255,255,0.05)",
      color: "white", boxSizing: "border-box", transition: "border .2s",
    });
    const lbl = { fontSize:11, fontWeight:700, color:"rgba(255,255,255,0.4)", display:"block", marginBottom:7, letterSpacing:".08em", textTransform:"uppercase" };

    return (
      <div style={{minHeight:"100vh",display:"flex",alignItems:"center",justifyContent:"center",background:"radial-gradient(ellipse at 60% 30%, rgba(76,29,149,.25), transparent 60%), #0f0e1a",padding:24}}>
        <div className="fade-in" style={{background:"rgba(255,255,255,0.04)",border:"1px solid rgba(255,255,255,0.1)",borderRadius:28,padding:"52px 44px",maxWidth:420,width:"100%"}}>
          <div style={{textAlign:"center",marginBottom:36}}>
            <div style={{width:60,height:60,borderRadius:18,background:"linear-gradient(135deg,#4c1d95,#6d28d9)",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 20px",fontSize:26}}>ğŸ¯</div>
            <h1 style={{fontFamily:serif,fontSize:32,color:"white",fontWeight:600,marginBottom:6}}>Espace Collecteur</h1>
            <p style={{color:"rgba(255,255,255,0.4)",fontSize:14}}>Connectez-vous pour accÃ©der Ã  votre tableau de bord</p>
          </div>
          <div style={{marginBottom:16}}>
            <label style={lbl}>Adresse email</label>
            <input type="email" value={email} onChange={e=>{setEmail(e.target.value);setError(null);}} onKeyDown={e=>e.key==="Enter"&&handleLogin()} placeholder="jean.martin@email.com" style={inp(!!error)} />
          </div>
          <div style={{marginBottom:24}}>
            <label style={lbl}>Mot de passe</label>
            <div style={{position:"relative"}}>
              <input type={showPwd?"text":"password"} value={password} onChange={e=>{setPassword(e.target.value);setError(null);}} onKeyDown={e=>e.key==="Enter"&&handleLogin()} placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" style={{...inp(!!error),paddingRight:48}} />
              <button onClick={()=>setShowPwd(v=>!v)} style={{position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",background:"none",border:"none",cursor:"pointer",color:"rgba(255,255,255,0.4)",fontSize:16}}>{showPwd?"ğŸ™ˆ":"ğŸ‘"}</button>
            </div>
          </div>
          {error && <div style={{background:"rgba(239,68,68,.12)",border:"1px solid rgba(239,68,68,.3)",borderRadius:10,padding:"12px 16px",marginBottom:16,color:"#f87171",fontSize:13,textAlign:"center"}}>{error}</div>}
          <button onClick={handleLogin} disabled={loading} style={{width:"100%",padding:"15px",borderRadius:14,border:"none",background:loading?"rgba(255,255,255,0.1)":"linear-gradient(135deg,#4c1d95,#6d28d9)",color:loading?"rgba(255,255,255,0.4)":"white",fontSize:15,fontWeight:700,cursor:loading?"not-allowed":"pointer",fontFamily:font,boxShadow:loading?"none":"0 8px 28px rgba(76,29,149,.45)",transition:"all .2s"}}>
            {loading ? "Connexion en coursâ€¦" : "Se connecter â†’"}
          </button>
          <p style={{textAlign:"center",fontSize:13,color:"rgba(255,255,255,0.35)",marginTop:20}}>
            Pas encore de compte ? <a href="register.html" style={{color:"#a78bfa",textDecoration:"none",fontWeight:600}}>S'inscrire</a>
          </p>
        </div>
      </div>
    );
  }

  // â”€â”€ DONATION PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function DonationPanel({ currentUser, onSuccess }) {
    const [step, setStep]             = useState(0);
    const [form, setForm]             = useState({ nom:"", prenom:"", dateNaissance:"", adresse:"", codePostal:"", ville:"", telephone:"", email: currentUser?.email||"", consentRgpd:false, consentMarketing:false, montantDon:"", iban:"", bic:"", ibanValid:null, rdvDate:"", rdvHeure:"", rdvNote:"", ibanDiffere:false });
    const [errors, setErrors]         = useState({});
    const [submitting, setSubmitting] = useState(false);
    const [submitError, setSubmitError] = useState(null);
    const [done, setDone]             = useState(false);
    const canvasRef = useRef(null);
    const lastPos   = useRef(null);
    const [drawing, setDrawing]       = useState(false);
    const [signature, setSignature]   = useState(null);

    const steps = ["CoordonnÃ©es","RGPD","Don","IBAN","RÃ©cap & Signature"];
    const montant = parseFloat(form.montantDon) || 0;
    const defiscalisation = (montant * 0.66).toFixed(2);
    const netDon = (montant * 0.34).toFixed(2);

    function update(k, v) {
      setForm(f => {
        const n = {...f, [k]:v};
        if (k === "iban") n.ibanValid = isIBANComplete(v) ? validateIBAN(v) : null;
        return n;
      });
      setErrors(e => ({...e, [k]:undefined}));
    }

    const inputS = (err, ok) => ({ border:`2px solid ${err?"#f87171":ok?"#22c55e":"#e2e8f0"}`, borderRadius:14, padding:"13px 16px", width:"100%", outline:"none", fontSize:14, fontFamily:font, background:err?"#fff5f5":ok?"#f0fdf4":"white", color:"#1a1a2e", boxSizing:"border-box" });
    const lbl = { fontSize:11, fontWeight:700, color:"#6b7280", display:"block", marginBottom:6, letterSpacing:".08em", textTransform:"uppercase" };

    function posFromEvent(e, canvas) {
      const r = canvas.getBoundingClientRect();
      const src = e.touches ? e.touches[0] : e;
      return { x:(src.clientX-r.left)*(canvas.width/r.width), y:(src.clientY-r.top)*(canvas.height/r.height) };
    }
    function startDraw(e) { e.preventDefault(); lastPos.current = posFromEvent(e, canvasRef.current); setDrawing(true); }
    function draw(e) {
      if (!drawing) return; e.preventDefault();
      const ctx = canvasRef.current.getContext("2d");
      const p = posFromEvent(e, canvasRef.current);
      ctx.beginPath(); ctx.strokeStyle="#1a1a2e"; ctx.lineWidth=2.5; ctx.lineCap="round";
      ctx.moveTo(lastPos.current.x, lastPos.current.y); ctx.lineTo(p.x, p.y); ctx.stroke();
      lastPos.current = p;
    }
    function endDraw(e) { e.preventDefault(); setDrawing(false); setSignature(canvasRef.current.toDataURL()); }
    function clearSignature() { canvasRef.current.getContext("2d").clearRect(0,0,700,200); setSignature(null); }

    function validate() {
      const e = {};
      if (step===0) {
        if (!form.nom.trim())    e.nom = "Requis";
        if (!form.prenom.trim()) e.prenom = "Requis";
        if (!form.dateNaissance) e.dateNaissance = "Requis";
        if (!form.adresse.trim()) e.adresse = "Requis";
        if (!form.codePostal.trim()) e.codePostal = "Requis";
        if (!form.ville.trim())  e.ville = "Requis";
        if (!form.telephone.trim()) e.telephone = "Requis";
        if (!form.email.trim() || !form.email.includes("@")) e.email = "Email invalide";
      }
      if (step===1 && !form.consentRgpd) e.consentRgpd = "Obligatoire";
      if (step===3) {
        if (!form.ibanDiffere) {
          if (!form.iban.trim()) e.iban = "Requis";
          else if (form.ibanValid === false) e.iban = "IBAN invalide";
          else if (form.ibanValid === null)  e.iban = "IBAN incomplet";
        } else {
          if (!form.rdvDate) e.rdvDate = "Veuillez choisir une date de rappel";
          if (!form.rdvHeure) e.rdvHeure = "Veuillez choisir une heure";
        }
      }
      setErrors(e);
      return Object.keys(e).length === 0;
    }

    function next() { if (validate()) setStep(s => s+1); }
    function prev() { setStep(s => s-1); }

    async function handleSubmit() {
      if (!signature) { alert("Veuillez signer avant de valider."); return; }
      setSubmitting(true); setSubmitError(null);
      try {
        await supabaseInsert("adherents", {
          nom: form.nom, prenom: form.prenom, date_naissance: form.dateNaissance,
          adresse: form.adresse, code_postal: form.codePostal, ville: form.ville,
          telephone: form.telephone, email: form.email,
          consent_rgpd: form.consentRgpd, consent_marketing: form.consentMarketing,
          montant_don: form.montantDon ? parseFloat(form.montantDon) : null,
          reduction_fiscale: form.montantDon ? parseFloat(defiscalisation) : null,
          cout_net: form.montantDon ? parseFloat(netDon) : null,
          iban: form.ibanDiffere ? null : form.iban,
          bic: form.ibanDiffere ? null : form.bic,
          signature,
          collecteur_id: currentUser?.id,
          incomplet: form.ibanDiffere ? true : false,
          rdv_date: form.ibanDiffere && form.rdvDate ? `${form.rdvDate}T${form.rdvHeure||"10:00"}` : null,
          rdv_note: form.ibanDiffere ? form.rdvNote : null,
        });
        setDone(true);
        setTimeout(() => {
          onSuccess && onSuccess();
          setDone(false); setStep(0);
          setForm({ nom:"", prenom:"", dateNaissance:"", adresse:"", codePostal:"", ville:"", telephone:"", email: currentUser?.email||"", consentRgpd:false, consentMarketing:false, montantDon:"", iban:"", bic:"", ibanValid:null, rdvDate:"", rdvHeure:"", rdvNote:"", ibanDiffere:false });
          setSignature(null);
        }, 2000);
      } catch(e) { setSubmitError("Erreur : " + e.message); }
      setSubmitting(false);
    }

    if (done) return (
      <div style={{textAlign:"center",padding:"60px 0"}}>
        <div style={{width:64,height:64,borderRadius:"50%",background:"#dcfce7",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px",fontSize:28,color:"#16a34a"}}>âœ“</div>
        <h3 style={{fontFamily:serif,fontSize:26,color:"#1a1a2e",marginBottom:8}}>Dossier enregistrÃ© !</h3>
        <p style={{color:"#6b7280",fontSize:14}}>Retour au tableau de bordâ€¦</p>
      </div>
    );

    return (
      <div>
        {/* Barre de progression */}
        <div style={{display:"flex",gap:4,marginBottom:24}}>
          {steps.map((s,i) => (
            <div key={i} style={{flex:1,display:"flex",flexDirection:"column",alignItems:"center",gap:6}}>
              <div style={{width:32,height:32,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",fontSize:12,fontWeight:700,background:i<step?"#22c55e":i===step?"#6d28d9":"#e5e7eb",color:i<=step?"white":"#9ca3af"}}>{i<step?"âœ“":i+1}</div>
              <span style={{fontSize:9,color:i===step?"#6d28d9":"#9ca3af",fontWeight:700,textTransform:"uppercase",letterSpacing:".06em",textAlign:"center"}}>{s}</span>
            </div>
          ))}
        </div>

        {/* Ã‰tape 0 */}
        {step===0 && (
          <div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16,marginBottom:16}}>
              <div><label style={lbl}>Nom</label><input style={inputS(!!errors.nom)} value={form.nom} onChange={e=>update("nom",e.target.value)} placeholder="MARTIN"/>{errors.nom&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.nom}</p>}</div>
              <div><label style={lbl}>PrÃ©nom</label><input style={inputS(!!errors.prenom)} value={form.prenom} onChange={e=>update("prenom",e.target.value)} placeholder="Jean"/>{errors.prenom&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.prenom}</p>}</div>
            </div>
            <div style={{marginBottom:16}}><label style={lbl}>Date de naissance</label><input type="date" style={inputS(!!errors.dateNaissance)} value={form.dateNaissance} onChange={e=>update("dateNaissance",e.target.value)}/>{errors.dateNaissance&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.dateNaissance}</p>}</div>
            <div style={{marginBottom:16}}><label style={lbl}>Adresse</label><input style={inputS(!!errors.adresse)} value={form.adresse} onChange={e=>update("adresse",e.target.value)} placeholder="12 rue de la Paix"/>{errors.adresse&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.adresse}</p>}</div>
            <div style={{display:"grid",gridTemplateColumns:"160px 1fr",gap:16,marginBottom:16}}>
              <div><label style={lbl}>Code postal</label><input style={inputS(!!errors.codePostal)} value={form.codePostal} onChange={e=>update("codePostal",e.target.value)} placeholder="75001" maxLength={10}/>{errors.codePostal&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.codePostal}</p>}</div>
              <div><label style={lbl}>Ville</label><input style={inputS(!!errors.ville)} value={form.ville} onChange={e=>update("ville",e.target.value)} placeholder="Paris"/>{errors.ville&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.ville}</p>}</div>
            </div>
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:16}}>
              <div><label style={lbl}>TÃ©lÃ©phone</label><input type="tel" style={inputS(!!errors.telephone)} value={form.telephone} onChange={e=>update("telephone",e.target.value)} placeholder="06 12 34 56 78"/>{errors.telephone&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.telephone}</p>}</div>
              <div><label style={lbl}>Email</label><input type="email" style={inputS(!!errors.email)} value={form.email} onChange={e=>update("email",e.target.value)} placeholder="jean@email.com"/>{errors.email&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.email}</p>}</div>
            </div>
          </div>
        )}

        {/* Ã‰tape 1 â€” RGPD */}
        {step===1 && (
          <div>
            <div style={{marginBottom:20}}>
              <h3 style={{fontSize:16,fontWeight:700,color:"#1a1a2e",marginBottom:4}}>Protection de vos donnÃ©es personnelles</h3>
              <p style={{fontSize:12,color:"#6b7280",lineHeight:1.6}}>ConformÃ©ment au RÃ¨glement GÃ©nÃ©ral sur la Protection des DonnÃ©es (RGPD â€“ UE 2016/679), nous vous informons de l'utilisation de vos donnÃ©es.</p>
            </div>

            <div style={{background:"#f9fafb",borderRadius:14,padding:"18px 20px",marginBottom:16,border:"1px solid #e5e7eb"}}>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                {[
                  {icon:"ğŸ¯",title:"FinalitÃ© de la collecte",text:"Gestion de votre adhÃ©sion, traitement du prÃ©lÃ¨vement SEPA mensuel et suivi de votre dossier de donateur."},
                  {icon:"âš–ï¸",title:"Base lÃ©gale",text:"Art. 6.1.b RGPD â€” ExÃ©cution d'un contrat. Le traitement est nÃ©cessaire Ã  l'exÃ©cution de votre adhÃ©sion."},
                  {icon:"ğŸ”’",title:"SÃ©curitÃ© & conservation",text:"Vos donnÃ©es sont chiffrÃ©es (TLS 1.3) et conservÃ©es 3 ans aprÃ¨s la fin de votre adhÃ©sion, puis archivÃ©es 5 ans (obligations lÃ©gales)."},
                  {icon:"ğŸš«",title:"Pas de vente de donnÃ©es",text:"Vos donnÃ©es ne sont jamais vendues ni cÃ©dÃ©es Ã  des tiers Ã  des fins commerciales. AccÃ¨s strictement limitÃ© Ã  notre organisation."},
                ].map(item => (
                  <div key={item.title} style={{display:"flex",gap:10,alignItems:"flex-start"}}>
                    <span style={{fontSize:18,flexShrink:0}}>{item.icon}</span>
                    <div>
                      <p style={{fontSize:12,fontWeight:700,color:"#1a1a2e",marginBottom:3}}>{item.title}</p>
                      <p style={{fontSize:11,color:"#6b7280",lineHeight:1.55}}>{item.text}</p>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div style={{background:"#eff6ff",borderRadius:12,padding:"12px 16px",marginBottom:16,border:"1px solid #bfdbfe"}}>
              <p style={{fontSize:12,color:"#1e40af",fontWeight:600,marginBottom:4}}>Vos droits (Art. 15 Ã  22 RGPD)</p>
              <p style={{fontSize:12,color:"#1d4ed8",lineHeight:1.6}}>Vous disposez d'un droit d'<strong>accÃ¨s</strong>, de <strong>rectification</strong>, d'<strong>effacement</strong>, de <strong>portabilitÃ©</strong> et d'<strong>opposition</strong> au traitement de vos donnÃ©es. Pour exercer vos droits : <span style={{fontWeight:700}}>dpo@organisation.fr</span></p>
            </div>

            <div style={{marginTop:4}}>
              {[{key:"consentRgpd",required:true,label:"J'ai lu et j'accepte la politique de confidentialitÃ©. J'autorise le traitement de mes donnÃ©es personnelles dans le cadre de mon adhÃ©sion."},{key:"consentMarketing",required:false,label:"J'accepte de recevoir des communications sur les actualitÃ©s et les actions de l'organisation. (optionnel)"}].map(({key,required,label}) => (
                <div key={key} onClick={()=>{setForm(f=>({...f,[key]:!f[key]}));setErrors(e=>({...e,[key]:undefined}));}} style={{display:"flex",gap:14,alignItems:"flex-start",padding:"14px 16px",borderRadius:12,border:`2px solid ${errors[key]?"#f87171":form[key]?"#6d28d9":"#e5e7eb"}`,background:form[key]?"#f5f3ff":"white",cursor:"pointer",marginBottom:10,transition:"all .15s"}}>
                  <div style={{width:22,height:22,borderRadius:6,border:`2px solid ${form[key]?"#6d28d9":"#d1d5db"}`,background:form[key]?"#6d28d9":"white",display:"flex",alignItems:"center",justifyContent:"center",flexShrink:0,marginTop:1}}>{form[key]&&<span style={{color:"white",fontSize:11,fontWeight:700}}>âœ“</span>}</div>
                  <p style={{fontSize:13,color:"#374151",lineHeight:1.5,margin:0}}>{label}{required&&<span style={{color:"#ef4444",marginLeft:4}}>*</span>}</p>
                </div>
              ))}
              {errors.consentRgpd&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.consentRgpd}</p>}
            </div>
          </div>
        )}

        {/* Ã‰tape 2 */}
        {step===2 && (
          <div>
            <div style={{marginBottom:20}}>
              <label style={lbl}>Montant du don mensuel (â‚¬)</label>
              <input type="number" min="1" step="0.01" value={form.montantDon} onChange={e=>update("montantDon",e.target.value)} placeholder="Ex : 20" style={inputS(false)}/>
            </div>
            {montant > 0 && (
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12}}>
                <div style={{background:"#f0fdf4",borderRadius:14,padding:"18px 14px",textAlign:"center",border:"1px solid #bbf7d0"}}>
                  <p style={{fontSize:10,fontWeight:700,color:"#14532d",textTransform:"uppercase",letterSpacing:".06em",marginBottom:8}}>RÃ©duction 66%</p>
                  <p style={{fontSize:24,fontWeight:700,color:"#16a34a"}}>{defiscalisation} â‚¬</p>
                </div>
                <div style={{background:"#f0fdf4",borderRadius:14,padding:"18px 14px",textAlign:"center",border:"1px solid #bbf7d0"}}>
                  <p style={{fontSize:10,fontWeight:700,color:"#14532d",textTransform:"uppercase",letterSpacing:".06em",marginBottom:8}}>CoÃ»t rÃ©el</p>
                  <p style={{fontSize:24,fontWeight:700,color:"#16a34a"}}>{netDon} â‚¬</p>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Ã‰tape 3 â€” IBAN + option RDV */}
        {step===3 && (
          <div>
            <div style={{marginBottom:20}}>
              <h3 style={{fontSize:16,fontWeight:700,color:"#1a1a2e",marginBottom:4}}>CoordonnÃ©es bancaires</h3>
              <p style={{fontSize:12,color:"#6b7280"}}>Saisissez l'IBAN pour le prÃ©lÃ¨vement SEPA, ou programmez un rappel si l'adhÃ©rent ne l'a pas sur lui.</p>
            </div>

            {/* Toggle IBAN / RDV */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:8,marginBottom:20}}>
              <div onClick={()=>update("ibanDiffere",false)} style={{padding:"12px 14px",borderRadius:12,border:`2px solid ${!form.ibanDiffere?"#6d28d9":"#e5e7eb"}`,background:!form.ibanDiffere?"#f5f3ff":"white",cursor:"pointer",textAlign:"center",transition:"all .15s"}}>
                <div style={{fontSize:20,marginBottom:4}}>ğŸ¦</div>
                <p style={{fontSize:13,fontWeight:700,color:!form.ibanDiffere?"#4c1d95":"#374151"}}>IBAN disponible</p>
                <p style={{fontSize:11,color:"#9ca3af"}}>Saisir maintenant</p>
              </div>
              <div onClick={()=>update("ibanDiffere",true)} style={{padding:"12px 14px",borderRadius:12,border:`2px solid ${form.ibanDiffere?"#f59e0b":"#e5e7eb"}`,background:form.ibanDiffere?"#fffbeb":"white",cursor:"pointer",textAlign:"center",transition:"all .15s"}}>
                <div style={{fontSize:20,marginBottom:4}}>ğŸ“…</div>
                <p style={{fontSize:13,fontWeight:700,color:form.ibanDiffere?"#92400e":"#374151"}}>Rappel Ã  programmer</p>
                <p style={{fontSize:11,color:"#9ca3af"}}>L'adhÃ©rent n'a pas l'IBAN</p>
              </div>
            </div>

            {!form.ibanDiffere ? (
              <div>
                <div style={{marginBottom:16}}>
                  <label style={lbl}>IBAN</label>
                  <div style={{position:"relative"}}>
                    <input value={form.iban} onChange={e=>update("iban",e.target.value)} placeholder="FR76 3000 6000 0112 3456 7890 189" style={{...inputS(!!errors.iban,form.ibanValid===true),fontFamily:"monospace",letterSpacing:".06em",paddingRight:48}}/>
                    {form.ibanValid!==null&&<div style={{position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",width:24,height:24,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:form.ibanValid?"#dcfce7":"#fee2e2",fontSize:12,fontWeight:700,color:form.ibanValid?"#16a34a":"#ef4444"}}>{form.ibanValid?"âœ“":"âœ—"}</div>}
                  </div>
                  {form.ibanValid===true&&<p style={{color:"#16a34a",fontSize:12,marginTop:6,fontWeight:600}}>IBAN valide âœ“</p>}
                  {errors.iban&&<p style={{color:"#ef4444",fontSize:12,marginTop:6}}>{errors.iban}</p>}
                </div>
                <div>
                  <label style={lbl}>BIC / SWIFT</label>
                  <input value={form.bic} onChange={e=>update("bic",e.target.value)} placeholder="BNPAFRPP" style={{...inputS(false,false),fontFamily:"monospace",letterSpacing:".06em"}}/>
                </div>
              </div>
            ) : (
              <div style={{background:"#fffbeb",borderRadius:14,padding:18,border:"1px solid #fde68a"}}>
                <p style={{fontSize:13,fontWeight:700,color:"#92400e",marginBottom:14}}>ğŸ“ Programmer un rappel tÃ©lÃ©phonique</p>
                <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
                  <div>
                    <label style={{...lbl,color:"#78350f"}}>Date du rappel</label>
                    <input type="date" value={form.rdvDate} onChange={e=>update("rdvDate",e.target.value)} min={new Date().toISOString().split("T")[0]} style={{...inputS(!!errors.rdvDate,false),background:errors.rdvDate?"#fff5f5":"white"}}/>
                    {errors.rdvDate&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.rdvDate}</p>}
                  </div>
                  <div>
                    <label style={{...lbl,color:"#78350f"}}>Heure</label>
                    <input type="time" value={form.rdvHeure} onChange={e=>update("rdvHeure",e.target.value)} style={{...inputS(!!errors.rdvHeure,false),background:errors.rdvHeure?"#fff5f5":"white"}}/>
                    {errors.rdvHeure&&<p style={{color:"#ef4444",fontSize:12,marginTop:4}}>{errors.rdvHeure}</p>}
                  </div>
                </div>
                <div>
                  <label style={{...lbl,color:"#78350f"}}>Note pour le rappel <span style={{fontWeight:300,opacity:.6}}>(optionnel)</span></label>
                  <input value={form.rdvNote} onChange={e=>update("rdvNote",e.target.value)} placeholder="Ex : Rappeler en fin de journÃ©e, prÃ©fÃ¨re le soir" style={{...inputS(false,false),background:"white"}}/>
                </div>
                <div style={{marginTop:12,background:"rgba(251,146,60,.12)",borderRadius:10,padding:"10px 14px"}}>
                  <p style={{fontSize:11,color:"#92400e",lineHeight:1.6}}>âš ï¸ Ce dossier sera marquÃ© comme <strong>incomplet</strong> et apparaÃ®tra dans votre liste de rappels sur le tableau de bord.</p>
                </div>
              </div>
            )}
          </div>
        )}

        {/* Ã‰tape 4 â€” RÃ©cap complet */}
        {step===4 && (
          <div>
            {/* CoordonnÃ©es complÃ¨tes */}
            <div style={{background:"#f9fafb",borderRadius:14,padding:18,border:"1px solid #e5e7eb",marginBottom:12}}>
              <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>ğŸ‘¤ CoordonnÃ©es civiles</p>
              <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:"6px 24px"}}>
                {[
                  ["Nom",form.nom],["PrÃ©nom",form.prenom],
                  ["Date de naissance",form.dateNaissance?new Date(form.dateNaissance+"T00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"}):"â€”"],
                  ["Adresse",form.adresse],
                  ["Code postal",form.codePostal],["Ville",form.ville],
                  ["TÃ©lÃ©phone",form.telephone],["Email",form.email],
                ].map(([l,v]) => (
                  <div key={l} style={{padding:"5px 0",borderBottom:"1px solid #f3f4f6"}}><p style={{fontSize:10,color:"#9ca3af",marginBottom:2,fontWeight:700,textTransform:"uppercase"}}>{l}</p><p style={{fontSize:13,color:"#1a1a2e",fontWeight:500}}>{v||"â€”"}</p></div>
                ))}
              </div>
            </div>

            {/* RGPD */}
            <div style={{background:"#f9fafb",borderRadius:14,padding:18,border:"1px solid #e5e7eb",marginBottom:12}}>
              <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>ğŸ”’ Consentements RGPD</p>
              <div style={{display:"flex",flexDirection:"column",gap:6}}>
                {[["Politique de confidentialitÃ©",form.consentRgpd],["Communications marketing",form.consentMarketing]].map(([l,v]) => (
                  <div key={l} style={{display:"flex",justifyContent:"space-between",alignItems:"center",padding:"6px 0",borderBottom:"1px solid #f3f4f6"}}>
                    <span style={{fontSize:12,color:"#4b5563"}}>{l}</span>
                    <span style={{fontSize:12,fontWeight:700,padding:"2px 10px",borderRadius:20,background:v?"#dcfce7":"#f3f4f6",color:v?"#16a34a":"#9ca3af"}}>{v?"AcceptÃ©":"RefusÃ©"}</span>
                  </div>
                ))}
              </div>
            </div>

            {/* Don */}
            <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:12,marginBottom:12}}>
              <div style={{background:"#f9fafb",borderRadius:14,padding:18,border:"1px solid #e5e7eb"}}>
                <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>ğŸ’¸ Don mensuel</p>
                {[
                  ["Montant",form.montantDon?`${parseFloat(form.montantDon).toFixed(2)} â‚¬`:"Non renseignÃ©"],
                  ["RÃ©duction 66%",form.montantDon?`${defiscalisation} â‚¬`:"â€”"],
                  ["CoÃ»t rÃ©el net",form.montantDon?`${netDon} â‚¬`:"â€”"],
                ].map(([l,v]) => (
                  <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"5px 0",borderBottom:"1px solid #f3f4f6"}}><span style={{fontSize:12,color:"#6b7280"}}>{l}</span><span style={{fontSize:12,fontWeight:700,color:"#1a1a2e"}}>{v}</span></div>
                ))}
              </div>

              {/* Bancaire ou RDV */}
              <div style={{background: form.ibanDiffere?"#fffbeb":"#f9fafb",borderRadius:14,padding:18,border:`1px solid ${form.ibanDiffere?"#fde68a":"#e5e7eb"}`}}>
                {form.ibanDiffere ? (
                  <>
                    <p style={{fontSize:11,fontWeight:700,color:"#92400e",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>ğŸ“… Rappel programmÃ©</p>
                    {[
                      ["Date",form.rdvDate?new Date(form.rdvDate+"T00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"}):"â€”"],
                      ["Heure",form.rdvHeure||"â€”"],
                      ["Note",form.rdvNote||"â€”"],
                    ].map(([l,v]) => (
                      <div key={l} style={{padding:"5px 0",borderBottom:"1px solid #fde68a"}}><p style={{fontSize:10,color:"#d97706",marginBottom:2,fontWeight:700,textTransform:"uppercase"}}>{l}</p><p style={{fontSize:12,color:"#78350f",fontWeight:500}}>{v}</p></div>
                    ))}
                  </>
                ) : (
                  <>
                    <p style={{fontSize:11,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:12}}>ğŸ¦ CoordonnÃ©es bancaires</p>
                    {[["IBAN",form.iban],["BIC",form.bic]].map(([l,v]) => (
                      <div key={l} style={{padding:"5px 0",borderBottom:"1px solid #f3f4f6"}}><p style={{fontSize:10,color:"#9ca3af",marginBottom:2,fontWeight:700,textTransform:"uppercase"}}>{l}</p><p style={{fontSize:12,color:"#1a1a2e",fontFamily:"monospace"}}>{v||"â€”"}</p></div>
                    ))}
                  </>
                )}
              </div>
            </div>

            {/* Signature */}
            <div style={{background:"white",borderRadius:14,padding:20,border:"2px dashed #c4b5fd",marginBottom:16}}>
              <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:12}}>
                <p style={{fontSize:14,fontWeight:700,color:"#1a1a2e"}}>âœï¸ Signature de l'adhÃ©rent</p>
                <button onClick={clearSignature} style={{fontSize:12,color:"#6d28d9",background:"#f5f3ff",border:"1px solid #ddd6fe",padding:"5px 14px",borderRadius:20,cursor:"pointer",fontFamily:font}}>Effacer</button>
              </div>
              <div style={{background:"#fafaf9",borderRadius:10,border:"1px solid #e5e7eb",position:"relative",touchAction:"none"}}>
                {!signature&&<div style={{position:"absolute",top:"50%",left:"50%",transform:"translate(-50%,-50%)",color:"#d1d5db",fontSize:13,pointerEvents:"none",fontStyle:"italic"}}>Zone de signature</div>}
                <canvas ref={canvasRef} width={700} height={160} style={{width:"100%",height:160,display:"block",cursor:"crosshair"}} onMouseDown={startDraw} onMouseMove={draw} onMouseUp={endDraw} onMouseLeave={endDraw} onTouchStart={startDraw} onTouchMove={draw} onTouchEnd={endDraw}/>
              </div>
            </div>
            {submitError&&<div style={{background:"#fef2f2",border:"1px solid #fecaca",borderRadius:10,padding:"12px 16px",marginBottom:12,color:"#991b1b",fontSize:13}}>{submitError}</div>}
            <button onClick={handleSubmit} disabled={submitting} style={{width:"100%",padding:"16px",borderRadius:14,border:"none",background:submitting?"#9ca3af":"linear-gradient(135deg,#1e1b4b,#6d28d9)",color:"white",fontSize:15,fontWeight:700,cursor:submitting?"not-allowed":"pointer",fontFamily:font,boxShadow:"0 6px 24px rgba(76,29,149,.4)"}}>
              {submitting?"Enregistrementâ€¦":"Valider et soumettre le dossier âœ“"}
            </button>
          </div>
        )}

        {/* Nav */}
        <div style={{display:"flex",justifyContent:"space-between",marginTop:28,paddingTop:20,borderTop:"1px solid #f3f4f6"}}>
          <button onClick={prev} disabled={step===0} style={{padding:"11px 24px",borderRadius:11,border:"2px solid #e5e7eb",background:step===0?"#f9fafb":"white",color:step===0?"#d1d5db":"#374151",fontSize:13,fontWeight:600,cursor:step===0?"not-allowed":"pointer",fontFamily:font}}>PrÃ©cÃ©dent</button>
          <span style={{fontSize:12,color:"#9ca3af",alignSelf:"center"}}>Ã‰tape {step+1}/{steps.length}</span>
          {step<steps.length-1&&<button onClick={next} style={{padding:"11px 28px",borderRadius:11,border:"none",background:"linear-gradient(135deg,#4c1d95,#6d28d9)",color:"white",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:font,boxShadow:"0 4px 16px rgba(76,29,149,.35)"}}>Suivant</button>}
        </div>
      </div>
    );
  }

  // â”€â”€ COMPLETION PANEL â€” Finalisation RIB â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function CompletionPanel({ adherent, onSuccess, onCancel }) {
    const [iban, setIban]           = useState("");
    const [bic, setBic]             = useState("");
    const [ibanValid, setIbanValid] = useState(null);
    const [error, setError]         = useState(null);
    const [submitting, setSubmitting] = useState(false);
    const [done, setDone]           = useState(false);

    function updateIban(v) {
      setIban(v);
      setIbanValid(isIBANComplete(v) ? validateIBAN(v) : null);
      setError(null);
    }

    async function handleSubmit() {
      if (!iban.trim()) { setError("L'IBAN est requis."); return; }
      if (ibanValid === false) { setError("IBAN invalide â€” vÃ©rifiez les chiffres."); return; }
      if (ibanValid === null)  { setError("IBAN incomplet."); return; }
      setSubmitting(true); setError(null);
      try {
        // On ne touche PAS Ã  la signature â€” elle appartient Ã  l'adhÃ©rent
        await supabaseUpdate("adherents", adherent.id, {
          iban,
          bic,
          incomplet: false,
          rdv_date: null,
          rdv_note: null,
        });
        setDone(true);
        setTimeout(() => onSuccess(), 1800);
      } catch(e) { setError("Erreur : " + e.message); }
      setSubmitting(false);
    }

    const inputS = (err, ok) => ({ border:`2px solid ${err?"#f87171":ok?"#22c55e":"#e2e8f0"}`, borderRadius:14, padding:"13px 16px", width:"100%", outline:"none", fontSize:14, fontFamily:font, background:err?"#fff5f5":ok?"#f0fdf4":"white", color:"#1a1a2e", boxSizing:"border-box" });
    const lbl = { fontSize:11, fontWeight:700, color:"#6b7280", display:"block", marginBottom:6, letterSpacing:".08em", textTransform:"uppercase" };
    const fmtDate = s => s ? new Date(s+"T00:00").toLocaleDateString("fr-FR",{day:"2-digit",month:"long",year:"numeric"}) : "â€”";

    if (done) return (
      <div style={{textAlign:"center",padding:"60px 0"}}>
        <div style={{width:64,height:64,borderRadius:"50%",background:"#dcfce7",display:"flex",alignItems:"center",justifyContent:"center",margin:"0 auto 16px",fontSize:28,color:"#16a34a"}}>âœ“</div>
        <h3 style={{fontFamily:serif,fontSize:26,color:"#1a1a2e",marginBottom:8}}>AdhÃ©sion finalisÃ©e !</h3>
        <p style={{color:"#6b7280",fontSize:14}}>Le RIB est enregistrÃ© â€” l'adhÃ©rent est maintenant actif.</p>
      </div>
    );

    return (
      <div>
        {/* En-tÃªte identitÃ© */}
        <div style={{background:"linear-gradient(135deg,#1e1b4b,#4c1d95)",borderRadius:16,padding:"20px 24px",marginBottom:20,color:"white"}}>
          <div style={{display:"flex",alignItems:"center",gap:14}}>
            <div style={{width:48,height:48,borderRadius:14,background:"rgba(255,255,255,0.15)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0}}>ğŸ‘¤</div>
            <div>
              <h2 style={{fontFamily:serif,fontSize:22,fontWeight:600,marginBottom:2}}>{adherent.prenom} {adherent.nom}</h2>
              <p style={{fontSize:12,opacity:.7}}>NÃ©(e) le {fmtDate(adherent.date_naissance)} Â· {adherent.ville}</p>
            </div>
            {adherent.montant_don && <div style={{marginLeft:"auto",textAlign:"right"}}>
              <p style={{fontSize:20,fontWeight:700,color:"#34d399"}}>{parseFloat(adherent.montant_don).toFixed(2)} â‚¬</p>
              <p style={{fontSize:10,opacity:.6,textTransform:"uppercase",letterSpacing:".06em"}}>don mensuel</p>
            </div>}
          </div>
        </div>

        {/* RÃ©cap fiche */}
        <div style={{display:"grid",gridTemplateColumns:"1fr 1fr",gap:10,marginBottom:20}}>
          {[
            {title:"ğŸ“ Adresse",     items:[["Adresse",adherent.adresse],["CP / Ville",`${adherent.code_postal||""} ${adherent.ville||""}`]]},
            {title:"ğŸ“ Contact",     items:[["TÃ©lÃ©phone",adherent.telephone],["Email",adherent.email]]},
            {title:"ğŸ”’ RGPD",        items:[["ConfidentialitÃ©",adherent.consent_rgpd?"âœ… AcceptÃ©":"âŒ RefusÃ©"],["Marketing",adherent.consent_marketing?"âœ… AcceptÃ©":"â€”"]]},
            {title:"ğŸ’¸ Don mensuel", items:[["Montant",adherent.montant_don?`${parseFloat(adherent.montant_don).toFixed(2)} â‚¬`:"â€”"],["CoÃ»t net",adherent.cout_net?`${parseFloat(adherent.cout_net).toFixed(2)} â‚¬`:"â€”"]]},
          ].map(sec => (
            <div key={sec.title} style={{background:"#f9fafb",borderRadius:12,padding:"14px 16px",border:"1px solid #e5e7eb"}}>
              <p style={{fontSize:10,fontWeight:700,color:"#9ca3af",textTransform:"uppercase",letterSpacing:".08em",marginBottom:10}}>{sec.title}</p>
              {sec.items.map(([l,v]) => (
                <div key={l} style={{display:"flex",justifyContent:"space-between",padding:"4px 0",borderBottom:"1px solid #f3f4f6"}}>
                  <span style={{fontSize:12,color:"#6b7280"}}>{l}</span>
                  <span style={{fontSize:12,fontWeight:600,color:"#1a1a2e",textAlign:"right",maxWidth:"60%",wordBreak:"break-all"}}>{v||"â€”"}</span>
                </div>
              ))}
            </div>
          ))}
        </div>

        {/* Signature originale â€” lecture seule, non modifiable */}
        {adherent.signature && (
          <div style={{background:"#f9fafb",borderRadius:14,padding:"16px 18px",marginBottom:20,border:"1px solid #e5e7eb"}}>
            <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:10}}>
              <span style={{fontSize:14}}>âœï¸</span>
              <p style={{fontSize:12,fontWeight:700,color:"#374151"}}>Signature de l'adhÃ©rent</p>
              <span style={{fontSize:11,padding:"2px 10px",borderRadius:20,background:"#dcfce7",color:"#16a34a",fontWeight:700,marginLeft:"auto"}}>âœ“ EnregistrÃ©e</span>
            </div>
            <img src={adherent.signature} alt="Signature" style={{width:"100%",borderRadius:8,background:"white",padding:8,border:"1px solid #e5e7eb",maxHeight:100,objectFit:"contain"}}/>
            <p style={{fontSize:11,color:"#9ca3af",marginTop:6,fontStyle:"italic"}}>Signature recueillie lors de l'entretien â€” elle ne peut pas Ãªtre modifiÃ©e par le recruteur.</p>
          </div>
        )}

        {/* Rappel d'origine */}
        {adherent.rdv_date && (
          <div style={{background:"#fffbeb",borderRadius:12,padding:"12px 16px",marginBottom:20,border:"1px solid #fde68a",display:"flex",gap:10,alignItems:"flex-start"}}>
            <span style={{fontSize:18}}>ğŸ“…</span>
            <div>
              <p style={{fontSize:12,fontWeight:700,color:"#92400e",marginBottom:2}}>Rappel d'origine</p>
              <p style={{fontSize:12,color:"#78350f"}}>{new Date(adherent.rdv_date).toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long",year:"numeric"})} Ã  {new Date(adherent.rdv_date).toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}</p>
              {adherent.rdv_note && <p style={{fontSize:11,color:"#d97706",marginTop:2,fontStyle:"italic"}}>"{adherent.rdv_note}"</p>}
            </div>
          </div>
        )}

        {/* SÃ©parateur */}
        <div style={{borderTop:"2px dashed #e5e7eb",margin:"4px 0 20px",position:"relative"}}>
          <span style={{position:"absolute",top:-11,left:"50%",transform:"translateX(-50%)",background:"#fafaf9",padding:"0 12px",fontSize:11,color:"#9ca3af",fontWeight:700,textTransform:"uppercase",letterSpacing:".08em"}}>RIB Ã  complÃ©ter</span>
        </div>

        {/* IBAN */}
        <div style={{marginBottom:16}}>
          <label style={lbl}>IBAN *</label>
          <div style={{position:"relative"}}>
            <input value={iban} onChange={e=>updateIban(e.target.value)} placeholder="FR76 3000 6000 0112 3456 7890 189" style={{...inputS(!!error&&!iban,ibanValid===true),fontFamily:"monospace",letterSpacing:".06em",paddingRight:48}}/>
            {ibanValid!==null && <div style={{position:"absolute",right:14,top:"50%",transform:"translateY(-50%)",width:24,height:24,borderRadius:"50%",display:"flex",alignItems:"center",justifyContent:"center",background:ibanValid?"#dcfce7":"#fee2e2",fontSize:12,fontWeight:700,color:ibanValid?"#16a34a":"#ef4444"}}>{ibanValid?"âœ“":"âœ—"}</div>}
          </div>
          {ibanValid===true  && <p style={{color:"#16a34a",fontSize:12,marginTop:6,fontWeight:600}}>IBAN valide âœ“</p>}
          {ibanValid===false && <p style={{color:"#ef4444",fontSize:12,marginTop:6}}>IBAN invalide â€” vÃ©rifiez les chiffres</p>}
        </div>

        <div style={{marginBottom:20}}>
          <label style={lbl}>BIC / SWIFT</label>
          <input value={bic} onChange={e=>{setBic(e.target.value);setError(null);}} placeholder="BNPAFRPP" style={{...inputS(false,false),fontFamily:"monospace",letterSpacing:".06em"}}/>
        </div>

        {error && <div style={{background:"#fef2f2",border:"1px solid #fecaca",borderRadius:10,padding:"12px 16px",marginBottom:12,color:"#991b1b",fontSize:13}}>âš ï¸ {error}</div>}

        <div style={{display:"flex",gap:10}}>
          <button onClick={onCancel} style={{flex:1,padding:"14px",borderRadius:14,border:"2px solid #e5e7eb",background:"white",color:"#374151",fontSize:14,fontWeight:600,cursor:"pointer",fontFamily:font}}>â† Retour</button>
          <button onClick={handleSubmit} disabled={submitting} style={{flex:2,padding:"14px",borderRadius:14,border:"none",background:submitting?"#9ca3af":"linear-gradient(135deg,#1e1b4b,#6d28d9)",color:"white",fontSize:14,fontWeight:700,cursor:submitting?"not-allowed":"pointer",fontFamily:font,boxShadow:"0 6px 24px rgba(76,29,149,.4)"}}>
            {submitting ? "Enregistrementâ€¦" : "Valider le RIB â€” Finaliser l'adhÃ©sion âœ“"}
          </button>
        </div>
      </div>
    );
  }

  // â”€â”€ STATS PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function StatsPanel({ stats }) {
    if (!stats) return (
      <div style={{textAlign:"center",padding:40,color:"rgba(255,255,255,0.3)",fontSize:14}} className="loading-dot">
        Chargement des statistiquesâ€¦
      </div>
    );
    const items = [
      { label:"AdhÃ©rents trouvÃ©s",  value:stats.total,                                          unit:"",   color:"#a78bfa", icon:"ğŸ‘¥" },
      { label:"Ã‚ge moyen",          value:stats.avgAge!==null?stats.avgAge.toFixed(1):"â€”",      unit:"ans",color:"#60a5fa", icon:"ğŸ‚" },
      { label:"Ã‚ge mÃ©dian",         value:stats.medianAge!==null?stats.medianAge.toFixed(0):"â€”",unit:"ans",color:"#818cf8", icon:"ğŸ“Š" },
      { label:"Don moyen mensuel",  value:stats.avgDon!==null?stats.avgDon.toFixed(2):"â€”",      unit:"â‚¬",  color:"#34d399", icon:"ğŸ’¸" },
      { label:"AdhÃ©rents / heure",  value:stats.perHour.toFixed(2),                             unit:"/ h",color:"#fb923c", icon:"â±ï¸" },
    ];
    return (
      <div style={{display:"grid",gridTemplateColumns:"repeat(3,1fr)",gap:16}}>
        {items.map(it => (
          <div key={it.label} className="card fade-in" style={{textAlign:"center"}}>
            <div style={{fontSize:26,marginBottom:10}}>{it.icon}</div>
            <div className="stat-value" style={{color:it.color}}>
              {it.value}<span style={{fontSize:16,fontWeight:300,color:"rgba(255,255,255,0.4)",marginLeft:4}}>{it.unit}</span>
            </div>
            <div className="stat-label">{it.label}</div>
          </div>
        ))}
        <div className="card fade-in" style={{gridColumn:"1/-1",background:"rgba(251,146,60,.08)",borderColor:"rgba(251,146,60,.2)"}}>
          <p style={{fontSize:11,fontWeight:700,color:"rgba(251,146,60,.7)",letterSpacing:".08em",textTransform:"uppercase",marginBottom:8}}>Base de calcul</p>
          <p style={{fontSize:13,color:"rgba(255,255,255,0.5)",lineHeight:1.7}}>
            Le ratio <strong style={{color:"rgba(255,255,255,0.8)"}}>adhÃ©rents / heure</strong> est calculÃ© sur une journÃ©e de terrain de <strong style={{color:"rgba(255,255,255,0.8)"}}>6 heures effectives</strong>. Avec {stats.total} adhÃ©rent{stats.total>1?"s":""}, cela reprÃ©sente <strong style={{color:"#fb923c"}}>{stats.perHour.toFixed(2)} adhÃ©rent(s)/heure</strong>.
          </p>
        </div>
      </div>
    );
  }

  // â”€â”€ APP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  function App() {
    const [currentUser, setCurrentUser] = useState(() => {
      try { return JSON.parse(sessionStorage.getItem("collecteur")); } catch { return null; }
    });
    const [page, setPage]             = useState("dashboard");
    const [stats, setStats]           = useState(null);
    const [statsError, setStatsError] = useState(null);
    const [rappels, setRappels]       = useState([]);
    const [rappelSelected, setRappelSelected] = useState(null);

    useEffect(() => { if (currentUser) loadStats(); }, [currentUser]);

    async function loadStats() {
      try {
        const rows = await supabaseFetch("adherents", `&collecteur_id=eq.${currentUser.id}`);
        // SÃ©parer adhÃ©rents complets et dossiers incomplets
        const incomplets = rows.filter(r => r.incomplet === true);
        const adherents  = rows.filter(r => !r.incomplet);
        const total = adherents.length;
        const ages = adherents.map(r => calcAge(r.date_naissance)).filter(a => a!==null && a>0 && a<120);
        const avgAge = ages.length>0 ? ages.reduce((s,a)=>s+a,0)/ages.length : null;
        const sorted = [...ages].sort((a,b)=>a-b);
        const medianAge = sorted.length>0
          ? (sorted.length%2===0
              ? (sorted[sorted.length/2-1]+sorted[sorted.length/2])/2
              : sorted[Math.floor(sorted.length/2)])
          : null;
        const dons = adherents.map(r=>parseFloat(r.montant_don)).filter(d=>!isNaN(d)&&d>0);
        const avgDon = dons.length>0 ? dons.reduce((s,d)=>s+d,0)/dons.length : null;
        const perHour = total / 6;
        setStats({ total, avgAge, medianAge, avgDon, perHour });
        setRappels(incomplets);
      } catch(e) { setStatsError(e.message); }
    }

    function handleLogout() {
      sessionStorage.removeItem("collecteur");
      setCurrentUser(null);
      setStats(null);
    }

    if (!currentUser) return <LoginScreen onLogin={user => setCurrentUser(user)} />;

    return (
      <div style={{minHeight:"100vh",display:"flex",flexDirection:"column"}}>
        {/* HEADER */}
        <header style={{background:"rgba(255,255,255,0.03)",borderBottom:"1px solid rgba(255,255,255,0.07)",padding:"0 32px",height:64,display:"flex",alignItems:"center",justifyContent:"space-between",position:"sticky",top:0,zIndex:100,backdropFilter:"blur(12px)"}}>
          <div style={{display:"flex",alignItems:"center",gap:28}}>
            <span style={{fontFamily:serif,fontSize:20,color:"white",fontWeight:600}}>Espace Collecteur</span>
            <nav style={{display:"flex",gap:4}}>
              {[
                {key:"dashboard",label:"Accueil",icon:"ğŸ "},
                {key:"don",label:"Nouvelle fiche",icon:"ğŸ“‹"},
                {key:"rappels",label:"Rappels",icon:"ğŸ“",badge:rappels.length},
              ].map(n => (
                <button key={n.key} onClick={()=>{setPage(n.key);setRappelSelected(null);}} className={`nav-link${page===n.key?" active":""}`} style={{background:page===n.key?"rgba(124,58,237,.2)":undefined,position:"relative"}}>
                  {n.icon} {n.label}
                  {n.badge > 0 && <span style={{position:"absolute",top:2,right:2,width:16,height:16,borderRadius:"50%",background:"#ef4444",color:"white",fontSize:9,fontWeight:700,display:"flex",alignItems:"center",justifyContent:"center",lineHeight:1}}>{n.badge}</span>}
                </button>
              ))}
            </nav>
          </div>
          <div style={{display:"flex",alignItems:"center",gap:10}}>
            <span className="badge badge-purple">ğŸ‘¤ {currentUser.prenom} {currentUser.nom}</span>
            <a href="register.html" className="btn-ghost">CrÃ©er un compte</a>
            <button onClick={handleLogout} style={{fontSize:13,padding:"8px 14px",borderRadius:10,border:"1px solid rgba(239,68,68,.3)",background:"rgba(239,68,68,.08)",color:"#f87171",fontFamily:font,fontWeight:600,cursor:"pointer"}}>DÃ©connexion</button>
          </div>
        </header>

        {/* MAIN */}
        <main style={{flex:1,maxWidth:1100,margin:"0 auto",width:"100%",padding:"36px 24px"}}>

          {page==="dashboard" && (
            <div className="fade-in">
              <div style={{marginBottom:36}}>
                <h1 style={{fontFamily:serif,fontSize:40,color:"white",fontWeight:600,marginBottom:8}}>Bonjour, {currentUser.prenom} ğŸ‘‹</h1>
                <p style={{color:"rgba(255,255,255,0.5)",fontSize:15}}>Voici un aperÃ§u de votre activitÃ© de collecte.</p>
              </div>

              <div style={{display:"grid",gridTemplateColumns:"1fr",gap:16,marginBottom:36,maxWidth:480}}>
                <button onClick={()=>setPage("don")} style={{background:"linear-gradient(135deg,#1e1b4b,#4c1d95,#6d28d9)",border:"none",borderRadius:20,padding:"32px 24px",cursor:"pointer",textAlign:"left",color:"white",fontFamily:font,transition:"transform .2s",boxShadow:"0 8px 32px rgba(76,29,149,.35)"}} onMouseEnter={e=>e.currentTarget.style.transform="translateY(-3px)"} onMouseLeave={e=>e.currentTarget.style.transform=""}>
                  <div style={{fontSize:32,marginBottom:14}}>ğŸ“‹</div>
                  <h3 style={{fontSize:18,fontWeight:700,marginBottom:6}}>Nouvelle fiche de don</h3>
                  <p style={{fontSize:13,color:"rgba(255,255,255,0.6)",lineHeight:1.5}}>Enregistrer un nouvel adhÃ©rent avec coordonnÃ©es, RGPD, don et signature.</p>
                </button>
                {rappels.length > 0 && (
                  <button onClick={()=>setPage("rappels")} style={{background:"rgba(251,146,60,.08)",border:"1px solid rgba(251,146,60,.3)",borderRadius:20,padding:"24px",cursor:"pointer",textAlign:"left",color:"white",fontFamily:font,transition:"all .2s",display:"flex",alignItems:"center",gap:16}} onMouseEnter={e=>{e.currentTarget.style.background="rgba(251,146,60,.15)";}} onMouseLeave={e=>{e.currentTarget.style.background="rgba(251,146,60,.08)";}}>
                    <div style={{width:44,height:44,borderRadius:12,background:"rgba(251,146,60,.15)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0}}>ğŸ“</div>
                    <div>
                      <h3 style={{fontSize:16,fontWeight:700,marginBottom:4,color:"#fb923c"}}>{rappels.length} dossier{rappels.length>1?"s":""} Ã  rappeler</h3>
                      <p style={{fontSize:12,color:"rgba(255,255,255,0.45)"}}>Des adhÃ©rents attendent leur RIB â€” cliquez pour finaliser</p>
                    </div>
                    <span style={{marginLeft:"auto",fontSize:18,color:"rgba(251,146,60,.6)"}}>â†’</span>
                  </button>
                )}
              </div>

              {statsError && <div style={{background:"rgba(239,68,68,.15)",border:"1px solid rgba(239,68,68,.3)",borderRadius:12,padding:"14px 18px",color:"#f87171",fontSize:13,marginBottom:20}}>{statsError}</div>}
              <div>
                <div style={{display:"flex",justifyContent:"space-between",alignItems:"center",marginBottom:20}}>
                  <h2 style={{fontFamily:serif,fontSize:24,color:"white"}}>Mes statistiques</h2>
                  <button onClick={loadStats} style={{fontSize:12,color:"rgba(255,255,255,0.4)",background:"none",border:"none",cursor:"pointer",fontFamily:font}}>ğŸ”„ Actualiser</button>
                </div>
                <StatsPanel stats={stats}/>
              </div>
            </div>
          )}

          {/* ADMIN FLOATING BUTTON */}
          <a href="admin.html" title="Espace Admin" style={{position:"fixed",right:0,top:"50%",transform:"translateY(-50%)",writingMode:"vertical-rl",textOrientation:"mixed",background:"rgba(15,14,26,0.85)",border:"1px solid rgba(124,58,237,.25)",borderRight:"none",borderRadius:"10px 0 0 10px",padding:"14px 8px",color:"rgba(255,255,255,0.25)",fontSize:11,fontFamily:font,fontWeight:600,textDecoration:"none",letterSpacing:".1em",backdropFilter:"blur(8px)",transition:"all .2s",zIndex:200}} onMouseEnter={e=>{e.currentTarget.style.color="rgba(167,139,250,0.8)";e.currentTarget.style.borderColor="rgba(124,58,237,.5)";e.currentTarget.style.background="rgba(124,58,237,.12)";}} onMouseLeave={e=>{e.currentTarget.style.color="rgba(255,255,255,0.25)";e.currentTarget.style.borderColor="rgba(124,58,237,.25)";e.currentTarget.style.background="rgba(15,14,26,0.85)";}}>âš™ ADMIN</a>

          {page==="don" && (
            <div className="fade-in">
              <div style={{marginBottom:28}}>
                <button onClick={()=>setPage("dashboard")} style={{background:"none",border:"none",color:"rgba(255,255,255,0.4)",cursor:"pointer",fontFamily:font,fontSize:13,padding:0,marginBottom:16}}>â† Retour</button>
                <h1 style={{fontFamily:serif,fontSize:36,color:"white",fontWeight:600,marginBottom:6}}>Nouvelle fiche de don</h1>
                <p style={{color:"rgba(255,255,255,0.5)",fontSize:14}}>Remplissez chaque Ã©tape pour enregistrer l'adhÃ©rent</p>
              </div>
              <div style={{background:"#fafaf9",borderRadius:24,padding:"36px 40px",maxWidth:720,boxShadow:"0 24px 64px rgba(0,0,0,0.3)"}}>
                <DonationPanel currentUser={currentUser} onSuccess={()=>{ loadStats(); setPage("dashboard"); }}/>
              </div>
            </div>
          )}

          {page==="rappels" && (
            <div className="fade-in">
              {rappelSelected ? (
                /* â”€â”€ VUE FICHE INDIVIDUELLE â”€â”€ */
                <div>
                  <div style={{marginBottom:28}}>
                    <button onClick={()=>setRappelSelected(null)} style={{background:"none",border:"none",color:"rgba(255,255,255,0.4)",cursor:"pointer",fontFamily:font,fontSize:13,padding:0,marginBottom:16}}>â† Retour aux rappels</button>
                    <h1 style={{fontFamily:serif,fontSize:36,color:"white",fontWeight:600,marginBottom:6}}>Finaliser le dossier</h1>
                    <p style={{color:"rgba(255,255,255,0.5)",fontSize:14}}>ComplÃ©tez le RIB manquant pour valider l'adhÃ©sion de {rappelSelected.prenom} {rappelSelected.nom}</p>
                  </div>
                  <div style={{background:"#fafaf9",borderRadius:24,padding:"36px 40px",maxWidth:720,boxShadow:"0 24px 64px rgba(0,0,0,0.3)"}}>
                    <CompletionPanel
                      adherent={rappelSelected}
                      onSuccess={()=>{ loadStats(); setRappelSelected(null); }}
                      onCancel={()=>setRappelSelected(null)}
                    />
                  </div>
                </div>
              ) : (
                /* â”€â”€ LISTE DES RAPPELS â”€â”€ */
                <div>
                  <div style={{marginBottom:32}}>
                    <h1 style={{fontFamily:serif,fontSize:40,color:"white",fontWeight:600,marginBottom:8}}>ğŸ“ Dossiers Ã  rappeler</h1>
                    <p style={{color:"rgba(255,255,255,0.5)",fontSize:15}}>
                      {rappels.length === 0 ? "Aucun dossier incomplet â€” tout est Ã  jour !" : `${rappels.length} dossier${rappels.length>1?"s":""} en attente de RIB`}
                    </p>
                  </div>

                  {rappels.length === 0 ? (
                    <div className="card" style={{textAlign:"center",padding:"60px 40px"}}>
                      <div style={{fontSize:52,marginBottom:16}}>âœ…</div>
                      <h3 style={{fontFamily:serif,fontSize:24,color:"white",marginBottom:8}}>Tout est Ã  jour !</h3>
                      <p style={{color:"rgba(255,255,255,0.4)",fontSize:14}}>Aucun adhÃ©rent en attente de RIB.</p>
                    </div>
                  ) : (
                    <div style={{display:"flex",flexDirection:"column",gap:12}}>
                      {rappels
                        .slice()
                        .sort((a,b) => {
                          // En retard d'abord, puis par date
                          const now = new Date();
                          const aUrgent = a.rdv_date && new Date(a.rdv_date) <= now;
                          const bUrgent = b.rdv_date && new Date(b.rdv_date) <= now;
                          if (aUrgent && !bUrgent) return -1;
                          if (!aUrgent && bUrgent) return 1;
                          if (a.rdv_date && b.rdv_date) return new Date(a.rdv_date) - new Date(b.rdv_date);
                          if (a.rdv_date) return -1;
                          if (b.rdv_date) return 1;
                          return 0;
                        })
                        .map(r => {
                          const rdvDate = r.rdv_date ? new Date(r.rdv_date) : null;
                          const isUrgent = rdvDate && rdvDate <= new Date();
                          return (
                            <div key={r.id} style={{background:isUrgent?"rgba(239,68,68,.06)":"rgba(255,255,255,0.03)",border:`1px solid ${isUrgent?"rgba(239,68,68,.25)":"rgba(251,146,60,.2)"}`,borderRadius:16,padding:"20px 24px",display:"flex",alignItems:"center",gap:16,transition:"border-color .2s"}}>
                              {/* Indicateur urgence */}
                              <div style={{width:44,height:44,borderRadius:12,background:isUrgent?"rgba(239,68,68,.15)":"rgba(251,146,60,.1)",display:"flex",alignItems:"center",justifyContent:"center",fontSize:22,flexShrink:0}}>
                                {isUrgent ? "ğŸ”´" : "ğŸ“…"}
                              </div>

                              {/* IdentitÃ© + infos */}
                              <div style={{flex:1,minWidth:0}}>
                                <div style={{display:"flex",alignItems:"center",gap:8,marginBottom:4}}>
                                  <p style={{fontWeight:700,color:"white",fontSize:15}}>{r.prenom} {r.nom}</p>
                                  {isUrgent && <span style={{fontSize:10,padding:"2px 8px",borderRadius:20,background:"rgba(239,68,68,.2)",color:"#f87171",fontWeight:700}}>EN RETARD</span>}
                                </div>
                                <p style={{fontSize:12,color:"rgba(255,255,255,0.45)",marginBottom:4}}>
                                  ğŸ“ {r.telephone || "â€”"} &nbsp;Â·&nbsp; ğŸ“§ {r.email || "â€”"}
                                  {r.ville && <span> &nbsp;Â·&nbsp; ğŸ“ {r.ville}</span>}
                                </p>
                                {rdvDate && (
                                  <p style={{fontSize:12,fontWeight:600,color:isUrgent?"#f87171":"#fb923c"}}>
                                    ğŸ—“ {rdvDate.toLocaleDateString("fr-FR",{weekday:"long",day:"2-digit",month:"long"})} Ã  {rdvDate.toLocaleTimeString("fr-FR",{hour:"2-digit",minute:"2-digit"})}
                                  </p>
                                )}
                                {r.rdv_note && <p style={{fontSize:11,color:"rgba(255,255,255,0.3)",marginTop:2,fontStyle:"italic"}}>"{r.rdv_note}"</p>}
                              </div>

                              {/* Don + action */}
                              <div style={{textAlign:"right",flexShrink:0,display:"flex",flexDirection:"column",alignItems:"flex-end",gap:8}}>
                                {r.montant_don && (
                                  <div>
                                    <p style={{fontSize:16,fontWeight:700,color:"#34d399"}}>{parseFloat(r.montant_don).toFixed(2)} â‚¬<span style={{fontSize:11,color:"rgba(255,255,255,0.35)",fontWeight:400}}>/mois</span></p>
                                  </div>
                                )}
                                <button
                                  onClick={()=>setRappelSelected(r)}
                                  style={{padding:"10px 20px",borderRadius:12,border:"none",background:"linear-gradient(135deg,#4c1d95,#6d28d9)",color:"white",fontSize:13,fontWeight:700,cursor:"pointer",fontFamily:font,boxShadow:"0 4px 16px rgba(76,29,149,.35)",whiteSpace:"nowrap"}}
                                >
                                  ğŸ“ Finaliser le dossier
                                </button>
                              </div>
                            </div>
                          );
                        })}
                    </div>
                  )}
                </div>
              )}
            </div>
          )}
        </main>

        {/* FOOTER */}
        <footer style={{borderTop:"1px solid rgba(255,255,255,0.06)",padding:"16px 32px",display:"flex",justifyContent:"space-between",alignItems:"center"}}>
          <span style={{fontSize:12,color:"rgba(255,255,255,0.25)"}}>Espace Collecteur</span>
          <div style={{display:"flex",gap:16}}>
            <a href="register.html" style={{fontSize:12,color:"rgba(255,255,255,0.35)",textDecoration:"none"}}>CrÃ©er un compte</a>
            <a href="admin.html" style={{fontSize:12,color:"rgba(255,255,255,0.35)",textDecoration:"none"}}>Admin</a>
          </div>
        </footer>
      </div>
    );
  }

  ReactDOM.createRoot(document.getElementById("root")).render(<App/>);
</script>
</body>
</html>
